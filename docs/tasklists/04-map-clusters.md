# Phase 4: Map View & Clustering

Geographic visualization and automatic grouping. After this phase: you can see all leads on a Leaflet map with color-coded markers, auto-cluster leads using DBSCAN, view cluster boundaries, and manage clusters.

> **Prerequisites:** Phase 1 + Phase 2 completed (leads with lat/lng in database)

## Boundaries

- DO NOT add "draw region" tool for manual cluster creation — save for a future iteration
- DO NOT add route planning or directions
- DO NOT install heavy GIS libraries — keep it simple with Leaflet + math

## Tasks

### Map Page

- [ ] Install Leaflet dependencies: `pnpm add leaflet react-leaflet` and `pnpm add -D @types/leaflet`
- [ ] Create map wrapper component at `src/components/map/lead-map.tsx` — dynamically imported (no SSR) Leaflet MapContainer. Default center on Niagara region (43.08, -79.08), zoom level 8. Use OpenStreetMap tiles. Include Leaflet CSS import.
- [ ] Create Convex query `convex/leads.ts:listWithCoords` — return all leads that have both `latitude` and `longitude` populated. Return only fields needed for map: `_id`, `name`, `type`, `city`, `status`, `latitude`, `longitude`, `clusterId`.
- [ ] Create map page at `src/app/map/page.tsx` — replace placeholder. Render the map full-height (calc 100vh minus topbar). Fetch leads with coords and render as markers.
- [ ] Create color-coded markers — define a color per pipeline status: `new_lead` = gray, `enriched` = blue, `outreach_started` = amber, `replied` = green, `meeting_booked` = purple, `onboarded` = emerald, `no_email` = orange, `declined`/`not_interested` = red, `bounced`/`no_response` = slate. Use Leaflet CircleMarker or custom DivIcon with these colors.
- [ ] Create marker popup component at `src/components/map/marker-popup.tsx` — on marker click, show a popup with: lead name, type badge, city, status badge, contact email (if exists), and a "View Detail" link to `/leads/[id]`.
- [ ] Create map filter controls at `src/components/map/map-filters.tsx` — overlay panel on the map with filters: Status multi-select, Type multi-select, Cluster dropdown. Filters are applied client-side to the loaded leads array.

### Clusters

- [ ] Create Convex query `convex/clusters.ts:list` — return all clusters with fields: `_id`, `name`, `centerLat`, `centerLng`, `radiusKm`, `leadCount`, `isAutoGenerated`.
- [ ] Create clusters page at `src/app/clusters/page.tsx` — replace placeholder. Two-column layout: left side is cluster list (cards with name, lead count, radius), right side is either a cluster detail view or an instruction to select a cluster. Include "Auto-generate Clusters" button at top.
- [ ] Implement DBSCAN clustering in `convex/lib/dbscan.ts` — pure TypeScript DBSCAN implementation. Input: array of `{ id, lat, lng }`. Parameters: `eps` = 15km (using Haversine distance), `minPoints` = 3. Output: array of clusters, each with member point IDs. Include Haversine distance function. Name each cluster by most frequent city among its members.
- [ ] Create Convex action `convex/clusters.ts:autoGenerate` — runs DBSCAN on all leads with coordinates. For each resulting cluster: calculate center (average lat/lng of members), calculate radius (max distance from center to any member), create/update cluster record, assign `clusterId` on all member leads, set `isAutoGenerated: true`. Leads not in any cluster get `clusterId: undefined`. Update `leadCount` on each cluster. Log activity on each lead that gets assigned.
- [ ] Add cluster boundaries to map — render each cluster as a Leaflet Circle with center at `centerLat`/`centerLng` and radius `radiusKm * 1000` meters. Semi-transparent fill, color matching the cluster. Show cluster name as a tooltip.
- [ ] Create cluster detail view component at `src/components/clusters/cluster-detail.tsx` — shows when a cluster is selected. Displays: cluster name (editable), radius, lead count, a small Leaflet map zoomed to the cluster, and a table of leads in the cluster (name, status, email). Click lead name to navigate to `/leads/[id]`.
- [ ] Create Convex mutation `convex/clusters.ts:update` — update cluster name and/or radiusKm.
- [ ] Create Convex query `convex/leads.ts:listByCluster` — return all leads with a given `clusterId`.

## Validation

- [ ] Map page renders a Leaflet map with markers for all geocoded leads
- [ ] Markers are color-coded by pipeline status
- [ ] Clicking a marker shows popup with lead name, type, city, status, and "View Detail" link
- [ ] "View Detail" link in popup navigates to the correct lead detail page
- [ ] Map filters narrow visible markers (e.g., filtering to "enriched" status hides other markers)
- [ ] "Auto-generate Clusters" button creates clusters and assigns leads
- [ ] Cluster boundaries appear as circles on the map
- [ ] Clusters page shows list of generated clusters with correct lead counts
- [ ] Selecting a cluster shows its detail view with mini-map and lead table
- [ ] Editing a cluster name saves to Convex
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
