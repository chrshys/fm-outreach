# Phase 12: Draw-to-Create Polygon Clusters

Replace DBSCAN auto-clustering with user-drawn polygon clusters on the `/map` page. After this phase: users can draw a polygon on the map to define a cluster boundary, name it, see how many leads fall inside, and manage polygon clusters from the clusters page. All existing circle-based cluster rendering and DBSCAN code is removed.

> **Prerequisites:** Phase 4 completed (map page with Leaflet, existing cluster infrastructure)

## Boundaries

- DO NOT add polygon vertex editing — delete and redraw instead
- DO NOT use `react-leaflet-draw` — use `leaflet-draw` directly via `useMap()` hook (React 19 compat issues)
- DO NOT add external GIS libraries for point-in-polygon — use simple ray-casting (~15 lines)
- DO NOT preserve existing cluster data — all old clusters are deleted in migration

## Tasks

### Dependencies & Schema

- [x] Install leaflet-draw dependencies: `pnpm add leaflet-draw` and `pnpm add -D @types/leaflet-draw`
- [x] Update cluster schema in `convex/schema.ts` — replace circle fields with polygon boundary. New shape: `name: v.string()`, `boundary: v.array(v.object({ lat: v.number(), lng: v.number() }))`, `centerLat: v.number()`, `centerLng: v.number()`, `radiusKm: v.number()`, `leadCount: v.number()`, `isAutoGenerated: v.boolean()`. The `boundary` field stores the polygon vertices. `centerLat`/`centerLng` are computed from polygon centroid. `radiusKm` is the bounding radius for zoom fitting.
- [x] Create a Convex migration script or inline cleanup: delete all existing cluster records and clear `clusterId` from all leads. This can be a one-time mutation in `convex/clusters.ts` called `deleteAllClusters` — deletes every cluster doc and patches every lead to remove `clusterId`. Run it once after deploy.

### Point-in-Polygon Utilities

- [x] Create server-side point-in-polygon utility at `convex/lib/pointInPolygon.ts` — export two functions: (1) `pointInPolygon(point: {lat, lng}, polygon: {lat, lng}[]): boolean` using ray-casting algorithm, and (2) `polygonCentroid(polygon: {lat, lng}[]): {lat: number, lng: number}` that computes the geometric centroid. Also export `boundingRadius(center: {lat, lng}, polygon: {lat, lng}[]): number` that returns the max Haversine distance in km from center to any vertex.
- [x] Create client-side point-in-polygon utility at `src/lib/point-in-polygon.ts` — export the same `pointInPolygon` function for client-side preview count of leads inside a drawn polygon. Can share the same ray-casting logic.

### Backend Mutations & Queries

- [x] Rewrite `convex/clusters.ts` — remove the `autoGenerate` action and all DBSCAN-related imports/code. Add new mutation `createPolygonCluster` that takes `{ name: string, boundary: {lat, lng}[] }`, computes centroid and bounding radius, queries all leads with coordinates, runs point-in-polygon to find enclosed leads, creates the cluster doc with `isAutoGenerated: false`, patches all enclosed leads with the new `clusterId`, and sets `leadCount`. Log activity on each assigned lead.
- [x] Add `deleteCluster` mutation to `convex/clusters.ts` — takes `clusterId`, queries all leads assigned to this cluster, patches each to remove `clusterId`, logs activity on each unassigned lead, then deletes the cluster doc.
- [x] Delete `convex/lib/dbscan.ts` — no longer needed.
- [x] Update the existing `convex/clusters.ts:list` query — ensure it returns the `boundary` field alongside existing fields.

### Map Page — Drawing UI

- [x] Create polygon draw component at `src/components/map/polygon-draw.tsx` — uses `useMap()` hook from react-leaflet to access the Leaflet map instance. When `isDrawing` prop is true, adds a Leaflet.draw polygon handler. On polygon complete, calls `onPolygonDrawn(latlngs: {lat, lng}[])` callback with the polygon vertices, then removes the draw handler. When `isDrawing` becomes false, cancels any in-progress drawing. Import `leaflet-draw` CSS.
- [x] Update `src/app/map/page.tsx` — add state: `isDrawing`, `drawnPolygon`, `showNamingDialog`. Add a "Draw Cluster" button in the top-right control area. When clicked, sets `isDrawing: true`. When polygon is drawn, sets `drawnPolygon` to the vertices, `isDrawing: false`, and `showNamingDialog: true`. Add a naming dialog (Dialog component) that shows: text input for cluster name, preview count of leads inside the polygon (computed client-side using point-in-polygon against loaded leads), Cancel and Create buttons. Create button calls the `createPolygonCluster` mutation, then closes the dialog and resets state.
- [x] Update `src/components/map/map-content.tsx` — replace cluster `Circle` rendering with `Polygon` rendering. For each cluster with a `boundary` field, render a Leaflet `Polygon` using the boundary coordinates. Semi-transparent fill, cluster name as tooltip. Also integrate the `PolygonDraw` component, passing `isDrawing` and `onPolygonDrawn` props from the parent.

### Clusters Page Updates

- [x] Update `src/components/clusters/cluster-map.tsx` — replace circle rendering with polygon rendering. For each cluster, render a Leaflet `Polygon` from `cluster.boundary` instead of a `Circle` from center + radius.
- [x] Update `src/app/clusters/page.tsx` — remove the "Auto-generate Clusters" button and its click handler. Add a "Delete" button on each cluster card that calls the `deleteCluster` mutation with confirmation. Update any type references to include the `boundary` field.

### Typecheck & Lint

- [x] Run `pnpm typecheck` and fix any TypeScript errors across all modified files. Ensure `boundary` field typing is consistent between schema, queries, and components.
- [x] Run `pnpm lint` and fix any lint errors.

## Validation

- [x] Draw a polygon on the map page around a group of leads (e.g., Niagara-on-the-Lake area)
- [x] Naming dialog shows correct preview count of enclosed leads
- [x] Cluster appears on map as a polygon shape immediately after creation
- [x] Leads assigned to the cluster show the `clusterId` on their records
- [x] Clusters page lists the new polygon cluster with correct lead count
- [x] Cluster detail map renders the polygon boundary (not a circle)
- [x] Deleting a cluster removes it from the list and unassigns its leads
- [x] No "Auto-generate Clusters" button exists anywhere
- [x] `pnpm typecheck` passes
- [x] `pnpm lint` passes
