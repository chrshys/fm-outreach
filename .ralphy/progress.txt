# Ralphy Progress Log

## Current State (2026-02-05)

Foundation work is complete. See `docs/26-02-05-fruitland-market-ui-tasklist.md` for remaining work.

**Done:**
- Design system (tokens, typography, tailwind config)
- App shell (header, nav, footer structure)
- Core UI components
- Empty state patterns

**Remaining (prioritized):**
1. ðŸ”´ Site Footer - navigation links, legal, branding
2. ðŸ”´ Marketing Home Page - hero, how it works, featured listings
3. ðŸ”´ Listing Detail Page - gallery, seller info, reserve action
4. ðŸŸ¡ Badge + Avatar components
5. ðŸŸ¡ Page metadata (titles, descriptions, OG tags)
6. ðŸŸ¢ Additional marketing pages (about, FAQ, contact)

---

## Session History

### 2026-02-04 (Theme + Tokens)
- [âœ“] Created shadcn-ui.css with Voicekit variables
- [âœ“] Created theme.utilities.css with container utility
- [âœ“] Updated globals.css with theme imports and utilities
- [âœ“] Updated tailwind.config.ts with CSS variable mappings
- [âœ“] Added theme-toggle.tsx component
- [âœ“] Updated app layout with footer bar

### 2026-02-05 (UI Foundation via ralphy --codex)
- Ran automated task runner, hit credit limit
- Worktrees created but work was incomplete
- Deleted worktrees, kept main repo uncommitted changes
- Audited codebase to verify actual completion status
- Reorganized task list by priority
- [âœ“] 2026-02-05 14:26 - Navigation links (Discover, About, Help)
- [âœ“] 2026-02-05 14:30 - Legal links (Terms, Privacy)
- [âœ“] 2026-02-05 14:34 - Copyright and branding
- [âœ“] 2026-02-05 14:39 - Hero section with value prop and CTA
- [âœ“] 2026-02-05 14:45 - "How it works" section (3-step)
- [âœ“] 2026-02-05 14:50 - Featured listings preview
- [âœ“] 2026-02-05 14:53 - Seller CTA section
- [âœ“] 2026-02-05 15:02 - Photo gallery with thumbnails
- [âœ“] 2026-02-05 15:05 - Title, price, availability badge
- [âœ“] 2026-02-05 15:08 - Seller card with follow button
- [âœ“] 2026-02-05 15:16 - Pickup location display
- [âœ“] 2026-02-05 15:19 - Reserve action area
- [âœ“] 2026-02-05 15:21 - Badge component (status, category pills)
- [âœ“] 2026-02-05 15:24 - Avatar component (image + initials, size variants)
- [âœ“] 2026-02-05 15:30 - Skeleton loaders (feed, listing, profile)
- [âœ“] 2026-02-05 15:42 - Title tags for all routes
- [âœ“] 2026-02-05 15:44 - Meta descriptions
- [âœ“] 2026-02-05 15:51 - Open Graph tags
- [âœ“] 2026-02-05 15:54 - About page
- [âœ“] 2026-02-05 15:58 - FAQ page
- [âœ“] 2026-02-05 16:01 - Contact page
- [âœ“] 2026-02-05 16:25 - Make header sticky with `sticky top-0 z-50`
- [âœ“] 2026-02-05 16:28 - Add glassmorphic styling: `bg-white/85 backdrop-blur-md` (light) / `bg-background/85` (dark)
- [âœ“] 2026-02-05 16:30 - Add logo icon: 36px green square with "F" initial, rounded-lg
- [âœ“] 2026-02-05 16:33 - Add pill-shaped search bar in header (visible on all pages, not just discover)
- [âœ“] 2026-02-05 16:37 - Add location button showing current location name or "Set Location"
- [âœ“] 2026-02-05 16:39 - Header stays fixed when scrolling
- [âœ“] 2026-02-05 16:43 - Content is visible but blurred behind header
- [âœ“] 2026-02-05 16:45 - Logo icon + text both visible
- [âœ“] 2026-02-05 16:46 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 16:46 - `pnpm lint` passes
- [âœ“] 2026-02-05 16:49 - Create CategoryNav component with horizontal scrolling pills
- [âœ“] 2026-02-05 16:52 - Add category data: All, Produce, Eggs & Dairy, Baked Goods, Plants, Handmade, Preserves, Wellness
- [âœ“] 2026-02-05 16:53 - Style pills: `rounded-full px-4 py-2.5 text-sm font-medium`
- [âœ“] 2026-02-05 16:54 - Active state: `bg-primary text-primary-foreground`
- [âœ“] 2026-02-05 16:56 - Inactive state: `bg-muted text-muted-foreground hover:bg-muted/80`
- [âœ“] 2026-02-05 16:58 - Add to layout below header with border-b separator
- [âœ“] 2026-02-05 17:03 - Wire to URL query params: `/discover?category=produce` (use `useSearchParams`)
- [âœ“] 2026-02-05 17:06 - Read category from URL on page load, sync to component state
- [âœ“] 2026-02-05 17:08 - Pills scroll horizontally on mobile
- [âœ“] 2026-02-05 17:10 - Active category is visually distinct (green fill)
- [âœ“] 2026-02-05 17:12 - Clicking category updates URL query param
- [âœ“] 2026-02-05 17:15 - Refreshing page with `?category=X` shows correct active pill
- [âœ“] 2026-02-05 17:16 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 17:17 - Change discover page to `grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-8`
- [âœ“] 2026-02-05 17:20 - Create DiscoverSidebar component with sticky positioning (`sticky top-24`)
- [âœ“] 2026-02-05 17:23 - Add "Your Community" card with static mock data (847 neighbors, 156 listings)
- [âœ“] 2026-02-05 17:25 - Add "Trending Now" card with static items (Fresh Tomatoes, Farm Eggs, Homemade Bread, Raw Honey)
- [âœ“] 2026-02-05 17:27 - Add "Nearby Sellers" card with 3 static seller previews + "View All" button
- [âœ“] 2026-02-05 17:28 - Hide sidebar on mobile (< lg breakpoint)
- [âœ“] 2026-02-05 17:32 - Desktop shows feed + sidebar side by side
- [âœ“] 2026-02-05 17:34 - Sidebar sticks when scrolling (respects header height)
- [âœ“] 2026-02-05 17:36 - Mobile shows feed only, no sidebar
- [âœ“] 2026-02-05 17:41 - Static data renders correctly
- [âœ“] 2026-02-05 17:41 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 17:47 - Add card header section with seller avatar, name, distance, and time ago
- [âœ“] 2026-02-05 17:49 - Add three-dot menu button (kebab) in card header right side
- [âœ“] 2026-02-05 17:51 - Move category badge to overlay on image (top-left, semi-transparent white bg)
- [âœ“] 2026-02-05 17:52 - Fix card link to go to `/listings/[id]` not `/@username` (current behavior is a bug)
- [âœ“] 2026-02-05 17:53 - Add subtle hover elevation on card (`hover:shadow-md transition-shadow`)
- [âœ“] 2026-02-05 17:54 - Card header shows avatar (with initials), seller name, "0.5 mi Â· 2h ago"
- [âœ“] 2026-02-05 17:56 - Category badge floats over image with `bg-white/90 backdrop-blur-sm`
- [âœ“] 2026-02-05 18:01 - Clicking card navigates to listing detail page (not seller profile)
- [âœ“] 2026-02-05 18:01 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 18:02 - Add 42px size variant: `md: "h-[42px] w-[42px] text-sm"`
- [âœ“] 2026-02-05 18:03 - Change default background from `bg-muted` to `bg-emerald-50`
- [âœ“] 2026-02-05 18:05 - Add subtle green ring: `ring-2 ring-primary/20 ring-offset-1`
- [âœ“] 2026-02-05 18:05 - Update IMAGE_SIZES to include md: 42
- [âœ“] 2026-02-05 18:07 - Avatar has green-tinted background when showing initials
- [âœ“] 2026-02-05 18:08 - New `md` size renders at 42px
- [âœ“] 2026-02-05 18:10 - Existing avatar usages still work
- [âœ“] 2026-02-05 18:11 - Avatar tests pass: `pnpm test avatar`
- [âœ“] 2026-02-05 18:13 - Replace FeedToggle with pill-shaped tab group
- [âœ“] 2026-02-05 18:18 - Add tabs: Recent, Nearby, Popular (mock style)
- [âœ“] 2026-02-05 18:19 - Style tabs with bg-muted container, white active background
- [âœ“] 2026-02-05 18:23 - Show listing count to the right ("7 listings")
- [âœ“] 2026-02-05 18:24 - Tabs are pill-shaped with rounded container
- [âœ“] 2026-02-05 18:25 - Active tab has white bg and darker text
- [âœ“] 2026-02-05 18:30 - Tab switches update feed sort order
- [âœ“] 2026-02-05 18:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 18:32 - Add `shadow-sm` to all Card components for subtle depth
- [âœ“] 2026-02-05 18:34 - Add `transition-shadow hover:shadow-md` to interactive cards
- [âœ“] 2026-02-05 18:40 - Ensure all interactive elements have visible focus states
- [âœ“] 2026-02-05 18:46 - Add `transition-colors` to all buttons and links
- [âœ“] 2026-02-05 18:55 - Review spacing consistency (use design tokens: gap-2, gap-4, p-4, p-6)
- [âœ“] 2026-02-05 18:58 - Cards have subtle shadow
- [âœ“] 2026-02-05 19:02 - Hover states are visible on all clickable elements
- [âœ“] 2026-02-05 19:06 - Focus rings visible on keyboard navigation
- [âœ“] 2026-02-05 19:07 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 19:07 - `pnpm lint` passes
- [âœ“] 2026-02-05 19:10 - Add navigation links section: Discover, About, Help
- [âœ“] 2026-02-05 19:11 - Add proper spacing between nav and legal sections
- [âœ“] 2026-02-05 19:13 - Ensure footer matches mock typography (text-sm, muted foreground)
- [âœ“] 2026-02-05 19:17 - Add "Fruitland Market" branding text with logo
- [âœ“] 2026-02-05 19:18 - Footer has Discover, About, Help links
- [âœ“] 2026-02-05 19:21 - Footer has Terms, Privacy, theme toggle
- [âœ“] 2026-02-05 19:25 - Footer matches overall site aesthetic
- [âœ“] 2026-02-05 19:27 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 20:31 - Add `getListingsByCategory` query to `packages/backend/convex/discovery.ts`
- [âœ“] 2026-02-05 20:32 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 20:35 - Query is exported and accessible via `api.discovery.getListingsByCategory`
- [âœ“] 2026-02-05 20:38 - Add `getTopSellers` query to `packages/backend/convex/discovery.ts`
- [âœ“] 2026-02-05 20:39 - `pnpm typecheck` passes
- [âœ“] 2026-02-05 20:48 - Add `getListingsByCategory` query to `packages/backend/convex/discovery.ts`
- [âœ“] 2026-02-05 20:50 - Add `getTopSellers` query to `packages/backend/convex/discovery.ts`
- [âœ“] 2026-02-05 20:53 - Export `ListingPreview` and `ListingPreviewSkeleton` from `apps/web/components/featured/FeaturedListings.tsx`
- [âœ“] 2026-02-05 20:56 - Create `apps/web/components/ui/horizontal-scroll.tsx`
- [âœ“] 2026-02-05 20:59 - Create `apps/web/app/(app)/feed/page.tsx` with metadata and FeedPageContent render
- [âœ“] 2026-02-05 21:03 - Create `apps/web/app/(app)/feed/FeedPageContent.tsx` copied from current `discover/DiscoverPageContent.tsx`
- [âœ“] 2026-02-05 21:07 - Create `apps/web/components/discover/SearchSection.tsx`
- [âœ“] 2026-02-05 21:11 - Create `apps/web/components/discover/CategoryBrowseSection.tsx`
- [âœ“] 2026-02-05 21:16 - Create `apps/web/components/discover/FeaturedSection.tsx`
- [âœ“] 2026-02-05 21:20 - Create `apps/web/components/discover/TrendingCarousel.tsx`
- [âœ“] 2026-02-05 21:26 - Create `apps/web/components/discover/CategoryCarousel.tsx`
- [âœ“] 2026-02-05 21:32 - Create `apps/web/components/discover/CategoryCarouselsSection.tsx`
- [âœ“] 2026-02-05 21:38 - Create `apps/web/components/discover/SellerHighlightsSection.tsx`
- [âœ“] 2026-02-05 21:42 - Create `apps/web/components/discover/CompactMap.tsx`
- [âœ“] 2026-02-05 21:50 - Rewrite `apps/web/app/(app)/discover/DiscoverPageContent.tsx` to compose new sections, update `apps/web/app/(app)/discover/page.tsx` metadata (title "Discover", description "Explore local food, sellers, and categories near you"), and simplify `apps/web/app/(app)/discover/layout.tsx` (remove tab nav, just render children) â€” all three files in one pass
- [âœ“] 2026-02-05 21:52 - Delete `apps/web/app/(app)/discover/search/page.tsx`
- [âœ“] 2026-02-05 21:54 - Delete `apps/web/app/(app)/discover/search/SearchPageContent.tsx`
- [âœ“] 2026-02-05 21:55 - Add redirect from `/discover/search` to `/discover` in `apps/web/next.config.js`
- [âœ“] 2026-02-05 21:57 - Update `PRIMARY_NAV_LINKS` in `apps/web/components/layout/app-nav.tsx` â€” add Feed as first item, keep Discover as second
- [âœ“] 2026-02-05 21:59 - Update footer nav in `apps/web/app/(app)/layout.tsx` â€” add Feed link before Discover
- [âœ“] 2026-02-05 22:01 - Update `handleSelectCategory` in `apps/web/components/discovery/CategoryNavWrapper.tsx` to route to `/feed` when not already on feed
- [âœ“] 2026-02-05 22:04 - Update `/discover` â†’ `/feed` in `apps/web/components/hero/HeroSection.tsx` ("Browse Local Goods" CTA), `apps/web/components/featured/FeaturedListings.tsx` (3 places: 2 "View all" links + 1 fallback in ListingPreview), and `apps/web/app/(app)/help/page.tsx` ("Browse listings" link)
- [âœ“] 2026-02-05 22:08 - Update `/discover` â†’ `/feed` in `apps/web/app/(app)/following/FollowingPageContent.tsx` (2 empty state CTAs), `apps/web/app/(app)/reservations/ReservationsPageContent.tsx` (empty state "browse" link), `apps/web/app/(app)/checkout/success/CheckoutSuccessPageContent.tsx` ("Continue browsing" link), and `apps/web/app/(app)/listings/[id]/ListingDetailContent.tsx` (back button link)
- [âœ“] 2026-02-05 22:11 - Rewrite `apps/web/app/(app)/discover/DiscoverPageContent.test.tsx` for new discover hub
- [âœ“] 2026-02-05 22:14 - Update `apps/web/app/(app)/layout.test.tsx` footer assertions
- [âœ“] 2026-02-05 22:16 - Update `apps/web/components/layout/app-nav.test.tsx` nav link assertions
- [âœ“] 2026-02-05 22:19 - Update `apps/web/components/featured/FeaturedListings.test.tsx` link assertions
- [âœ“] 2026-02-06 02:03 - Add `paymentType` to reservations (ONLINE, PAY_AT_PICKUP)
- [âœ“] 2026-02-06 02:07 - Add `holdExpiresAt` to reservations
- [âœ“] 2026-02-06 02:14 - Add statuses `READY` and `EXPIRED`
- [âœ“] 2026-02-06 02:18 - Add server mutation to create pay-at-pickup reservation intent
- [âœ“] 2026-02-06 02:21 - Add expiration cron to mark overdue holds as EXPIRED
- [âœ“] 2026-02-06 02:24 - Update reservation lifecycle logic to allow READY â†’ COMPLETE
- [âœ“] 2026-02-06 02:26 - Creating PAY_AT_PICKUP reservation sets `holdExpiresAt`
- [âœ“] 2026-02-06 02:29 - Expired holds transition to EXPIRED automatically
- [âœ“] 2026-02-06 02:33 - Paid reservations still behave as before
- [âœ“] 2026-02-06 02:36 - Add seller action to mark reservation READY
- [âœ“] 2026-02-06 02:40 - Add buyer action to mark reservation COMPLETE (pickup done)
- [âœ“] 2026-02-06 02:42 - Ensure READY only allowed for paid or pay-at-pickup holds
- [âœ“] 2026-02-06 02:47 - Ensure COMPLETE only allowed after READY
- [âœ“] 2026-02-06 02:50 - READY action updates status and timestamp
- [âœ“] 2026-02-06 02:52 - COMPLETE action updates status and timestamp
- [âœ“] 2026-02-06 02:56 - Invalid transitions are rejected
- [âœ“] 2026-02-06 02:58 - Add `notifications` table with `recipientId`, `type`, `payload`, `readAt`, `createdAt`
- [âœ“] 2026-02-06 03:00 - Add queries: list notifications, list unread count
- [âœ“] 2026-02-06 03:02 - Add mutations: mark read, mark all read
- [âœ“] 2026-02-06 03:06 - Trigger notifications on reservation created, paid, ready, cancelled, expired
- [âœ“] 2026-02-06 03:10 - Add bell icon + unread count in web nav
- [âœ“] 2026-02-06 03:16 - Render notifications list page with real data
- [âœ“] 2026-02-06 03:20 - Add mark-as-read behavior in UI
- [âœ“] 2026-02-06 03:26 - Unread count updates when notifications are read
- [âœ“] 2026-02-06 03:28 - Notifications list renders latest-first
- [âœ“] 2026-02-06 03:31 - Notification types map to user-readable text
- [âœ“] 2026-02-06 03:36 - Fire push notifications for the same events as in-app
- [âœ“] 2026-02-06 03:40 - Ensure push failures do not block core mutations
- [âœ“] 2026-02-06 03:44 - Include reservationId in payload for deep linking
- [âœ“] 2026-02-06 03:47 - Push sends for paid and ready events
- [âœ“] 2026-02-06 03:50 - Push failures do not fail reservations
- [âœ“] 2026-02-06 04:03 - Add pay-at-pickup option on listing detail if seller allows
- [âœ“] 2026-02-06 04:12 - Add hold timer display to buyer reservation detail view
- [âœ“] 2026-02-06 04:18 - Show expired state in buyer and seller reservation views
- [âœ“] 2026-02-06 04:22 - Add seller UI state for READY and buyer UI for COMPLETE
- [âœ“] 2026-02-06 04:27 - Buyer can create pay-at-pickup intent from listing
- [âœ“] 2026-02-06 04:31 - Hold countdown renders and expires correctly
- [âœ“] 2026-02-06 04:36 - READY and COMPLETE buttons render only when valid
- [âœ“] 2026-02-06 04:40 - Add reservation lifecycle tests (paid, ready, complete, cancelled)
- [âœ“] 2026-02-06 04:44 - Add expiration job tests
- [âœ“] 2026-02-06 04:47 - Add notification creation + unread tests
- [âœ“] 2026-02-06 04:48 - `pnpm -C packages/backend test` passes
- [âœ“] 2026-02-06 04:54 - Stripe Connect onboarding e2e walkthrough
- [âœ“] 2026-02-06 04:59 - Online reservation flow smoke test
- [âœ“] 2026-02-06 05:04 - Pay-at-pickup flow smoke test
- [âœ“] 2026-02-06 05:09 - Feed ordering smoke test (nearby + recent)
- [âœ“] 2026-02-06 05:17 - Push notification delivery check
- [âœ“] 2026-02-06 05:19 - Each item logged in a short checklist note
- [âœ“] 2026-02-06 05:28 - PostHog analytics (autocapture + explicit events)
- [âœ“] 2026-02-06 05:37 - Admin reports/moderation
- [âœ“] 2026-02-06 05:46 - Other items in `docs/26-02-05-n03-fruitland-market-roadmap.md`
- [âœ“] 2026-02-06 15:39 - Add `isActive: v.optional(v.boolean())` field to the `locations` table in `packages/backend/convex/schema.ts` (line 41-54). Use `v.optional()` to avoid needing a data migration â€” existing rows without `isActive` are treated as `true` in queries
- [âœ“] 2026-02-06 15:40 - Add index `by_user_active: ["userId", "isActive"]` to the locations table for fast active address lookup
- [âœ“] 2026-02-06 15:41 - Add index `by_user_placeId: ["userId", "placeId"]` to the locations table for deduplication
- [âœ“] 2026-02-06 15:42 - `npx convex dev` deploys schema without errors
- [âœ“] 2026-02-06 15:46 - Existing seed data still loads correctly
- [âœ“] 2026-02-06 15:47 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 15:48 - Create `packages/backend/convex/lib/getActiveLocation.ts` with an exported `getActiveLocationForUser(ctx: QueryCtx, userId: Id<"users">)` function. It should first query the `by_user_active` index for `isActive === true`. If no result, fall back to querying `by_user` index with `.first()` (handles legacy rows without `isActive`). Import `QueryCtx` from `"./_generated/server"` and `Id` from `"./_generated/dataModel"` â€” note the relative paths since this file is in the `lib/` subdirectory (use `"../_generated/server"` and `"../_generated/dataModel"`)
- [âœ“] 2026-02-06 15:51 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 15:52 - Function is importable from other Convex files
- [âœ“] 2026-02-06 15:54 - Rewrite `packages/backend/convex/locations.ts` with the following exports. Add a module-level `deactivateAll(ctx, userId)` helper that queries all locations for a user and patches any with `isActive: true` to `isActive: false`
- [âœ“] 2026-02-06 15:56 - Add `getCurrentUserLocations` query (no args, authenticated) â€” finds user by Clerk ID, returns all locations via `by_user` index using `.collect()`, sorted by `updatedAt` desc
- [âœ“] 2026-02-06 15:58 - Add `addLocation` mutation (args: address, latitude, longitude, placeId optional, setActive optional boolean). Authenticated. Deduplicates by placeId using `by_user_placeId` index â€” if duplicate found and `setActive` is true, call `deactivateAll` then activate the existing row and return its ID. If no duplicate, check if user has any existing locations (if none, auto-set `isActive: true`). If `setActive` is true and user has existing locations, call `deactivateAll` first. Insert with `isActive`, `createdAt`, `updatedAt`
- [âœ“] 2026-02-06 16:00 - Add `setActiveLocation` mutation (args: locationId). Authenticated. Verify ownership (location's userId matches current user). Call `deactivateAll`, then patch the target location with `isActive: true` and updated timestamp
- [âœ“] 2026-02-06 16:01 - Add `deleteLocation` mutation (args: locationId). Authenticated. Verify ownership. Delete the row. If deleted location had `isActive === true` or `isActive === undefined`, query remaining locations ordered desc by `updatedAt` and promote the first one to active
- [âœ“] 2026-02-06 16:03 - Add `migrateAnonymousLocations` mutation (args: array of `{ address, latitude, longitude, placeId optional, isActive }` objects). Authenticated. For each entry, check for existing location with same placeId via `by_user_placeId` index â€” skip duplicates. Insert non-duplicates with `createdAt` and `updatedAt` set to `Date.now()`
- [âœ“] 2026-02-06 16:05 - Keep `getByUserId` query working â€” change from `.unique()` to using the `getActiveLocationForUser` helper from `packages/backend/convex/lib/getActiveLocation.ts`
- [âœ“] 2026-02-06 16:08 - Keep `createLocation` mutation working as a thin wrapper that calls the same logic as `addLocation` with `setActive: true`. This preserves backward compatibility with `ProfileForm.tsx`
- [âœ“] 2026-02-06 16:10 - Keep `updateLocation` mutation working â€” find user's active location via helper, patch it. If no active location exists, create one instead
- [âœ“] 2026-02-06 16:11 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 16:12 - `npx convex dev` deploys without errors
- [âœ“] 2026-02-06 16:16 - Existing `ProfileForm.tsx` still works (uses `createLocation`)
- [âœ“] 2026-02-06 16:18 - In `packages/backend/convex/discovery.ts`, replace the `.query("locations").withIndex("by_user", ...).unique()` pattern at lines 65-67, 184-186, and 381-383 with `getActiveLocationForUser(ctx, listing.sellerId)`. Import the helper from `./lib/getActiveLocation`
- [âœ“] 2026-02-06 16:20 - In `packages/backend/convex/listings.ts`, replace `.query("locations").withIndex("by_user", ...).unique()` at line 346-348 with `getActiveLocationForUser(ctx, listing.sellerId)`. Import the helper
- [âœ“] 2026-02-06 16:21 - In `packages/backend/convex/sellerProfiles.ts`, replace `.query("locations").withIndex("by_user", ...).unique()` at line 85-87 with `getActiveLocationForUser(ctx, profile.userId)`. Import the helper
- [âœ“] 2026-02-06 16:23 - In `packages/backend/convex/follows.ts`, replace `.query("locations").withIndex("by_user", ...).unique()` at line 253-255 with `getActiveLocationForUser(ctx, listing.sellerId)`. Import the helper
- [âœ“] 2026-02-06 16:23 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 16:25 - `npx convex dev` deploys without errors
- [âœ“] 2026-02-06 16:28 - No remaining `.unique()` calls on the locations table (search: `grep -r '.unique()' packages/backend/convex/ | grep locations`)
- [âœ“] 2026-02-06 16:32 - Feed page still loads listings with distance data
- [âœ“] 2026-02-06 16:33 - Create `apps/web/lib/location-cookie.ts`. Export type `GeoPermissionCookie = "granted" | "denied" | "prompt"`. Export `getGeoPermissionCookie(): GeoPermissionCookie` â€” reads `document.cookie` for key `fm_geo_permission`, returns value if `"granted"` or `"denied"`, otherwise `"prompt"`. Guard with `typeof document === "undefined"` for SSR. Export `setGeoPermissionCookie(state: GeoPermissionCookie): void` â€” sets cookie with `max-age=31536000` (1 year), `path=/`, `SameSite=Lax`. Export `clearGeoPermissionCookie(): void` â€” sets cookie with `max-age=0`
- [âœ“] 2026-02-06 16:33 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 16:37 - File exports are importable from other web app files
- [âœ“] 2026-02-06 16:42 - Create `apps/web/lib/location-storage.ts`. Export interface `StoredAddress { address: string; latitude: number; longitude: number; placeId?: string; isActive: boolean; savedAt: number }`. Use localStorage key `fm_anon_locations`. All functions guard with `typeof window === "undefined"` for SSR
- [âœ“] 2026-02-06 16:43 - Export `getStoredAddresses(): StoredAddress[]` â€” reads and parses from localStorage, returns `[]` on error or missing
- [âœ“] 2026-02-06 16:45 - Export `saveAddress(address: Omit<StoredAddress, "savedAt" | "isActive">, setActive?: boolean): void` â€” deduplicates by placeId (if match found and setActive, just activate it). If new, push to array. If setActive (default true) or first address, set isActive true and others false. Write back to localStorage
- [âœ“] 2026-02-06 16:47 - Export `setActiveStoredAddress(placeId: string): void` â€” sets matching address active, all others inactive
- [âœ“] 2026-02-06 16:48 - Export `deleteStoredAddress(placeId: string): void` â€” removes address. If deleted was active and others remain, promote most recent by `savedAt`
- [âœ“] 2026-02-06 16:50 - Export `getActiveStoredAddress(): StoredAddress | null` â€” returns address with `isActive === true`, or first address, or null
- [âœ“] 2026-02-06 16:50 - Export `clearStoredAddresses(): void` â€” removes the localStorage key entirely
- [âœ“] 2026-02-06 16:51 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 16:54 - Modify `apps/web/hooks/useGeolocation.ts`. Import `getGeoPermissionCookie` and `setGeoPermissionCookie` from `@/lib/location-cookie`
- [âœ“] 2026-02-06 16:57 - In the mount `useEffect`, read cookie state first. If cookie is `"denied"`, set `permissionState: "denied"` and return early (skip browser permissions API). If cookie is `"granted"`, set `permissionState: "granted"` and `isLoading: true`, then call `navigator.geolocation.getCurrentPosition` to re-fetch coords for this session. On success, set coords and stop loading. On failure, clear cookie to `"prompt"` (browser permission may have been revoked) and stop loading. If cookie is `"prompt"`, fall through to existing `navigator.permissions.query` logic
- [âœ“] 2026-02-06 16:59 - In the `requestLocation` success callback, call `setGeoPermissionCookie("granted")` after setting state
- [âœ“] 2026-02-06 17:00 - In the `requestLocation` error callback, if `error.code === 1` (permission denied), call `setGeoPermissionCookie("denied")`
- [âœ“] 2026-02-06 17:00 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 17:01 - Granting location sets `fm_geo_permission=granted` cookie (check in browser DevTools > Application > Cookies)
- [âœ“] 2026-02-06 17:04 - Denying location sets `fm_geo_permission=denied` cookie
- [âœ“] 2026-02-06 17:07 - Page reload with `granted` cookie re-fetches coords without showing browser permission prompt
- [âœ“] 2026-02-06 17:12 - Create `apps/web/hooks/useResolvedLocation.ts` with `"use client"` directive. Import `useAuth` from `@clerk/nextjs`, `useQuery`/`useMutation` from `convex/react`, the `api` from `@fruitland-market/backend`, `useGeolocation` from `./useGeolocation`, cookie utils from `@/lib/location-cookie`, and localStorage utils from `@/lib/location-storage`
- [âœ“] 2026-02-06 17:14 - Export interface `ResolvedLocation { latitude: number; longitude: number; displayName: string; source: "geolocation" | "saved_address" }`
- [âœ“] 2026-02-06 17:17 - Inside the hook, call `useAuth()` for `isSignedIn` and `isLoaded`. Call `useGeolocation()`. Call `useQuery(api.locations.getCurrentUserLocations)` only when signed in (pass `"skip"` otherwise). Set up mutations: `addLocation`, `setActiveLocation`, `deleteLocation`, `migrateAnonymousLocations`
- [âœ“] 2026-02-06 17:20 - Add anonymous-to-auth migration `useEffect`: when `isLoaded && isSignedIn`, read `getStoredAddresses()`. If non-empty, call `migrateAnonymousLocations` mutation with the array, then `clearStoredAddresses()` on success. Dependencies: `[isLoaded, isSignedIn, migrateAnon]` (where `migrateAnon` is the mutation reference)
- [âœ“] 2026-02-06 17:22 - Add `useMemo` for `resolved: ResolvedLocation | null` implementing the priority chain. Priority 1: if `getGeoPermissionCookie() === "granted"` AND `geo.coords` is not null, return `{ latitude, longitude, displayName: "Current Location", source: "geolocation" }`. Priority 2: if signed in and dbLocations available, find location with `isActive === true` (or `isActive === undefined`), fallback to most recent by `updatedAt`. Priority 3: if not signed in, use `getActiveStoredAddress()`. Priority 4: return null
- [âœ“] 2026-02-06 17:24 - Add `useMemo` for `savedAddresses` â€” if signed in, map DB locations to `{ id, address, latitude, longitude, placeId, isActive }`. If not signed in, map localStorage addresses using placeId as id
- [âœ“] 2026-02-06 17:26 - Export `addAddress` callback â€” if signed in, calls `addLocation` mutation with `{ ...addr, setActive }`. If not signed in, calls `saveAddress` from localStorage utils
- [âœ“] 2026-02-06 17:28 - Export `setActiveAddress` callback â€” if signed in, calls `setActiveLocation` mutation. If not signed in, calls `setActiveStoredAddress`
- [âœ“] 2026-02-06 17:31 - Export `removeAddress` callback â€” if signed in, calls `deleteLocation` mutation. If not signed in, calls `deleteStoredAddress`
- [âœ“] 2026-02-06 17:32 - Return object: `{ location: resolved, hasLocation: resolved !== null, isLoading: geo.isLoading, geoPermission: geo.permissionState, savedAddresses, requestGeolocation: geo.requestLocation, addAddress, setActiveAddress, removeAddress }`
- [âœ“] 2026-02-06 17:33 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 17:35 - Hook is importable from web app components
- [âœ“] 2026-02-06 17:39 - Run `npx shadcn@latest add command` from the `apps/web/` directory. This installs `apps/web/components/ui/command.tsx`, adds the `cmdk` dependency, and may also install `popover.tsx` as a dependency
- [âœ“] 2026-02-06 17:40 - `apps/web/components/ui/command.tsx` exists
- [âœ“] 2026-02-06 17:40 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 17:41 - `cmdk` is in `apps/web/package.json` dependencies
- [âœ“] 2026-02-06 17:45 - Create `apps/web/components/location/LocationCommandDialog.tsx` with `"use client"` directive. Accept props `{ open: boolean; onOpenChange: (open: boolean) => void }`. Import `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription` from `@/components/ui/dialog`. Import `Command`, `CommandList`, `CommandGroup`, `CommandItem`, `CommandSeparator` from `@/components/ui/command`. Import `Button` from `@/components/ui/button`. Import `AddressAutocomplete` and `AddressResult` from `@/components/profile/AddressAutocomplete`. Import `useResolvedLocation` from `@/hooks/useResolvedLocation`. Import icons: `MapPin`, `Navigation`, `Trash2`, `Check`, `Loader2` from `lucide-react`
- [âœ“] 2026-02-06 17:47 - Add local state `showAutocomplete: boolean` (default false). Get `geoPermission`, `isLoading`, `requestGeolocation`, `savedAddresses`, `addAddress`, `setActiveAddress`, `removeAddress`, `isUsingGeolocation` (derive from `geoPermission === "granted"` and `location?.source === "geolocation"`) from `useResolvedLocation()`
- [âœ“] 2026-02-06 17:49 - Render Dialog wrapping a Command component. First CommandGroup heading "Detect" with a single CommandItem "Use my current location" â€” on select, call `requestGeolocation()` then `onOpenChange(false)`. Show `Loader2` spinner when loading, `Navigation` icon otherwise. Show green `Check` icon on the right if geolocation is currently active
- [âœ“] 2026-02-06 17:51 - Add CommandSeparator, then CommandGroup heading "Search". If `showAutocomplete` is false, show a CommandItem "Search for an address" with `MapPin` icon â€” on select, set `showAutocomplete(true)`. If `showAutocomplete` is true, render `AddressAutocomplete` component inline (inside a `div` with `px-2 py-2` padding) with `onSelect` that calls `addAddress({ address, latitude, longitude, placeId }, true)` then `onOpenChange(false)` and resets `showAutocomplete(false)`. Set placeholder to "Search for an address..."
- [âœ“] 2026-02-06 17:53 - If `savedAddresses.length > 0`, add CommandSeparator and CommandGroup heading "Saved Addresses". Map each address to a CommandItem showing a truncated address string with `MapPin` icon. On select, call `setActiveAddress(addr.id)` then `onOpenChange(false)`. Show green `Check` icon if `addr.isActive`. Add a ghost `Button` with `Trash2` icon on the right â€” on click (with `e.stopPropagation()`), call `removeAddress(addr.id)`
- [âœ“] 2026-02-06 17:55 - Reset `showAutocomplete` to false when dialog closes (in `onOpenChange` or via useEffect on `open`)
- [âœ“] 2026-02-06 17:55 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 18:00 - Component renders without errors when opened
- [âœ“] 2026-02-06 18:02 - Rewrite `apps/web/components/layout/location-button.tsx`. Replace `useGeolocation()` import and usage with `useResolvedLocation()` from `@/hooks/useResolvedLocation`. Import `LocationCommandDialog` from `@/components/location/LocationCommandDialog`. Add `useState` for `dialogOpen: boolean` (default false)
- [âœ“] 2026-02-06 18:05 - Keep the existing reverse geocode `useEffect` for when `location?.source === "geolocation"` â€” use the same Nominatim fetch to get a city name. When `location?.source === "saved_address"`, extract a short display name from `location.displayName` (split on comma, take first part). When `location` is null, set display name to null
- [âœ“] 2026-02-06 18:07 - Change button `onClick` to always set `dialogOpen(true)` â€” remove the old conditional that returned early when granted. Remove `disabled` on the button (always clickable). Keep the existing visual structure: `MapPin`/`Loader2` icon + truncated text showing loading state, location name, or "Set Location"
- [âœ“] 2026-02-06 18:08 - Render `<LocationCommandDialog open={dialogOpen} onOpenChange={setDialogOpen} />` after the button
- [âœ“] 2026-02-06 18:08 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 18:10 - Clicking "Set Location" opens the command dialog
- [âœ“] 2026-02-06 18:12 - Button shows resolved location name (city for geolocation, address for saved)
- [âœ“] 2026-02-06 18:14 - Button is always clickable, even when location is already set
- [âœ“] 2026-02-06 18:16 - In `apps/web/app/(app)/feed/FeedPageContent.tsx`, replace the `useGeolocation` import and hook call (lines 8, 28-33) with `useResolvedLocation` from `@/hooks/useResolvedLocation`. Destructure `{ location, hasLocation, isLoading: isLoadingLocation, geoPermission }`. Import `LocationCommandDialog` from `@/components/location/LocationCommandDialog`. Add `useState` for `locationDialogOpen: boolean` (default false)
- [âœ“] 2026-02-06 18:20 - Replace `const hasLocation = permissionState === "granted" && coords !== null` (line 41) â€” `hasLocation` now comes from the hook directly
- [âœ“] 2026-02-06 18:22 - Change the location prompt banner (lines 76-100): remove the `feedType === "nearby" &&` guard. Change condition to `!hasLocation && !isLoadingLocation`. Change the button text to "Set Location" and its `onClick` to `() => setLocationDialogOpen(true)`. Remove the inline loading state from the button (the dialog handles that). Update the prompt text to "Set your location to see nearby listings and distances"
- [âœ“] 2026-02-06 18:24 - Change the denied location notice (lines 103-109): remove `feedType === "nearby" &&` guard. Change condition to `!hasLocation && !isLoadingLocation && geoPermission === "denied"`. Change the message to suggest using the Set Location button: "Location access was denied. Use Set Location to search for your address instead." â€” or just remove this notice entirely since the prompt banner above already covers the no-location case with a CTA. Removing is cleaner since the banner already shows
- [âœ“] 2026-02-06 18:25 - Update the `ListingFeed` props (lines 112-119): change `userLocation` from `feedType === "nearby" && hasLocation ? coords : null` to `feedType === "nearby" && hasLocation ? { latitude: location!.latitude, longitude: location!.longitude } : null`
- [âœ“] 2026-02-06 18:27 - Render `<LocationCommandDialog open={locationDialogOpen} onOpenChange={setLocationDialogOpen} />` inside the component
- [âœ“] 2026-02-06 18:27 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 18:28 - Location prompt banner appears on Recent, Nearby, and Popular tabs when no location is set
- [âœ“] 2026-02-06 18:33 - Clicking "Set Location" in the banner opens the command dialog
- [âœ“] 2026-02-06 18:37 - After setting location, banner disappears on all tabs
- [âœ“] 2026-02-06 18:39 - Nearby tab still shows radius filter when location is available
- [âœ“] 2026-02-06 18:44 - Feed still shows distance data on listings when location is set
- [âœ“] 2026-02-06 18:46 - In `apps/web/components/profile/ProfileForm.tsx`, change the import on line 74 from `api.locations.createLocation` to `api.locations.addLocation`. Update the mutation call on lines 207-212 to pass `setActive: true` in addition to the existing address, latitude, longitude, and placeId fields
- [âœ“] 2026-02-06 18:46 - `pnpm typecheck` passes
- [âœ“] 2026-02-06 18:50 - Creating a new seller profile still saves location successfully
- [âœ“] 2026-02-06 18:53 - The saved location appears as active in the location command dialog
- [âœ“] 2026-02-06 18:54 - `pnpm typecheck` passes across the entire monorepo
- [âœ“] 2026-02-06 18:54 - `pnpm lint` passes
- [âœ“] 2026-02-06 18:55 - `npx convex dev` deploys without errors
- [âœ“] 2026-02-06 18:58 - Fresh visit with no cookies/storage shows location prompt on all feed tabs
- [âœ“] 2026-02-06 19:04 - Granting browser geolocation sets cookie, shows location in header, feed shows distances
- [âœ“] 2026-02-06 19:11 - Denying browser geolocation sets cookie, dialog stays open with search option
- [âœ“] 2026-02-06 19:16 - Searching and selecting a Google autocomplete address (signed in) saves to DB, appears in Saved Addresses, feed uses it
- [âœ“] 2026-02-06 19:23 - Searching and selecting a Google autocomplete address (signed out) saves to localStorage, feed uses it
- [âœ“] 2026-02-06 19:29 - Signing in after saving anonymous address migrates it to DB and clears localStorage
- [âœ“] 2026-02-06 19:33 - Multiple saved addresses: can add, switch active, delete
- [âœ“] 2026-02-06 19:37 - Page reload with granted cookie silently re-fetches geolocation without re-prompting
- [âœ“] 2026-02-07 20:49 - Add `getSellersForMap` query to `packages/backend/convex/discovery.ts` that fetches all available listings, groups them by `sellerId` using a Map, and for each unique seller resolves: active location (via `getActiveLocationForUser`), seller profile (via `by_user` index), and photo URL (via `ctx.storage.getUrl` on `photoStorageId`). Skip sellers with no location or no profile. Return shape: `{ seller: { userId, username, displayName, photoUrl }, location: { latitude, longitude, address }, listingCount: number, listings: Array<{ _id, title, price, priceUnit?, category }> }`. Cap `listings` array at 3 items; `listingCount` is the real total.
- [âœ“] 2026-02-07 20:50 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 20:52 - Query returns grouped seller data when called from Convex dashboard or test
- [âœ“] 2026-02-07 20:54 - Add `createSellerIcon(photoUrl: string | null, displayName: string, listingCount: number)` function to `apps/web/lib/map-icons.ts`. The icon is a 40x40px circle with 3px solid #2e6f46 border, white background, and drop shadow. If `photoUrl` exists, render an `<img>` element with `object-fit: cover; border-radius: 50%` and an `onerror` handler that hides the image and shows initials fallback. If no `photoUrl`, show initials (first letter of each word in displayName, uppercase, max 2 chars, green text). If `listingCount > 1`, add a badge in the top-right corner (-4px/-4px offset), 18px diameter, green background (#2e6f46), white text, white 2px border, showing the count number. Keep existing `createListingIcon` and `createClusterIcon` functions unchanged.
- [âœ“] 2026-02-07 20:55 - Add tests in `apps/web/lib/map-icons.test.ts`: createSellerIcon returns L.DivIcon with correct iconSize/iconAnchor, HTML contains `<img>` when photoUrl provided, HTML contains initials when photoUrl is null, badge appears when listingCount > 1, badge does not appear when listingCount === 1
- [âœ“] 2026-02-07 20:55 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 20:56 - `pnpm test apps/web/lib/map-icons.test.ts` passes
- [âœ“] 2026-02-07 20:58 - In `apps/web/components/discovery/MapAutoZoom.tsx`, generalize the `listings: MapListing[]` prop to `points: Array<{ location: { latitude: number; longitude: number } }>`. Rename internal references from `listings` to `points`. Remove the `MapListing` import. The access pattern (`p.location.latitude`, `p.location.longitude`) stays identical.
- [âœ“] 2026-02-07 20:59 - Update `apps/web/components/discovery/MapAutoZoom.test.tsx` â€” rename the `makeListing` helper to `makePoint` and adjust the type to the generic point shape. All test logic stays identical since only `.location` fields are used.
- [âœ“] 2026-02-07 20:59 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:02 - `pnpm test apps/web/components/discovery/MapAutoZoom.test.tsx` passes
- [âœ“] 2026-02-07 21:05 - In `apps/web/components/discovery/DiscoveryMapInner.tsx`, replace the `MapListing` interface with `MapSeller` interface: `{ seller: { userId: string; username: string; displayName: string; photoUrl: string | null }; location: { latitude: number; longitude: number; address: string }; listingCount: number; listings: Array<{ _id: string; title: string; price: number; priceUnit?: string; category: string }> }`. Update props to `sellers: MapSeller[]` and `onSellerClick?: (seller: MapSeller) => void`. Replace the single `listingIcon` useMemo with a per-seller icon map keyed by `seller.userId` using `createSellerIcon`. Update the import from `createListingIcon` to `createSellerIcon`. Remove `formatPrice` helper.
- [âœ“] 2026-02-07 21:07 - Replace `<Popup>` with `<Tooltip>` from react-leaflet on each Marker. Tooltip shows on hover with seller displayName, @username, and "N listings" count. This avoids Leaflet's Popup-on-click conflicting with the click handler.
- [âœ“] 2026-02-07 21:14 - Update each `<Marker>` to use `key={item.seller.userId}`, `icon={sellerIcons.get(item.seller.userId)}`, and `eventHandlers={{ click: () => onSellerClick?.(item) }}`. Pass `points={sellers}` to `<MapAutoZoom>`.
- [âœ“] 2026-02-07 21:15 - Update `apps/web/components/discovery/DiscoveryMapInner.test.tsx` â€” update mock data to `MapSeller` shape, update icon mock to `createSellerIcon`, verify unique icon per seller, update content assertions from listing title/price to seller name/username, update marker key assertions to use `seller.userId`.
- [âœ“] 2026-02-07 21:16 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:17 - `pnpm test apps/web/components/discovery/DiscoveryMapInner.test.tsx` passes
- [âœ“] 2026-02-07 21:18 - In `apps/web/components/discovery/DiscoveryMap.tsx`, update the interface props from `listings: MapListing[]` and `onListingClick` to `sellers: MapSeller[]` and `onSellerClick`. Import and re-export `MapSeller` instead of `MapListing`. Pass updated props through to `DiscoveryMapInner`.
- [âœ“] 2026-02-07 21:18 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:21 - Rename `apps/web/components/discovery/MapListingPanel.tsx` to `MapSellerPanel.tsx`. Rewrite the component with props `{ seller: MapSeller; onClose: () => void }`. Display: seller photo/avatar at top (use the existing Avatar component from `@/components/ui/avatar`), seller displayName + @username, location address, listing count. Below that, show up to 3 listing preview cards from `seller.listings` (each showing title and formatted price). At the bottom, a primary CTA link "View all listings" pointing to `/@${seller.seller.username}`. Keep the same panel positioning (absolute, right side, z-[1000]) and close button pattern as the current MapListingPanel.
- [âœ“] 2026-02-07 21:22 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:25 - In `apps/web/app/(app)/discover/map/MapPageContent.tsx`, swap query to `api.discovery.getSellersForMap`. Replace `selectedListing: MapListing` state with `selectedSeller: MapSeller`. Replace `MapListingPanel` import with `MapSellerPanel`. Update the `onSellerClick` handler to set `selectedSeller`. Render `<MapSellerPanel seller={selectedSeller} onClose={() => setSelectedSeller(null)} />` when a seller is selected. Pass `sellers` and `onSellerClick` props to `<DiscoveryMap>`.
- [âœ“] 2026-02-07 21:29 - Update `apps/web/app/(app)/discover/map/MapPageContent.test.tsx` â€” update mock data to MapSeller shape, replace MapListingPanel mock with MapSellerPanel mock, update DiscoveryMap prop assertions to `sellers`/`onSellerClick`.
- [âœ“] 2026-02-07 21:29 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:29 - `pnpm test apps/web/app/(app)/discover/map/MapPageContent.test.tsx` passes
- [âœ“] 2026-02-07 21:32 - In `apps/web/components/discover/CompactMap.tsx`, swap query to `api.discovery.getSellersForMap`. Update type import from `MapListing` to `MapSeller` (from `DiscoveryMapInner`). Rename `mapListings` to `mapSellers` and cast as `MapSeller[]`. Pass `sellers={mapSellers}` to `DiscoveryMapInner`. Add `useRouter` from next/navigation and an `onSellerClick` handler that calls `router.push(\`/@${seller.seller.username}\`)`. Change section heading from "Nearby Listings" to "Nearby Sellers".
- [âœ“] 2026-02-07 21:34 - Update `apps/web/components/discover/CompactMap.test.tsx` â€” update mock data shape to MapSeller, update DiscoveryMapInner prop assertions.
- [âœ“] 2026-02-07 21:35 - `pnpm typecheck` passes
- [âœ“] 2026-02-07 21:35 - `pnpm test apps/web/components/discover/CompactMap.test.tsx` passes
- [âœ“] 2026-02-07 21:35 - Run `pnpm typecheck` across the entire project
- [âœ“] 2026-02-07 21:37 - Run `pnpm test` across the entire project and fix any remaining failures
- [âœ“] 2026-02-07 21:38 - Delete any leftover references to `MapListingPanel` or `MapListing` type if they exist
- [âœ“] 2026-02-07 21:38 - `pnpm typecheck` passes with zero errors
- [âœ“] 2026-02-07 21:39 - `pnpm test` passes with zero failures
- [âœ“] 2026-02-07 21:40 - No references to `MapListingPanel` or the old `MapListing` type remain in `apps/web/`
- [âœ“] 2026-02-08 19:18 - Create `apps/web/components/layout/account-sidebar.tsx` as a client component
- [âœ“] 2026-02-08 19:21 - Add nav items with Lucide icons: New Listing (PlusCircle), Following (Heart), Reservations (ShoppingBag), Likes (ThumbsUp), My Listings (Store), Seller Orders (Package), Profile (User), Log out (LogOut)
- [âœ“] 2026-02-08 19:22 - Add separator dividers between groups: [New Listing] / [Following, Reservations, Likes, My Listings, Seller Orders] / [Admin Reports (conditional), Profile, Log out]
- [âœ“] 2026-02-08 19:23 - Use `usePathname()` to highlight the active nav item with `bg-accent text-accent-foreground`
- [âœ“] 2026-02-08 19:24 - Use `useQuery(api.sellerProfiles.getCurrentUserProfile)` to resolve My Listings href to `/@{username}` (fall back to `/profile/setup` if no profile)
- [âœ“] 2026-02-08 19:26 - Add conditional Admin Reports link using `useQuery(api.reports.isAdmin)` â€” same pattern as `AdminNavItem` in `app-nav.tsx`
- [âœ“] 2026-02-08 19:27 - Wire Log out to `useClerk().signOut({ redirectUrl: "/" })`
- [âœ“] 2026-02-08 19:28 - Style sidebar as `w-56` with sticky positioning `sticky top-[calc(var(--header-height)+1.5rem)]` and solid `bg-background`
- [âœ“] 2026-02-08 19:30 - Nav items use `text-sm font-medium` with hover state transitions
- [âœ“] 2026-02-08 19:31 - Component renders without errors when imported
- [âœ“] 2026-02-08 19:33 - Nav items match the same items in the header dropdown menu in `app-nav.tsx`
- [âœ“] 2026-02-08 19:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 19:34 - `pnpm lint` passes
- [âœ“] 2026-02-08 19:36 - Create `apps/web/components/layout/account-layout.tsx` as a client component
- [âœ“] 2026-02-08 19:37 - Accept `children` prop
- [âœ“] 2026-02-08 19:39 - Render a flex row on desktop: `<AccountSidebar>` on left (`hidden lg:block`), content on right (`flex-1`)
- [âœ“] 2026-02-08 19:41 - Use `w-full` on the outer container â€” the parent `layout-container` in AppLayout constrains width (same as feed/discover)
- [âœ“] 2026-02-08 19:42 - Add `gap-8` between sidebar and content
- [âœ“] 2026-02-08 19:44 - On mobile (below `lg`), render only children â€” sidebar is completely hidden
- [âœ“] 2026-02-08 19:45 - Component renders without errors when imported
- [âœ“] 2026-02-08 19:46 - On desktop (`lg+`), sidebar and content display side by side
- [âœ“] 2026-02-08 19:51 - On mobile, only children render â€” no sidebar visible
- [âœ“] 2026-02-08 19:51 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 19:51 - `pnpm lint` passes
- [âœ“] 2026-02-08 19:53 - Edit `apps/web/app/(app)/following/FollowingPageContent.tsx`
- [âœ“] 2026-02-08 19:54 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 19:59 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>` (loading, empty, error, and main content states)
- [âœ“] 2026-02-08 20:02 - Keep the existing `w-full max-w-2xl` div inside â€” it constrains content width within the flex-1 content area
- [âœ“] 2026-02-08 20:04 - Following page renders with sidebar on desktop
- [âœ“] 2026-02-08 20:09 - Content width unchanged from before on mobile
- [âœ“] 2026-02-08 20:09 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 20:12 - Edit `apps/web/app/(app)/reservations/ReservationsPageContent.tsx`
- [âœ“] 2026-02-08 20:14 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 20:19 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>`
- [âœ“] 2026-02-08 20:21 - Keep the existing `w-full max-w-2xl` div inside
- [âœ“] 2026-02-08 20:23 - Reservations page renders with sidebar on desktop
- [âœ“] 2026-02-08 20:23 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 20:26 - Edit `apps/web/app/(app)/likes/LikesPageContent.tsx`
- [âœ“] 2026-02-08 20:27 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 20:30 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>`
- [âœ“] 2026-02-08 20:32 - Keep the existing `w-full max-w-2xl` div inside
- [âœ“] 2026-02-08 20:34 - Likes page renders with sidebar on desktop
- [âœ“] 2026-02-08 20:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 20:37 - Edit `apps/web/app/(app)/seller/orders/SellerOrdersPageContent.tsx`
- [âœ“] 2026-02-08 20:39 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 20:41 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>`
- [âœ“] 2026-02-08 20:43 - Keep the existing `w-full max-w-2xl` div inside
- [âœ“] 2026-02-08 20:45 - Seller Orders page renders with sidebar on desktop
- [âœ“] 2026-02-08 20:45 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 20:47 - Edit `apps/web/app/(app)/profile/setup/ProfileSetupPageContent.tsx`
- [âœ“] 2026-02-08 20:49 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 20:50 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>`
- [âœ“] 2026-02-08 20:51 - Keep the existing `w-full max-w-xl` div inside
- [âœ“] 2026-02-08 20:53 - Profile Setup page renders with sidebar on desktop
- [âœ“] 2026-02-08 20:53 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 20:54 - Edit `apps/web/app/(app)/listings/new/NewListingPageContent.tsx`
- [âœ“] 2026-02-08 20:56 - Import `AccountLayout` from `@/components/layout/account-layout`
- [âœ“] 2026-02-08 20:58 - Wrap every return statement's content in `<AccountLayout>...</AccountLayout>`
- [âœ“] 2026-02-08 20:59 - Keep the existing `w-full max-w-xl` div inside
- [âœ“] 2026-02-08 21:01 - New Listing page renders with sidebar on desktop
- [âœ“] 2026-02-08 21:01 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 21:01 - `pnpm typecheck` passes with zero errors
- [âœ“] 2026-02-08 21:02 - `pnpm lint` passes with zero errors
- [âœ“] 2026-02-08 21:05 - All 6 account pages show sidebar + content side by side on desktop (`lg+`)
- [âœ“] 2026-02-08 21:08 - Sidebar highlights the correct active page on each page
- [âœ“] 2026-02-08 21:11 - Clicking sidebar items navigates between pages
- [âœ“] 2026-02-08 21:14 - Sidebar is completely hidden on mobile (below `lg`)
- [âœ“] 2026-02-08 21:17 - Header dropdown menu in `app-nav.tsx` is completely unchanged
- [âœ“] 2026-02-08 21:18 - Log out in sidebar signs the user out and redirects to `/`
- [âœ“] 2026-02-08 21:22 - Overall page width matches feed/discover (uses same `layout-container`)
- [âœ“] 2026-02-08 22:47 - `git mv apps/web/app/(app)/my-listings/page.tsx apps/web/app/(app)/listings/page.tsx`
- [âœ“] 2026-02-08 22:49 - `git mv apps/web/app/(app)/my-listings/MyListingsPageContent.tsx apps/web/app/(app)/listings/MyListingsPageContent.tsx`
- [âœ“] 2026-02-08 22:49 - Delete empty `apps/web/app/(app)/my-listings/` directory if it remains
- [âœ“] 2026-02-08 22:50 - `apps/web/app/(app)/listings/page.tsx` exists and imports `./MyListingsPageContent`
- [âœ“] 2026-02-08 22:51 - `apps/web/app/(app)/my-listings/` directory no longer exists
- [âœ“] 2026-02-08 22:51 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 22:55 - Create `apps/web/app/(app)/listings/orders/` directory
- [âœ“] 2026-02-08 22:56 - `git mv apps/web/app/(app)/seller/orders/page.tsx apps/web/app/(app)/listings/orders/page.tsx`
- [âœ“] 2026-02-08 22:58 - `git mv apps/web/app/(app)/seller/orders/SellerOrdersPageContent.tsx apps/web/app/(app)/listings/orders/SellerOrdersPageContent.tsx`
- [âœ“] 2026-02-08 22:59 - `git mv apps/web/app/(app)/seller/orders/SellerOrdersPageContent.test.tsx apps/web/app/(app)/listings/orders/SellerOrdersPageContent.test.tsx`
- [âœ“] 2026-02-08 23:00 - `apps/web/app/(app)/listings/orders/page.tsx` exists
- [âœ“] 2026-02-08 23:01 - `apps/web/app/(app)/seller/orders/` directory no longer exists
- [âœ“] 2026-02-08 23:04 - `apps/web/app/(app)/seller/connect/` still exists and is untouched
- [âœ“] 2026-02-08 23:05 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:08 - `git mv apps/web/app/(app)/profile/setup/page.tsx apps/web/app/(app)/profile/page.tsx`
- [âœ“] 2026-02-08 23:10 - `git mv apps/web/app/(app)/profile/setup/ProfileSetupPageContent.tsx apps/web/app/(app)/profile/ProfileSetupPageContent.tsx`
- [âœ“] 2026-02-08 23:11 - `git mv apps/web/app/(app)/profile/setup/ProfileSetupPageContent.test.tsx apps/web/app/(app)/profile/ProfileSetupPageContent.test.tsx`
- [âœ“] 2026-02-08 23:11 - Delete empty `apps/web/app/(app)/profile/setup/` directory if it remains
- [âœ“] 2026-02-08 23:12 - `apps/web/app/(app)/profile/page.tsx` exists and imports `./ProfileSetupPageContent`
- [âœ“] 2026-02-08 23:14 - `apps/web/app/(app)/profile/setup/` directory no longer exists
- [âœ“] 2026-02-08 23:14 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:16 - In `apps/web/components/layout/account-sidebar.tsx`, change My Listings href from `/my-listings` to `/listings`
- [âœ“] 2026-02-08 23:17 - Update My Listings active state to: `pathname === "/listings" || (pathname.startsWith("/listings/") && pathname !== "/listings/new" && !pathname.startsWith("/listings/orders"))`
- [âœ“] 2026-02-08 23:18 - Change Seller Orders href from `/seller/orders` to `/listings/orders`
- [âœ“] 2026-02-08 23:19 - Update Seller Orders active state from `pathname.startsWith("/seller/")` to `pathname.startsWith("/listings/orders")`
- [âœ“] 2026-02-08 23:20 - Change Profile href from `/profile/setup` to `/profile`
- [âœ“] 2026-02-08 23:21 - Update Profile active state from `pathname === "/profile/setup"` to `pathname === "/profile"`
- [âœ“] 2026-02-08 23:23 - Sidebar links point to `/listings`, `/listings/orders`, and `/profile`
- [âœ“] 2026-02-08 23:24 - Active state truth table above is satisfied
- [âœ“] 2026-02-08 23:24 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:25 - `pnpm lint` passes
- [âœ“] 2026-02-08 23:25 - In `apps/web/components/layout/app-nav.tsx`, change My Listings `<Link href>` from `/my-listings` to `/listings`
- [âœ“] 2026-02-08 23:26 - Change Seller Orders `<Link href>` from `/seller/orders` to `/listings/orders`
- [âœ“] 2026-02-08 23:27 - Change Profile `<Link href>` from `/profile/setup` to `/profile`
- [âœ“] 2026-02-08 23:30 - Dropdown menu links point to `/listings`, `/listings/orders`, and `/profile`
- [âœ“] 2026-02-08 23:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:31 - `pnpm lint` passes
- [âœ“] 2026-02-08 23:32 - In `apps/web/components/layout/account-sidebar.test.tsx`, update href assertion for My Listings from `/my-listings` to `/listings`
- [âœ“] 2026-02-08 23:32 - Update href assertion for Seller Orders from `/seller/orders` to `/listings/orders`
- [âœ“] 2026-02-08 23:33 - Update href assertion for Profile from `/profile/setup` to `/profile`
- [âœ“] 2026-02-08 23:34 - Update test "always links My Listings to /my-listings" â€” rename and change assertion to `/listings`
- [âœ“] 2026-02-08 23:35 - Remove test "highlights Seller Orders when on the seller connect page" â€” `/seller/connect` no longer highlights Seller Orders after the active state change
- [âœ“] 2026-02-08 23:36 - Update test "highlights Seller Orders when on the seller orders page" â€” change `mockPathname` from `/seller/orders` to `/listings/orders`
- [âœ“] 2026-02-08 23:37 - Update test "highlights Profile when on the profile setup page" â€” change `mockPathname` from `/profile/setup` to `/profile` and rename test
- [âœ“] 2026-02-08 23:38 - Update click test "clicking My Listings navigates to /my-listings" â€” rename and change href assertion to `/listings`
- [âœ“] 2026-02-08 23:39 - Update click test "clicking Seller Orders navigates to /seller/orders" â€” rename and change href assertion to `/listings/orders`
- [âœ“] 2026-02-08 23:40 - Update click test "clicking Profile navigates to /profile/setup" â€” rename and change href assertion to `/profile`
- [âœ“] 2026-02-08 23:41 - Add new test: verify `/listings/orders` does NOT highlight My Listings (set `mockPathname = "/listings/orders"`, assert My Listings does not have `bg-accent`, assert Seller Orders does have `bg-accent`)
- [âœ“] 2026-02-08 23:42 - Run `cd apps/web && pnpm vitest run components/layout/account-sidebar.test.tsx` â€” all tests pass
- [âœ“] 2026-02-08 23:45 - No test references `/my-listings`, `/seller/orders`, or `/profile/setup`
- [âœ“] 2026-02-08 23:45 - In `apps/web/components/layout/app-nav.test.tsx`, update href assertion for My Listings from `/my-listings` to `/listings`
- [âœ“] 2026-02-08 23:46 - Update href assertion for Seller Orders from `/seller/orders` to `/listings/orders`
- [âœ“] 2026-02-08 23:47 - Update href assertion for Profile from `/profile/setup` to `/profile`
- [âœ“] 2026-02-08 23:48 - Update test "dropdown menu always links My Listings to /my-listings" â€” rename and change assertion to `/listings`
- [âœ“] 2026-02-08 23:49 - Run `cd apps/web && pnpm vitest run components/layout/app-nav.test.tsx` â€” all tests pass
- [âœ“] 2026-02-08 23:51 - No test references `/my-listings`, `/seller/orders`, or `/profile/setup`
- [âœ“] 2026-02-08 23:52 - In `apps/web/app/metadata.test.ts`, update the Seller Orders import path from `./(app)/seller/orders/page` to `./(app)/listings/orders/page`
- [âœ“] 2026-02-08 23:54 - Update the Profile Setup import path from `./(app)/profile/setup/page` to `./(app)/profile/page`
- [âœ“] 2026-02-08 23:56 - Update any test names or describe block labels that reference the old paths
- [âœ“] 2026-02-08 23:57 - Run `cd apps/web && pnpm vitest run app/metadata.test.ts` â€” all tests pass
- [âœ“] 2026-02-08 23:57 - `pnpm typecheck` passes with zero errors
- [âœ“] 2026-02-08 23:58 - `pnpm lint` passes with zero errors
- [âœ“] 2026-02-08 23:58 - Run `cd apps/web && pnpm vitest run components/layout/account-sidebar.test.tsx` â€” all pass
- [âœ“] 2026-02-08 23:59 - Run `cd apps/web && pnpm vitest run components/layout/app-nav.test.tsx` â€” all pass
- [âœ“] 2026-02-08 23:59 - Run `cd apps/web && pnpm vitest run app/metadata.test.ts` â€” all pass
- [âœ“] 2026-02-09 00:00 - Run `cd apps/web && pnpm vitest run "app/(app)/listings/orders/SellerOrdersPageContent.test.tsx"` â€” all pass
- [âœ“] 2026-02-09 00:02 - `apps/web/app/(app)/my-listings/` directory does not exist
- [âœ“] 2026-02-09 00:04 - `apps/web/app/(app)/seller/orders/` directory does not exist
- [âœ“] 2026-02-09 00:05 - `apps/web/app/(app)/profile/setup/` directory does not exist
- [âœ“] 2026-02-09 00:06 - `apps/web/app/(app)/seller/connect/` still exists and is untouched
- [âœ“] 2026-02-08 21:49 - Add `interstitials` and `emptyStateComponent` to the `ListingFeedProps` interface
- [âœ“] 2026-02-08 21:50 - Modify the `displayResults.map()` render loop (line 117) to interleave interstitial cards after every `interval` listings. Each interstitial wraps in a `div` with `col-span-full` and is keyed `interstitial-{index}`. Only insert if `interstitialIndex < interstitials.cards.length`
- [âœ“] 2026-02-08 21:51 - Modify the empty state block (lines 103-112) to render `emptyStateComponent` when provided, falling back to the existing default text
- [âœ“] 2026-02-08 21:52 - Existing `/feed` page renders identically (no props passed = no behavior change)
- [âœ“] 2026-02-08 21:53 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 21:54 - `pnpm lint` passes
- [âœ“] 2026-02-08 21:57 - Add `FeedPageContentProps` interface with the four optional props. Update the component signature to accept and destructure them
- [âœ“] 2026-02-08 21:59 - Render `{banner}` above the existing `grid` div (before the `<div className="grid grid-cols-1 lg:grid-cols-[1fr_320px]...">`)
- [âœ“] 2026-02-08 22:02 - Pass `interstitials` and `emptyStateComponent` props through to the `<ListingFeed>` component
- [âœ“] 2026-02-08 22:13 - Render `{sidebarExtra}` as the first child inside `<DiscoverSidebar>`, above the existing `<div className="space-y-4">` (or inside it, above `<SeasonalCard />`)
- [âœ“] 2026-02-08 22:15 - Existing `/feed` page renders identically (no props passed = no behavior change)
- [âœ“] 2026-02-08 22:16 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 22:16 - `pnpm lint` passes
- [âœ“] 2026-02-08 22:18 - Create `PromoBannerContent.ts` with a typed config object for the `"welcome"` variant containing: headline (`PRODUCT_TAGLINE_SHORT`), description (from `PRODUCT_TAGLINE_LONG`), primaryCTA (`{ label: "Browse Local Goods", href: "#feed" }`), secondaryCTA (`{ label: "Start Selling", href: "/sign-up" }`). Add typed stubs for `"seasonal"` and `"announcement"` variants (types defined, content empty)
- [âœ“] 2026-02-08 22:21 - Create `PromoBanner.tsx` with a `variant` prop (`"welcome" | "seasonal" | "announcement"`). The welcome variant renders: `bg-accent` background, `text-accent-foreground` text, headline in `text-2xl font-bold tracking-tight`, description in `text-sm text-accent-foreground/80`, two Button CTAs side by side on desktop (`sm:flex-row`), stacked on mobile. Compact: `py-8 px-4` padding. Not dismissible
- [âœ“] 2026-02-08 22:26 - Add dismissal support infrastructure: a `dismissible` boolean (false for welcome, true for seasonal/announcement) with localStorage persistence keyed by `promo-banner-dismissed-{variantId}`. Seasonal/announcement variants return `null` for now (stub)
- [âœ“] 2026-02-08 22:27 - `<PromoBanner variant="welcome" />` renders a compact accent-colored banner with tagline and two CTAs
- [âœ“] 2026-02-08 22:28 - Banner is responsive: CTAs stack vertically on mobile, horizontal on `sm:`
- [âœ“] 2026-02-08 22:30 - `<PromoBanner variant="seasonal" />` renders nothing (stubbed)
- [âœ“] 2026-02-08 22:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 22:30 - `pnpm lint` passes
- [âœ“] 2026-02-08 22:32 - Create `CategoryStrip.tsx` that imports `LISTING_CATEGORIES` from `@fruitland-market/backend/convex/constants`. Render a horizontal flex row with `overflow-x-auto` and the `scrollbar-hidden` class. Use `-mx-4 px-4` for edge-bleed scroll on mobile. Each category is a Next.js `Link` to `/feed?category={value}` styled as a pill: `rounded-full bg-muted px-3 py-1.5 text-sm font-medium whitespace-nowrap hover:bg-muted/80 transition-colors`. Display emoji + label for each item. Add `gap-2` between pills
- [âœ“] 2026-02-08 22:34 - Component renders all 7 categories (Produce, Eggs & Dairy, Baked Goods, Plants, Handmade, Preserves, Wellness) with emojis
- [âœ“] 2026-02-08 22:37 - Each pill links to `/feed?category={categoryValue}`
- [âœ“] 2026-02-08 22:39 - Horizontal scroll works on mobile without visible scrollbar
- [âœ“] 2026-02-08 22:41 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 22:41 - `pnpm lint` passes
- [âœ“] 2026-02-08 22:43 - Create `HowItWorksInterstitial.tsx` â€” compact 3-step explanation: Browse, Reserve, Pick Up. Use icons from lucide-react (Search, Calendar, PackageCheck â€” same as existing `HowItWorks` component). Render as a horizontal row on desktop (`sm:grid-cols-3`), vertical stack on mobile. Each step: icon in `h-10 w-10 rounded-full bg-accent/10 text-accent` + title + short description
- [âœ“] 2026-02-08 22:45 - Create `TrustSafetyInterstitial.tsx` â€” "Safe Local Meetups" heading with 3 safety highlights: "Meet in public places", "Community-backed marketplace", "Easy reporting tools". Use Shield icon from lucide-react. Include a `text-primary hover:underline` link "Read Safety Tips" pointing to `/safety`
- [âœ“] 2026-02-08 22:47 - Create `SellerCTAInterstitial.tsx` â€” "Have something to sell?" heading, one-sentence pitch ("No listing fees, flexible schedule, keep more of what you earn"), single Button CTA "Start Selling" linking to `/sign-up`
- [âœ“] 2026-02-08 22:48 - Create `index.ts` barrel export re-exporting all three interstitial components
- [âœ“] 2026-02-08 22:50 - All three interstitial cards render inside a `Card` with `border-l-4 border-accent`
- [âœ“] 2026-02-08 22:52 - `HowItWorksInterstitial` is horizontal on desktop, stacked on mobile
- [âœ“] 2026-02-08 22:53 - `SellerCTAInterstitial` CTA links to `/sign-up`
- [âœ“] 2026-02-08 22:56 - `TrustSafetyInterstitial` links to `/safety`
- [âœ“] 2026-02-08 22:56 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 22:57 - `pnpm lint` passes
- [âœ“] 2026-02-08 22:58 - Create `apps/web/components/marketing/WelcomeSidebarCard.tsx` â€” a `Card` with `CardHeader` ("New to Fruitland?") and `CardContent` containing 3 compact feature bullets: Seasonal Goods (ShoppingBasket icon), Neighborly Pickup (MapPin icon), Community First (Users icon). Each: icon + bold title + one-line description. Include "Learn More â†’" link to `/how-it-works` at bottom
- [âœ“] 2026-02-08 23:00 - Create `apps/web/components/marketing/EmptyFeedFallback.tsx` â€” renders when feed has 0 listings. Include the existing `HowItWorks` component, a heading "Be the first seller in your area", and a Button CTA "Start Selling" linking to `/sign-up`. Import HowItWorks from `@/components/how-it-works/HowItWorks`
- [âœ“] 2026-02-08 23:00 - `WelcomeSidebarCard` renders a card with 3 feature bullets and a learn-more link
- [âœ“] 2026-02-08 23:02 - `EmptyFeedFallback` renders HowItWorks content and a seller CTA
- [âœ“] 2026-02-08 23:02 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:02 - `pnpm lint` passes
- [âœ“] 2026-02-08 23:04 - Create `HomepageContent.tsx` as a `"use client"` component. Import `FeedPageContent` from `./feed/FeedPageContent`. Import `PromoBanner`, `CategoryStrip`, `WelcomeSidebarCard`, `EmptyFeedFallback`, and all three interstitial components. Render `<FeedPageContent>` passing: `banner` prop as a fragment containing `<PromoBanner variant="welcome" />` then `<CategoryStrip />`, `interstitials` prop with the three interstitial components and `interval: 6`, `sidebarExtra` as `<WelcomeSidebarCard />`, `emptyStateComponent` as `<EmptyFeedFallback />`
- [âœ“] 2026-02-08 23:06 - Create `apps/web/app/(app)/page.tsx` as an async server component. Import `auth` from `@clerk/nextjs/server` and `redirect` from `next/navigation`. Call `const { userId } = await auth()`. If `userId` exists, call `redirect("/feed")`. Otherwise render `<Suspense><HomepageContent /></Suspense>`. Export metadata with `title: PRODUCT_NAME` and `description: PRODUCT_TAGLINE_LONG`
- [âœ“] 2026-02-08 23:07 - Delete `apps/web/app/page.tsx` (the old standalone marketing splash with HeroSection, FeaturedListings, HowItWorks, SellerCTA)
- [âœ“] 2026-02-08 23:15 - Unauthenticated visit to `/` shows: header, welcome banner, category strip, live feed with interstitials every 6 cards, sidebar with WelcomeSidebarCard + SeasonalCard + NearbySellersCard + TrendingNowCard, footer
- [âœ“] 2026-02-08 23:18 - Authenticated visit to `/` redirects to `/feed` (server-side, no flash)
- [âœ“] 2026-02-08 23:20 - `/feed` renders identically to before (no banner, no interstitials, no category strip)
- [âœ“] 2026-02-08 23:25 - Header logo link (pointing to `/`) works correctly for both auth states
- [âœ“] 2026-02-08 23:30 - Mobile: banner CTAs stack vertically, categories scroll horizontally, no sidebar visible, interstitials carry educational content
- [âœ“] 2026-02-08 23:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-08 23:30 - `pnpm lint` passes
- [âœ“] 2026-02-09 22:05 - Define Convex schema in `convex/schema.ts` â€” all 6 tables (`leads`, `clusters`, `emails`, `activities`, `emailTemplates`, `campaigns`) with all fields from SPEC.md data model. Use Convex `v` validators. Add indexes: `leads` by status, by clusterId, by city, by name; `activities` by leadId; `emails` by leadId, by smartleadCampaignId; `campaigns` by status.
- [âœ“] 2026-02-09 22:07 - Create the app layout component at `src/components/layout/app-layout.tsx` â€” sidebar with nav links (Dashboard `/`, Leads `/leads`, Map `/map`, Clusters `/clusters`, Campaigns `/campaigns`, Settings `/settings`), top bar with page title, and main content area. Match the mockup sidebar structure (FM logo, brand title "FM Outreach", subtitle "Seller CRM", footer with "Internal tool" pill). Use shadcn Button for nav items. Sidebar should highlight the active route.
- [âœ“] 2026-02-09 22:09 - Create the root layout at `src/app/layout.tsx` â€” wrap with ConvexProvider, import globals.css, set metadata title "FM Outreach". Create `src/app/providers.tsx` with ConvexClientProvider.
- [âœ“] 2026-02-09 22:10 - Create placeholder page at `src/app/page.tsx` (Dashboard) â€” render AppLayout with a heading "Dashboard" and a paragraph "Coming in Phase 10"
- [âœ“] 2026-02-09 22:11 - Create placeholder page at `src/app/leads/page.tsx` â€” render AppLayout with heading "Leads" and paragraph "Coming in Phase 3"
- [âœ“] 2026-02-09 22:11 - Create placeholder page at `src/app/leads/[id]/page.tsx` â€” render AppLayout with heading "Lead Detail" and paragraph "Coming in Phase 3"
- [âœ“] 2026-02-09 22:12 - Create placeholder page at `src/app/map/page.tsx` â€” render AppLayout with heading "Map" and paragraph "Coming in Phase 4"
- [âœ“] 2026-02-09 22:13 - Create placeholder page at `src/app/clusters/page.tsx` â€” render AppLayout with heading "Clusters" and paragraph "Coming in Phase 4"
- [âœ“] 2026-02-09 22:14 - Create placeholder page at `src/app/campaigns/page.tsx` â€” render AppLayout with heading "Campaigns" and paragraph "Coming in Phase 8"
- [âœ“] 2026-02-09 22:15 - Create placeholder page at `src/app/settings/page.tsx` â€” render AppLayout with heading "Settings" and paragraph "Coming in Phase 5"
- [âœ“] 2026-02-09 22:17 - Create seed data helper functions in `convex/seedHelpers.ts` â€” `createTestLead(ctx, overrides)` and `createTestActivity(ctx, overrides)` that insert records with sensible defaults. These are for development testing only.
- [âœ“] 2026-02-09 22:19 - `pnpm dev` runs without errors
- [âœ“] 2026-02-09 22:24 - `npx convex dev` syncs schema without errors
- [âœ“] 2026-02-09 22:25 - Navigating between all 7 routes works (Dashboard, Leads, Lead Detail, Map, Clusters, Campaigns, Settings)
- [âœ“] 2026-02-09 22:26 - Sidebar highlights the active page
- [âœ“] 2026-02-09 22:28 - `pnpm typecheck` passes (add `"typecheck": "tsc --noEmit"` to package.json scripts if missing)
- [âœ“] 2026-02-09 22:28 - `pnpm lint` passes
- [âœ“] 2026-02-09 22:55 - Create a CSV parsing utility in `convex/lib/csvParser.ts` â€” parse CSV text into rows of key-value pairs. Handle quoted fields (some addresses contain commas). No external dependency needed â€” use a simple RFC 4180 parser.
- [âœ“] 2026-02-09 22:58 - Create the seed mutation in `convex/seeds/importLeads.ts` â€” Convex action that takes `{ csvContent: string, filename: string }`. Hardcoded column mapping: `Name` â†’ `name`, `Email address` â†’ `contactEmail`, `URL` â†’ `website`, `Instagram` â†’ `socialLinks.instagram`, `Phone` â†’ `contactPhone`, `Address` â†’ `address`, `Town / City` â†’ `city`, `Hours` â†’ `notes`, `Categories` â†’ used to derive `type`. Derive type: if Categories contains "Farmer's Market" â†’ `farmers_market`, else â†’ `farm`. Set `source: "spreadsheet_import"`, `status: "new_lead"`, `province: "ON"`, `consentSource: "spreadsheet_import - [filename] - [date]"`, `createdAt` and `updatedAt` to `Date.now()`, `followUpCount: 0`.
- [âœ“] 2026-02-09 22:59 - Add deduplication to the seed mutation â€” before inserting, query for existing lead with matching name+city (case-insensitive, trimmed). If found, skip the row. Track counts: inserted, skipped (duplicate), errored.
- [âœ“] 2026-02-09 23:00 - Create a seed runner action in `convex/seeds/runSeed.ts` â€” Convex action that reads both CSV files (store CSV content as string arguments or use Convex file storage), calls the import mutation for each, and returns combined results `{ farms: { inserted, skipped, errors }, markets: { inserted, skipped, errors } }`.
- [âœ“] 2026-02-09 23:02 - Create a batch geocoding action in `convex/seeds/geocodeLeads.ts` â€” Convex action that queries all leads where `latitude` is undefined, calls Google Geocoding API (`https://maps.googleapis.com/maps/api/geocode/json?address={encoded_address}&key={KEY}`) for each, and patches the lead with `latitude` and `longitude`. Process in batches of 10 with 200ms delay between batches to respect rate limits. Log results: geocoded count, failed count, already-had-coords count.
- [âœ“] 2026-02-09 23:03 - Create a Node.js seed script at `scripts/seed.ts` â€” reads `data/farms.csv` and `data/farmers-markets.csv` from disk, calls the Convex seed action via the Convex client. Include instructions in a comment at the top for how to run it: `npx tsx scripts/seed.ts`. After seeding, trigger the geocoding action.
- [âœ“] 2026-02-09 23:07 - Running the seed script imports ~446 leads (278 farms + 167 markets, minus any cross-file duplicates)
- [âœ“] 2026-02-09 23:09 - Running the seed script a second time inserts 0 new records (all skipped as duplicates)
- [âœ“] 2026-02-09 23:12 - Leads visible in Convex dashboard with correct field mapping
- [âœ“] 2026-02-09 23:14 - Leads with type `farmers_market` have Categories containing "Farmer's Market"
- [âœ“] 2026-02-09 23:16 - After geocoding, most leads have latitude/longitude populated (some addresses may fail)
- [âœ“] 2026-02-09 23:17 - `pnpm typecheck` passes
- [âœ“] 2026-02-09 23:26 - Create Convex query `convex/leads.ts:list` â€” paginated leads query with optional filters: `status`, `type`, `clusterId`, `hasEmail` (boolean), `hasSocial` (boolean), `source`, `needsFollowUp` (where `nextFollowUpAt` <= now). Support sorting by `name`, `city`, `status`, `updatedAt`. Default sort: `name` ascending. Return first 50 results with cursor for pagination.
- [âœ“] 2026-02-09 23:28 - Create Convex query `convex/leads.ts:search` â€” text search by name or city (case-insensitive prefix match). Return matching leads up to 50.
- [âœ“] 2026-02-09 23:30 - Create the leads table page at `src/app/leads/page.tsx` â€” replace placeholder. Render a data table with columns: checkbox (for multi-select), Name, Type, City, Status (as colored Badge), Contact Email, Social (FB/IG indicator badges), Last Activity date, Follow-up Due (date or "Overdue" in red). Clicking a row navigates to `/leads/[id]`.
- [âœ“] 2026-02-09 23:33 - Create filter bar component at `src/components/leads/lead-filters.tsx` â€” filter controls above the table: Status dropdown (all pipeline stages), Type dropdown (farm, farmers_market, etc.), Has Email toggle, Has Social toggle, Source dropdown, Needs Follow-up toggle. Active filters shown as dismissible pills. Use shadcn Select and Badge components.
- [âœ“] 2026-02-09 23:35 - Create search input at `src/components/leads/lead-search.tsx` â€” text input above filters with search icon. Debounce 300ms. Searches name and city fields.
- [âœ“] 2026-02-09 23:39 - Create bulk action bar at `src/components/leads/bulk-actions.tsx` â€” appears when 1+ rows are selected via checkbox. Shows selected count and action buttons: "Change Status" (dropdown), "Assign to Cluster" (dropdown). Selecting an action creates a Convex mutation to update all selected leads.
- [âœ“] 2026-02-09 23:40 - Create Convex mutations `convex/leads.ts:bulkUpdateStatus` and `convex/leads.ts:bulkAssignCluster` â€” take array of lead IDs and new value, update all, log activity on each.
- [âœ“] 2026-02-09 23:41 - Create Convex query `convex/leads.ts:get` â€” get a single lead by ID with all fields.
- [âœ“] 2026-02-09 23:43 - Create lead detail page at `src/app/leads/[id]/page.tsx` â€” replace placeholder. Full profile layout: header with name, city, type, status badge. Two-column layout below: left column has contact info, business details, CASL consent source; right column has activity timeline.
- [âœ“] 2026-02-09 23:47 - Create inline editing for lead detail fields â€” clicking a field value turns it into an input/textarea. Save on blur or Enter. Create Convex mutation `convex/leads.ts:update` that patches any subset of lead fields and sets `updatedAt`.
- [âœ“] 2026-02-09 23:50 - Create status selector component at `src/components/leads/status-selector.tsx` â€” dropdown showing all pipeline stages with color indicators. Changing status calls `convex/leads.ts:updateStatus` mutation which updates the status AND logs a `status_changed` activity with `{ oldStatus, newStatus }` in metadata.
- [âœ“] 2026-02-09 23:51 - Create Convex query `convex/activities.ts:listByLead` â€” get all activities for a lead, sorted by `createdAt` descending. Paginate at 20.
- [âœ“] 2026-02-09 23:53 - Create activity timeline component at `src/components/leads/activity-timeline.tsx` â€” vertical timeline with dot indicators. Each item shows: activity type icon, description, relative timestamp (e.g., "2 hours ago"), channel badge if applicable. Different icon/color per activity type.
- [âœ“] 2026-02-09 23:57 - Create manual activity logging buttons at `src/components/leads/log-activity.tsx` â€” three buttons below the timeline: "Add Note", "Log Call", "Log Social DM". Each opens a Dialog with a textarea for description and (for Social DM) a channel selector (Facebook/Instagram). Submitting creates an activity record via `convex/activities.ts:create` mutation.
- [âœ“] 2026-02-09 23:57 - Create Convex mutation `convex/activities.ts:create` â€” insert activity record with `leadId`, `type`, `channel`, `description`, `metadata`, `createdAt`. Also update the lead's `updatedAt`.
- [âœ“] 2026-02-10 00:00 - Create follow-up reminder component at `src/components/leads/follow-up-reminder.tsx` â€” on lead detail, show current next follow-up date (or "None set"). "Set Reminder" button opens a date picker. Selecting a date calls `convex/leads.ts:setFollowUp` mutation which sets `nextFollowUpAt` and logs activity.
- [âœ“] 2026-02-10 00:01 - Add overdue/due-today indicator to lead detail header â€” if `nextFollowUpAt` is past, show red "Overdue" badge. If today, show amber "Due Today" badge.
- [âœ“] 2026-02-10 00:06 - Leads table loads and displays all ~446 seeded leads
- [âœ“] 2026-02-10 00:08 - Sorting by Name, City, Status works correctly
- [âœ“] 2026-02-10 00:09 - Filtering by status, type, has-email narrows results
- [âœ“] 2026-02-10 00:10 - Searching "Niagara" returns leads with Niagara in name or city
- [âœ“] 2026-02-10 00:12 - Clicking a lead row navigates to `/leads/[id]` with full detail
- [âœ“] 2026-02-10 00:13 - Editing a lead field inline saves to Convex and reflects immediately
- [âœ“] 2026-02-10 00:15 - Changing status logs an activity that appears in the timeline
- [âœ“] 2026-02-10 00:17 - "Add Note" creates a note activity visible in the timeline
- [âœ“] 2026-02-10 00:18 - Setting a follow-up date shows the due indicator
- [âœ“] 2026-02-10 00:20 - Bulk selecting 3 leads and changing status updates all 3
- [âœ“] 2026-02-10 00:21 - `pnpm typecheck` passes
- [âœ“] 2026-02-10 19:07 - Add "Launch Campaign" button â€” appears after push is complete. Calls `updateCampaignStatus(campaignId, "START")` on Smartlead. Updates local campaign status to `active`. Shows success confirmation.
- [âœ“] 2026-02-10 19:08 - Create Convex query `convex/campaigns.ts:list` â€” return all campaigns sorted by `createdAt` descending. Include: name, status, leadCount, stats (sent/opened/replied), smartleadCampaignId.
- [âœ“] 2026-02-10 19:10 - Create campaigns list page at `src/app/campaigns/page.tsx` â€” replace placeholder. Card grid showing all campaigns. Each card shows: name, status badge (draft/active/paused/completed), lead count, key stats (sent, opened %, replied %). "Create Campaign" button at top.
- [âœ“] 2026-02-10 19:11 - Create Convex mutation `convex/campaigns.ts:create` â€” create a campaign record with `status: "draft"`, name, templateIds, targetClusterId or targetFilter, leadCount. No Smartlead interaction yet.
- [âœ“] 2026-02-10 19:15 - Create campaign creation page at `src/app/campaigns/new/page.tsx` â€” step-by-step flow: (1) Name the campaign, (2) Select leads â€” three options: by cluster dropdown, by filter (status/type/region), or manual selection from a lead table with checkboxes. Show selected lead count. (3) Choose template sequence â€” select templates for each step (initial + up to 3 follow-ups) from existing templates. Show sequence preview with delays (Day 0, 3-4, 7-8, 14). (4) Confirm and create draft.
- [âœ“] 2026-02-10 19:19 - Create batch email generation action in `convex/email/batchGenerate.ts` â€” takes a campaign ID, generates personalized emails for all leads in the campaign using the campaign's template sequence. Processes initial email for each lead (follow-ups are generated from templates at send time by Smartlead). Store generated emails in a new `generatedEmails` table or as a field on the campaign. Process sequentially with 500ms delay between leads to manage API costs.
- [âœ“] 2026-02-10 19:21 - Create email preview page at `src/app/campaigns/[id]/preview/page.tsx` â€” shows all generated emails for the campaign. List of leads on the left, clicking a lead shows their personalized email on the right. Each email shows: subject, body, word count, personalization variables used. "Regenerate" button per email to re-run generation. "Edit" button to manually modify. Status indicator: generated, edited, approved.
- [âœ“] 2026-02-10 19:24 - Add approve/reject per email â€” checkbox or button to mark each email as approved. "Approve All" bulk action. Only approved emails are pushed to Smartlead.
- [âœ“] 2026-02-10 19:26 - Create push-to-Smartlead action in `convex/campaigns/pushToSmartlead.ts` â€” takes a campaign ID. Steps: (1) Create campaign in Smartlead via API, save `smartleadCampaignId`, (2) Push email sequence (subject + body for initial, template content for follow-ups, with delays), (3) Add leads in batches of 100 (email, name, custom fields for personalization), (4) Update campaign status to `active`. Do NOT auto-launch â€” return the Smartlead campaign ID so the user can review in Smartlead before launching.
- [âœ“] 2026-02-10 19:31 - Add "Push to Smartlead" button on campaign preview page â€” only enabled when all emails are approved. Shows confirmation dialog: "This will create the campaign in Smartlead and add X leads. You'll need to launch it from Smartlead or click Launch below." Button calls the push action and shows progress.
- [âœ“] 2026-02-10 19:37 - Create campaign detail page at `src/app/campaigns/[id]/page.tsx` â€” header with campaign name, status, creation date. Stats cards: total leads, emails sent, open rate %, click rate %, reply rate %, bounce rate %. Per-lead table below: lead name, email, current sequence step, status (sent/opened/replied/bounced), last activity date. Click lead name to navigate to lead detail.
- [âœ“] 2026-02-10 19:38 - Create Convex query `convex/campaigns.ts:getWithLeads` â€” get campaign by ID with all lead statuses. Join leads table with emails table to get per-lead sequence step and event timestamps.
- [âœ“] 2026-02-10 19:40 - Add reply indicators to campaign detail â€” leads with replies highlighted, with "View Reply" link that opens the activity timeline showing the reply activity.
- [âœ“] 2026-02-10 19:46 - Creating a campaign with selected leads and templates creates a draft record
- [âœ“] 2026-02-10 19:52 - Batch email generation produces personalized emails for all campaign leads
- [âœ“] 2026-02-11 02:57 - Clusters page lists the new polygon cluster with correct lead count
- [âœ“] 2026-02-11 03:01 - Cluster detail map renders the polygon boundary (not a circle)
- [âœ“] 2026-02-11 03:04 - Deleting a cluster removes it from the list and unassigns its leads
- [âœ“] 2026-02-11 03:07 - No "Auto-generate Clusters" button exists anywhere
- [âœ“] 2026-02-11 03:07 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 03:08 - `pnpm lint` passes
- [âœ“] 2026-02-11 15:00 - Create `convex/discovery/placeHelpers.ts` â€” extract from `convex/discovery/discoverLeads.ts`: `PlaceTextResult` type, `DiscoveredLead` type, `normalizeDedupValue`, `normalizeDedupName`, `dedupKeyForLead`, `extractCity`, `inferLeadType`, `searchPlaces` function, and `discoveredLeadValidator`. Export all of them.
- [âœ“] 2026-02-11 15:01 - Add `discoveryGrids` table to `convex/schema.ts` â€” fields: `name: v.string()`, `region: v.string()`, `province: v.string()` (explicit geographic fields mapped to all leads created from this grid), `queries: v.array(v.string())`, `swLat: v.number()`, `swLng: v.number()`, `neLat: v.number()`, `neLng: v.number()`, `cellSizeKm: v.number()`, `totalLeadsFound: v.number()` (running count, incremented as cells are searched), `createdAt: v.number()`. No separate `gridId` string â€” use the Convex-generated `_id` as the foreign key everywhere.
- [âœ“] 2026-02-11 15:09 - Add `discoveryCells` table to `convex/schema.ts` â€” fields: `swLat: v.number()`, `swLng: v.number()`, `neLat: v.number()`, `neLng: v.number()`, `depth: v.number()` (0 = 20km, 1 = 10km, etc.), `parentCellId: v.optional(v.id("discoveryCells"))`, `isLeaf: v.boolean()` (true by default, set to false when subdivided â€” avoids expensive leaf detection at query time), `status: v.union(v.literal("unsearched"), v.literal("searched"), v.literal("saturated"), v.literal("searching"))`, `resultCount: v.optional(v.number())`, `querySaturation: v.optional(v.array(v.object({ query: v.string(), count: v.number() })))` (per-query result counts so user can see which queries are saturated), `lastSearchedAt: v.optional(v.number())`, `gridId: v.id("discoveryGrids")`. Add indexes: `by_gridId` on `["gridId"]`, `by_gridId_isLeaf` on `["gridId", "isLeaf"]`, `by_parentCellId` on `["parentCellId"]`.
- [âœ“] 2026-02-11 15:11 - Add `by_placeId` index to the existing `leads` table in `convex/schema.ts` â€” index on `["placeId"]`. This replaces the full-table-scan dedup in `insertDiscoveredLeads` with index lookups.
- [âœ“] 2026-02-11 15:13 - Export `haversineKm` from `convex/lib/pointInPolygon.ts` â€” add the `export` keyword to the existing function on line 73.
- [âœ“] 2026-02-11 15:21 - Update `convex/discovery/discoverLeads.ts` â€” import the extracted types and helpers from `./placeHelpers` instead of defining them locally. Rewrite `insertDiscoveredLeads` to use index-based dedup instead of full table scan: for each incoming lead, query `leads` by `by_placeId` index (if `placeId` present) and by `by_name` index + filter by city (for name+city dedup). Only insert if no match found. This eliminates the `ctx.db.query("leads").collect()` full scan that would become expensive with per-cell discovery. Verify `discoverLeads` action still works after refactor.
- [âœ“] 2026-02-11 15:26 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 15:30 - Existing `discoverLeads` action behavior unchanged (no regression from dedup refactor)
- [âœ“] 2026-02-11 15:32 - Create `convex/discovery/gridCells.ts` with `generateGrid` mutation â€” takes `{ name, region, province, queries?, swLat, swLng, neLat, neLng, cellSizeKm? }`. Creates a `discoveryGrids` record (with `totalLeadsFound: 0`) and generates cells with `isLeaf: true`. Use degree approximation for grid tiling: `latStep = cellSizeKm / 111`, `lngStep = cellSizeKm / (111 * cos(midLat))`. Default `cellSizeKm` to 20. Default `queries` to `["farms", "farmers market", "orchard", "farm stand", "pick your own"]`. Uses the new grid's `_id` as the `gridId` foreign key on all cells.
- [âœ“] 2026-02-11 15:35 - Add `subdivideCell` mutation to `convex/discovery/gridCells.ts` â€” takes `{ cellId }`. Guards: (1) cell status must be `"saturated"`, (2) `depth < 4` (max depth, ~1.25km), (3) query `by_parentCellId` index to check no children exist already â€” if children found, throw error to prevent duplicate subdivision. Splits cell into 4 quadrants at the midpoint. Creates 4 child cells with `depth + 1`, `parentCellId` set to original, `isLeaf: true`, status `"unsearched"`. Patches the parent cell to set `isLeaf: false`.
- [âœ“] 2026-02-11 15:36 - Add `listCells` query to `convex/discovery/gridCells.ts` â€” takes `{ gridId: v.id("discoveryGrids") }`. Query `by_gridId_isLeaf` index with `gridId` and `isLeaf: true`. Return fields: `_id`, `swLat`, `swLng`, `neLat`, `neLng`, `depth`, `status`, `resultCount`, `querySaturation`, `lastSearchedAt`.
- [âœ“] 2026-02-11 15:38 - Add `listGrids` query to `convex/discovery/gridCells.ts` â€” returns all `discoveryGrids` records. For each grid, query cells `by_gridId_isLeaf` (isLeaf: true) and compute summary stats: total leaf cells, searched count, saturated count. Include `totalLeadsFound` from the grid record.
- [âœ“] 2026-02-11 15:40 - Add `updateGridQueries` mutation to `convex/discovery/gridCells.ts` â€” takes `{ gridId: v.id("discoveryGrids"), queries: string[] }`. Patches the `queries` array on the grid record.
- [âœ“] 2026-02-11 15:42 - Add `claimCellForSearch` internalMutation to `convex/discovery/gridCells.ts` â€” takes `{ cellId, expectedStatuses: string[] }`. Atomically reads the cell, verifies `cell.status` is in `expectedStatuses` (e.g. `["unsearched", "searched"]`), and patches to `"searching"`. Returns `{ previousStatus: string }` on success. Throws if status doesn't match (another action already claimed it). This is a single mutation so Convex's transaction guarantees prevent races.
- [âœ“] 2026-02-11 15:45 - Add remaining internal helpers to `convex/discovery/gridCells.ts` â€” `getCell` internalQuery (returns cell + its parent grid record including queries, region, province), `updateCellStatus` internalMutation (sets status field â€” used for failure rollback), `updateCellSearchResult` internalMutation (sets status, resultCount, querySaturation, lastSearchedAt, and increments the parent grid's `totalLeadsFound` by the new leads count).
- [âœ“] 2026-02-11 15:48 - Add `deleteGrid` as an internalAction in `convex/discovery/gridCells.ts` â€” batched deletion to avoid Convex transaction limits on large grids. Loop: query up to 500 cells with matching `gridId`, delete them in a batch via an internalMutation, repeat until no cells remain, then delete the `discoveryGrids` record. Expose a public mutation `requestDeleteGrid` that calls `ctx.scheduler.runAfter(0, internal.discovery.gridCells.deleteGrid, { gridId })` so the UI gets an immediate response.
- [âœ“] 2026-02-11 15:56 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 16:00 - Can call `generateGrid` via Convex dashboard with Niagara bbox `(42.85, -79.90)` to `(43.35, -78.80)`, region `"Niagara"`, province `"ON"`, and see ~12 cells created, all with `isLeaf: true`
- [âœ“] 2026-02-11 16:03 - Can call `subdivideCell` on a saturated cell and see 4 children created with `isLeaf: true`, parent patched to `isLeaf: false`
- [âœ“] 2026-02-11 16:06 - Calling `subdivideCell` again on the same cell throws an error (duplicate guard)
- [âœ“] 2026-02-11 16:10 - `listCells` returns only leaf cells via index (no post-filtering)
- [âœ“] 2026-02-11 16:12 - `claimCellForSearch` succeeds on first call, throws on concurrent second call for the same cell
- [âœ“] 2026-02-11 16:18 - Create `convex/discovery/discoverCell.ts` with `discoverCell` action â€” takes `{ cellId }`. Full steps: (1) call `claimCellForSearch` internalMutation with `expectedStatuses: ["unsearched", "searched"]` â€” this atomically checks the cell isn't already being searched and transitions to `"searching"`, returning `{ previousStatus }`. If it throws, the cell was already claimed; surface error to caller, (2) fetch cell + grid record via `getCell` internal query to get bounds, queries, region, province, (3) **wrap steps 4-11 in try/catch â€” on ANY failure, reset cell status to `previousStatus` via `updateCellStatus` before re-throwing**, (4) compute cell center lat/lng and **circumscribed** circle radius using `haversineKm` â€” measure from cell center to a corner (not inscribed; circumscribed covers the entire cell including corners so no places are missed at cell edges), (5) for each query string in the grid's queries list call `searchPlacesWithLocation` with the cell's center + radius, tracking per-query result count, (6) deduplicate all results across queries by `place_id`, (7) post-filter to cell bounds (discard results where lat/lng falls outside the cell's sw/ne box â€” necessary because radius is a bias not a hard filter, and circumscribed radius extends beyond cell bounds), (8) convert to lead objects using `inferLeadType` and `extractCity` from `placeHelpers.ts`, set `region` and `province` from the grid record's explicit fields, set `sourceDetail` to `"Discovery grid cell [depth={depth}]"`, (9) insert via the refactored `insertDiscoveredLeads` mutation (now index-based dedup), (10) determine saturation: mark `"saturated"` only if **every** query returned 60 results (if only some queries hit 60, there may still be room â€” avoid over-subdivision from one niche query hitting 60 while others return few), (11) update cell via `updateCellSearchResult` with status, resultCount (in-bounds deduplicated total), `querySaturation` array (per-query counts), timestamp, and newLeads count for grid total increment, (12) return `{ totalApiResults, inBoundsResults, newLeads, duplicatesSkipped, saturated, querySaturation }`.
- [âœ“] 2026-02-11 16:22 - Add `searchPlacesWithLocation` helper in `discoverCell.ts` â€” wraps the existing `searchPlaces` pattern from `placeHelpers.ts` but appends `&location={lat},{lng}&radius={radius}` to the URL. Fetches up to 3 pages (60 results max). For page token pagination: initial delay of 2s, then on `INVALID_REQUEST` status (token not yet ready), retry up to 3 times with exponential backoff (2s, 4s, 8s) before giving up on that page. Returns `{ results: PlaceTextResult[], totalCount: number }` so the caller can check saturation per query.
- [âœ“] 2026-02-11 16:28 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 16:33 - Can call `discoverCell` from Convex dashboard on an unsearched cell and see leads created in the leads table
- [âœ“] 2026-02-11 16:38 - Cell status updates to `"searched"` or `"saturated"` correctly
- [âœ“] 2026-02-11 16:42 - `querySaturation` field shows per-query result counts on the cell
- [âœ“] 2026-02-11 16:45 - Leads have correct `sourceDetail` referencing the cell and correct `region`/`province` from the grid
- [âœ“] 2026-02-11 16:49 - Multiple queries all execute and results are deduped by placeId across queries
- [âœ“] 2026-02-11 16:53 - If the action errors mid-flight, cell status resets to previous state (not stuck on `"searching"`)
- [âœ“] 2026-02-11 16:58 - Re-searching a `"searched"` cell works (updates counts, finds new leads if queries changed)
- [âœ“] 2026-02-11 17:05 - Two concurrent `discoverCell` calls on the same cell: first succeeds, second fails with claim error
- [âœ“] 2026-02-11 17:06 - Create `src/components/map/cell-colors.ts` â€” export a `getCellColor(status)` function. Colors: `unsearched` â†’ `#9ca3af` (gray), `searching` â†’ `#3b82f6` (blue), `searched` â†’ `#22c55e` (green), `saturated` â†’ `#f97316` (orange). Return `{ color, fillColor, fillOpacity }` object for each status.
- [âœ“] 2026-02-11 17:09 - Create `src/components/map/discovery-grid.tsx` â€” import `Rectangle` and `Tooltip` from `react-leaflet`. Takes props `{ cells: CellData[], onCellClick: (cellId: string) => void }`. Renders a `<Rectangle>` for each cell with bounds `[[swLat, swLng], [neLat, neLng]]`, pathOptions from `getCellColor(cell.status)`, and click eventHandler calling `onCellClick`. Add a `<Tooltip>` showing status and result count (e.g. "Searched â€” 34 results" or "Unsearched"). For saturated cells, also show which queries hit 60 from `querySaturation`.
- [âœ“] 2026-02-11 17:11 - Create `src/components/map/map-bounds-emitter.tsx` â€” a component rendered inside `MapContainer` that uses `useMap()` + `useMapEvents` to listen for `moveend`/`zoomend` events and calls an `onBoundsChange(bounds: { swLat, swLng, neLat, neLng })` callback prop with the current viewport bounds. This bridges the gap between the Leaflet map instance (only accessible inside MapContainer) and the parent page state.
- [âœ“] 2026-02-11 17:13 - Add grid + bounds props to `src/components/map/map-content.tsx` â€” extend `MapContentProps` with optional `gridCells`, `onCellClick`, and `onBoundsChange`. Import and render `DiscoveryGrid` when `gridCells` provided. Import and render `MapBoundsEmitter` when `onBoundsChange` provided.
- [âœ“] 2026-02-11 17:15 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 17:15 - `pnpm lint` passes
- [âœ“] 2026-02-11 17:18 - Map renders without errors when no `gridCells` provided (existing behavior preserved)
- [âœ“] 2026-02-11 17:21 - `onBoundsChange` fires with correct viewport coordinates when panning/zooming
- [âœ“] 2026-02-11 17:23 - Add view mode toggle to `src/app/map/page.tsx` â€” add `viewMode` state: `"clusters" | "discovery"`, default `"clusters"`. Add a toggle button in the top-right `div` next to the Draw Cluster button. Use `Grid3X3` icon from lucide-react. Label: "Discovery" when in clusters mode, "Clusters" when in discovery mode. When `viewMode === "discovery"`: hide the Draw Cluster button, hide cluster polygons from MapContent (pass empty `clusters` array), show grid cells on MapContent.
- [âœ“] 2026-02-11 17:25 - Add `mapBounds` state to `src/app/map/page.tsx` â€” `useState<{ swLat, swLng, neLat, neLng } | null>(null)`. Pass `onBoundsChange` callback to `MapContent` that updates this state. This gives the discovery panel access to the current viewport for pre-filling the "New Grid" form.
- [âœ“] 2026-02-11 17:31 - Create `src/components/map/discovery-panel.tsx` â€” left sidebar panel (same position as `MapFilters`, rendered conditionally). Takes `mapBounds` as a prop. Contains: (1) grid selector dropdown if multiple grids exist, (2) "New Grid" form if no grid exists or user wants another â€” inputs for grid name, region, province, and bounding box coordinates pre-filled from `mapBounds` prop (user pans/zooms to target area, then clicks "Create Grid"), (3) progress stats showing searched/total leaf cells, saturated cells needing subdivision, and `totalLeadsFound` from the grid record, (4) editable search queries list â€” display current queries as removable chips/tags, text input to add new query, save calls `updateGridQueries` mutation, (5) color legend for cell statuses.
- [âœ“] 2026-02-11 17:35 - Wire discovery queries and actions in `src/app/map/page.tsx` â€” add `useQuery(api.discovery.gridCells.listCells, { gridId })` (conditional on selected grid) and `useQuery(api.discovery.gridCells.listGrids)`. Add `useAction(api.discovery.discoverCell.discoverCell)` and `useMutation(api.discovery.gridCells.subdivideCell)`. Implement `handleCellClick`: if cell is `"unsearched"` or `"searched"` â†’ call `discoverCell` action in a try/catch, show success toast with results on success (include per-query saturation info if any queries hit 60), show error toast on failure. If cell is `"saturated"` â†’ call `subdivideCell` in a try/catch, show success toast on success, show error toast on failure (e.g. "Already subdivided" or "Max depth reached"). If cell is `"searching"` â†’ no-op (optionally show info toast "Search already in progress"). Pass `gridCells` and `handleCellClick` to `MapContent`. Render `<DiscoveryPanel>` instead of `<MapFilters>` when `viewMode === "discovery"`.
- [âœ“] 2026-02-11 17:42 - Map page renders without errors in both cluster and discovery modes
- [âœ“] 2026-02-11 17:46 - Toggle switches between cluster and discovery views correctly
- [âœ“] 2026-02-11 17:50 - Can create a new grid from current map viewport bounds with explicit region/province
- [âœ“] 2026-02-11 17:54 - Clicking an unsearched cell triggers discovery, cell turns green (or orange if saturated)
- [âœ“] 2026-02-11 17:58 - Clicking a saturated cell subdivides into 4 smaller cells
- [âœ“] 2026-02-11 18:05 - Failed operations show error toasts with meaningful messages
- [âœ“] 2026-02-11 18:09 - Lead markers visible in both modes
- [âœ“] 2026-02-11 18:13 - Editing search queries in the panel persists and next cell search uses the updated queries
- [âœ“] 2026-02-11 18:17 - Grid stats panel shows accurate searched/total/leads counts
- [âœ“] 2026-02-11 18:17 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 18:18 - `pnpm lint` passes
- [âœ“] 2026-02-11 21:06 - In `convex/discovery/gridCells.ts` `subdivideCell` mutation (line 94-96): change the status guard from requiring `cell.status !== "saturated"` to only blocking `cell.status === "searching"`. New error message: `"Cannot subdivide while cell is being searched"`. This allows subdividing unsearched, searched, or saturated cells â€” giving the user manual control over grid granularity.
- [âœ“] 2026-02-11 21:07 - In `convex/discovery/discoverCell.ts` `requestDiscoverCell` mutation (line 222): add `"saturated"` to the allowed statuses check. Change from `cell.status !== "unsearched" && cell.status !== "searched"` to also allow `"saturated"`. Update the error message to list all three allowed statuses.
- [âœ“] 2026-02-11 21:09 - In `convex/discovery/discoverCell.ts` `discoverCell` internal action (line 41): add `"saturated"` to the `expectedStatuses` array passed to `claimCellForSearch`. Change from `["unsearched", "searched"]` to `["unsearched", "searched", "saturated"]`.
- [âœ“] 2026-02-11 21:09 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 21:14 - Can re-search a saturated cell from Convex dashboard (call `requestDiscoverCell` on a saturated cell ID)
- [âœ“] 2026-02-11 21:21 - Can subdivide a searched (non-saturated) cell from Convex dashboard
- [âœ“] 2026-02-11 21:23 - In `convex/discovery/gridCells.ts` `listCells` query (line 212-223): add `parentCellId: cell.parentCellId` to the returned object mapping. The field already exists in the schema, it's just not projected into the response.
- [âœ“] 2026-02-11 21:26 - Add `undivideCell` public mutation to `convex/discovery/gridCells.ts` (after the `subdivideCell` mutation, after line 139). Takes `{ cellId: v.id("discoveryCells") }`. Implementation: (1) fetch the cell, throw if not found, (2) read `cell.parentCellId`, throw `"Cell has no parent to undivide"` if missing, (3) fetch the parent cell, throw if not found, (4) BFS-walk all descendants of the parent using the `by_parentCellId` index â€” start a queue with `parentCellId`, for each item query children, push child IDs to queue and to a `toDelete` array, (5) guard: if any descendant has `status === "searching"`, throw `"Cannot undivide while a child cell is being searched"`, (6) delete all collected descendants, (7) patch the parent cell to set `isLeaf: true` (leave its existing `status`, `resultCount`, `querySaturation` intact), (8) return `{ deletedCount }`.
- [âœ“] 2026-02-11 21:26 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 21:28 - `listCells` response now includes `parentCellId` field (undefined for root cells, set for subdivided children)
- [âœ“] 2026-02-11 21:32 - Can undivide a subdivided cell from Convex dashboard â€” children disappear, parent becomes a leaf again with its original status
- [âœ“] 2026-02-11 21:35 - Undividing when a child is currently searching throws an error
- [âœ“] 2026-02-11 21:38 - Undividing a root cell (no parent) throws an error
- [âœ“] 2026-02-11 21:40 - In `src/components/map/discovery-grid.tsx`: add `parentCellId?: string` to the `CellData` type.
- [âœ“] 2026-02-11 21:46 - In `src/components/map/discovery-grid.tsx`: replace the `onCellClick: (cellId: string) => void` prop with `onCellAction: (cellId: string, action: CellAction) => void` where `CellAction` is a discriminated union type: `{ type: "search"; mechanism: string } | { type: "subdivide" } | { type: "undivide" }`. Export the `CellAction` type.
- [âœ“] 2026-02-11 21:47 - In `src/components/map/discovery-grid.tsx`: add a `DISCOVERY_MECHANISMS` constant array: `[{ id: "google_places", label: "Google Places", enabled: true }, { id: "web_scraper", label: "Web Scraping", enabled: false }]`.
- [âœ“] 2026-02-11 21:49 - In `src/components/map/discovery-grid.tsx`: add a `getAvailableActions` helper function that takes a `CellData` and returns which actions are available. If `cell.status === "searching"`, return empty (no actions). Otherwise: Search is always available for enabled mechanisms, Subdivide is available if `cell.depth < MAX_DEPTH`, Undivide (Merge) is available if `cell.parentCellId` exists.
- [âœ“] 2026-02-11 21:54 - In `src/components/map/discovery-grid.tsx`: replace the plain text `formatTooltip` function with a `CellTooltipContent` React component. This component renders inside `<Tooltip interactive>` on each Rectangle. Layout: (1) top line shows cell status badge and result count (e.g. "Searched â€” 45 results"), (2) mechanism rows section â€” for each mechanism in `DISCOVERY_MECHANISMS`, show a row with: mechanism label, last-run date formatted as short date (for `google_places` use `cell.lastSearchedAt`, for `web_scraper` show "â€”"), and a small "Run" button (Play icon from lucide-react). The Run button calls `onCellAction(cellId, { type: "search", mechanism: id })`. Disable the button (reduced opacity, `pointer-events-none`) if `!mechanism.enabled` or `cell.status === "searching"`. (3) bottom row shows Split and Merge buttons â€” Split button (Grid2x2Plus icon + "Split" label) calls `onCellAction(cellId, { type: "subdivide" })`, hidden if `cell.depth >= MAX_DEPTH`. Merge button (Minimize2 icon + "Merge" label) calls `onCellAction(cellId, { type: "undivide" })`, hidden if no `cell.parentCellId`. Both hidden entirely if `cell.status === "searching"`. Use `e.stopPropagation()` on all button clicks to prevent event bubbling to the map.
- [âœ“] 2026-02-11 21:57 - In `src/components/map/discovery-grid.tsx`: update the Rectangle rendering. Remove the `eventHandlers={{ click: () => onCellClick(cell._id) }}` prop. Replace the existing `<Tooltip>{formatTooltip(cell)}</Tooltip>` with `<Tooltip interactive className="..." direction="top" offset={[0, -10]}>`. Override Leaflet default tooltip styles via `className` using Tailwind `!important` modifiers: `"!bg-card !border !border-border !rounded-lg !shadow-md !px-2.5 !py-2 !text-foreground"`. Render `<CellTooltipContent>` as the tooltip child.
- [âœ“] 2026-02-11 21:59 - Style the tooltip buttons as small, compact controls â€” use `inline-flex items-center gap-1 rounded-md border px-1.5 py-0.5 text-xs hover:bg-accent transition-colors` on each button. Keep the overall tooltip compact so it doesn't obscure too much of the map.
- [âœ“] 2026-02-11 22:00 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 22:03 - `pnpm lint` passes
- [âœ“] 2026-02-11 22:07 - Hovering a cell shows the interactive tooltip with mechanism rows and action buttons
- [âœ“] 2026-02-11 22:10 - Tooltip stays open when moving mouse from the cell to the tooltip (interactive mode working)
- [âœ“] 2026-02-11 22:14 - Tooltip closes when mouse leaves both the cell and tooltip
- [âœ“] 2026-02-11 22:18 - Buttons inside the tooltip are clickable
- [âœ“] 2026-02-11 22:22 - Web Scraping row shows as disabled with "â€”" for date
- [âœ“] 2026-02-11 22:25 - Split button hidden on cells at max depth (depth 4)
- [âœ“] 2026-02-11 22:30 - Merge button hidden on root cells (no parentCellId)
- [âœ“] 2026-02-11 22:34 - No buttons shown on cells with status "searching"
- [âœ“] 2026-02-11 22:35 - In `src/components/map/map-content.tsx`: replace the `onCellClick?: (cellId: string) => void` prop with `onCellAction?: (cellId: string, action: CellAction) => void`. Import the `CellAction` type from `./discovery-grid`. Update the conditional render of `<DiscoveryGrid>` to pass `onCellAction` instead of `onCellClick`.
- [âœ“] 2026-02-11 22:36 - In `src/app/map/page.tsx`: add `const undivideCell = useMutation(api.discovery.gridCells.undivideCell)` alongside the existing discovery mutation hooks.
- [âœ“] 2026-02-11 22:40 - In `src/app/map/page.tsx`: replace the `handleCellClick` callback with a `handleCellAction` callback. It takes `(cellId: string, action: CellAction)` and switches on `action.type`: (1) `"search"` â€” if `action.mechanism === "google_places"`, call `requestDiscoverCell({ cellId })` with try/catch and toast. For any other mechanism value, show `toast.info("Coming soon")`. (2) `"subdivide"` â€” call `subdivideCell({ cellId })` with try/catch and toast. (3) `"undivide"` â€” call `undivideCell({ cellId })` with try/catch, toast success "Cell merged back to parent", toast error on failure. Update the dependency array to include `undivideCell`.
- [âœ“] 2026-02-11 22:41 - In `src/app/map/page.tsx`: update the `MapContent` usage â€” change prop from `onCellClick={viewMode === "discovery" ? handleCellClick : undefined}` to `onCellAction={viewMode === "discovery" ? handleCellAction : undefined}`.
- [âœ“] 2026-02-11 22:50 - `pnpm typecheck` passes
- [âœ“] 2026-02-11 22:51 - `pnpm lint` passes
- [âœ“] 2026-02-11 22:54 - Hovering a cell and clicking Google Places "Run" triggers discovery â€” cell turns blue (searching), then green/orange on completion
- [âœ“] 2026-02-11 22:58 - Last-run date appears on the Google Places row after search completes
- [âœ“] 2026-02-11 23:01 - Clicking "Split" on a non-searching cell subdivides into 4 quadrants
- [âœ“] 2026-02-11 23:04 - Clicking "Split" on an unsearched cell works (relaxed constraint)
- [âœ“] 2026-02-11 23:09 - Clicking "Merge" on a child cell collapses all siblings back to parent â€” parent reappears with its original status
- [âœ“] 2026-02-11 23:12 - Clicking "Merge" when a sibling is searching shows error toast
- [âœ“] 2026-02-11 23:17 - Clicking Web Scraping "Run" shows "Coming soon" toast
- [âœ“] 2026-02-11 23:19 - No auto-action on cell click â€” clicking the cell rectangle itself does nothing
- [âœ“] 2026-02-11 23:24 - Existing discovery panel, grid stats, and query editing still work correctly
- [âœ“] 2026-02-12 01:33 - In `src/components/map/discovery-grid.tsx`: remove the `CellTooltipContent` component (lines 73-151), the `TOOLTIP_CLOSE_DELAY` constant (line 154), and the entire current `DiscoveryGridCell` component (lines 156-251). Remove unused imports: `useCallback`, `useEffect`, `useRef`, `useState` from react, `Tooltip` and `useMap` from react-leaflet, `L` from leaflet, `Play`, `Grid2x2Plus`, `Minimize2` from lucide-react. Keep imports: `Rectangle` from react-leaflet, `getCellColor` from `./cell-colors`, `CellStatus` type from `./cell-colors`.
- [âœ“] 2026-02-12 01:34 - In `src/components/map/discovery-grid.tsx`: export the three previously-private helpers so the discovery panel can import them. Change `const MAX_DEPTH = 4` to `export const MAX_DEPTH = 4`. Change `function formatShortDate` to `export function formatShortDate`. Change `function getStatusBadgeColor` to `export function getStatusBadgeColor`.
- [âœ“] 2026-02-12 01:40 - In `src/components/map/discovery-grid.tsx`: change the `DiscoveryGridProps` type from `{ cells: CellData[], onCellAction: (cellId: string, action: CellAction) => void }` to `{ cells: CellData[], selectedCellId: string | null, onCellSelect: (cellId: string | null) => void }`.
- [âœ“] 2026-02-12 01:43 - In `src/components/map/discovery-grid.tsx`: create a new simplified `DiscoveryGridCell` component. Props: `{ cell: CellData, isSelected: boolean, onCellSelect: (cellId: string | null) => void }`. It renders a single `<Rectangle>` with: bounds from cell coords, `pathOptions` from `getCellColor(cell.status)` but when `isSelected` override with `{ ...basePathOptions, weight: 3, dashArray: "6 4", color: "#2563eb", fillOpacity: (basePathOptions.fillOpacity ?? 0.15) + 0.1 }`, and a click event handler that calls `onCellSelect(isSelected ? null : cell._id)` (toggle selection). No Tooltip, no hover handlers, no refs, no timers.
- [âœ“] 2026-02-12 01:44 - In `src/components/map/discovery-grid.tsx`: update the default export `DiscoveryGrid` component to accept the new props `{ cells, selectedCellId, onCellSelect }` and render `DiscoveryGridCell` for each cell passing `isSelected={cell._id === selectedCellId}` and `onCellSelect`.
- [âœ“] 2026-02-12 01:44 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 01:52 - `discovery-grid.tsx` has no `Tooltip` import, no `CellTooltipContent`, no `TOOLTIP_CLOSE_DELAY`, no `useMap`, no leaflet `L` import
- [âœ“] 2026-02-12 01:55 - `discovery-grid.tsx` exports: `CellAction`, `CellData`, `DISCOVERY_MECHANISMS`, `MAX_DEPTH`, `getAvailableActions`, `formatShortDate`, `getStatusBadgeColor`, default `DiscoveryGrid`
- [âœ“] 2026-02-12 01:56 - In `src/components/map/map-content.tsx`: replace the `onCellAction?: (cellId: string, action: CellAction) => void` prop with two new props: `selectedCellId?: string | null` and `onCellSelect?: (cellId: string | null) => void`. Remove the `CellAction` import from `./discovery-grid` (keep `CellData` import). Update the `MapContentProps` type accordingly.
- [âœ“] 2026-02-12 01:57 - In `src/components/map/map-content.tsx`: update the DiscoveryGrid conditional render â€” change `{gridCells && onCellAction && (` to `{gridCells && onCellSelect && (`. Pass the new props to `<DiscoveryGrid>`: `cells={gridCells}`, `selectedCellId={selectedCellId ?? null}`, `onCellSelect={onCellSelect}`.
- [âœ“] 2026-02-12 01:58 - In `src/components/map/map-content.tsx`: update the default export function signature to destructure the new props `selectedCellId` and `onCellSelect` instead of `onCellAction`.
- [âœ“] 2026-02-12 01:58 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 01:59 - In `src/app/map/page.tsx`: add `const [selectedCellId, setSelectedCellId] = useState<string | null>(null)` state alongside the existing `selectedGridId` state.
- [âœ“] 2026-02-12 02:01 - In `src/app/map/page.tsx`: add a `handleCellSelect` callback: `const handleCellSelect = useCallback((cellId: string | null) => { setSelectedCellId(cellId) }, [])`.
- [âœ“] 2026-02-12 02:02 - In `src/app/map/page.tsx`: clear selection when switching grids â€” add a `useEffect` that calls `setSelectedCellId(null)` when `selectedGridId` changes: `useEffect(() => { setSelectedCellId(null) }, [selectedGridId])`.
- [âœ“] 2026-02-12 02:03 - In `src/app/map/page.tsx`: clear selection when switching view modes â€” in the view mode toggle button's `onClick` handler (line 248-253), add `setSelectedCellId(null)` after the existing cleanup calls.
- [âœ“] 2026-02-12 02:05 - In `src/app/map/page.tsx`: clear selection after subdivide and undivide â€” in the `handleCellAction` callback, add `setSelectedCellId(null)` after each successful `subdivideCell` call (after the success toast) and after each successful `undivideCell` call (after the success toast).
- [âœ“] 2026-02-12 02:06 - In `src/app/map/page.tsx`: update the `<MapContent>` props â€” replace `onCellAction={viewMode === "discovery" ? handleCellAction : undefined}` with `selectedCellId={viewMode === "discovery" ? selectedCellId : null}` and `onCellSelect={viewMode === "discovery" ? handleCellSelect : undefined}`.
- [âœ“] 2026-02-12 02:07 - In `src/app/map/page.tsx`: update the `<DiscoveryPanel>` usage â€” add three new props: `cells={viewMode === "discovery" ? gridCells ?? [] : []}`, `selectedCellId={selectedCellId}`, `onCellAction={handleCellAction}`.
- [âœ“] 2026-02-12 02:08 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 02:09 - In `src/components/map/discovery-panel.tsx`: add new imports â€” `Play`, `Grid2x2Plus`, `Minimize2` from `lucide-react`; `CellData`, `CellAction`, `DISCOVERY_MECHANISMS`, `MAX_DEPTH`, `getStatusBadgeColor`, `formatShortDate` from `./discovery-grid`.
- [âœ“] 2026-02-12 02:10 - In `src/components/map/discovery-panel.tsx`: extend the `DiscoveryPanelProps` type with three new fields: `cells: CellData[]`, `selectedCellId: string | null`, `onCellAction: (cellId: string, action: CellAction) => void`. Update the function signature to destructure these new props.
- [âœ“] 2026-02-12 02:10 - In `src/components/map/discovery-panel.tsx`: derive the selected cell from props at the top of the component body: `const selectedCell = cells.find((c) => c._id === selectedCellId) ?? null`.
- [âœ“] 2026-02-12 02:12 - In `src/components/map/discovery-panel.tsx`: add a "Selected Cell" section between the Progress Stats section and the Search Queries section (after the closing `</>` of the Progress Stats conditional block, before the `{/* Search Queries */}` comment). Only render when `selectedCell && !showNewGridForm`. Wrap in `<>` with a `<Separator />`. Layout: (1) `Label` showing "Selected Cell" in `text-xs text-muted-foreground`, (2) status row with status badge (using `getStatusBadgeColor`), result count if not unsearched, and depth indicator aligned right, (3) mechanism rows â€” for each item in `DISCOVERY_MECHANISMS`, show label, last-run date (using `formatShortDate` for google_places with `selectedCell.lastSearchedAt`, "â€”" otherwise), and a small Run button with Play icon that calls `onCellAction(selectedCell._id, { type: "search", mechanism: mechanism.id })`. Disable button if `!mechanism.enabled` or `selectedCell.status === "searching"`. Apply `opacity-50` to disabled mechanisms row. (4) Split/Merge row â€” Split button (Grid2x2Plus icon + "Split") calls `onCellAction(selectedCell._id, { type: "subdivide" })`, disabled if `selectedCell.depth >= MAX_DEPTH` or searching. Merge button (Minimize2 icon + "Merge") only shown if `selectedCell.depth > 0`, calls `onCellAction(selectedCell._id, { type: "undivide" })`, disabled if searching. (5) If `selectedCell.querySaturation` exists and has entries, show per-query saturation list with query name and count.
- [âœ“] 2026-02-12 02:15 - Style all buttons in the selected cell section consistently: `inline-flex items-center gap-1 rounded-md border px-1.5 py-0.5 text-xs hover:bg-accent transition-colors`. Disabled buttons get `opacity-50 cursor-not-allowed`. Use `e.stopPropagation()` is NOT needed here (sidebar, not map overlay).
- [âœ“] 2026-02-12 02:15 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 02:18 - `pnpm lint` passes
- [âœ“] 2026-02-12 02:18 - In `src/app/globals.css`: delete the tooltip bridge CSS block (lines 128-143) â€” the comment starting with `/* Leaflet tooltip: enlarge the invisible bridge...` through the closing `}` of `.leaflet-tooltip-top::before`.
- [âœ“] 2026-02-12 02:18 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 02:19 - `pnpm lint` passes
- [âœ“] 2026-02-12 02:21 - Clicking a cell on the map highlights it with a blue dashed border
- [âœ“] 2026-02-12 02:24 - Discovery panel shows selected cell details with Run/Split/Merge buttons
- [âœ“] 2026-02-12 02:29 - Clicking Run on Google Places triggers discovery (cell turns blue)
- [âœ“] 2026-02-12 02:32 - Clicking Split subdivides the cell, selection clears
- [âœ“] 2026-02-12 02:36 - Clicking Merge collapses siblings, selection clears
- [âœ“] 2026-02-12 02:38 - Clicking the same cell again deselects it
- [âœ“] 2026-02-12 02:41 - Switching grids clears selection
- [âœ“] 2026-02-12 02:44 - Switching to Clusters mode and back clears selection
- [âœ“] 2026-02-12 02:44 - Delete the following 6 test files that test tooltip-specific behavior no longer present: `tests/discovery-grid-tooltip.test.mjs`, `tests/discovery-grid-tooltip-delayed-close.test.mjs`, `tests/discovery-grid-tooltip-hover.test.mjs`, `tests/discovery-grid-tooltip-clickable.test.mjs`, `tests/discovery-grid-tooltip-styling.test.mjs`, `tests/discovery-grid-no-cell-click-action.test.mjs`.
- [âœ“] 2026-02-12 02:45 - In `tests/discovery-grid-component.test.mjs`: remove any assertions about `Tooltip` import, `CellTooltipContent`, `mouseover`/`mouseout` handlers, `interactive` prop, or tooltip className. Add assertions that: (1) the component imports `Rectangle` from `react-leaflet`, (2) the props type includes `selectedCellId` and `onCellSelect`, (3) there is a click event handler on the Rectangle, (4) there is NO `Tooltip` import from `react-leaflet`.
- [âœ“] 2026-02-12 02:46 - In `tests/discovery-grid-cell-action.test.mjs`: update any assertions that reference `onCellAction` as a prop of `DiscoveryGrid` or `MapContent` â€” `DiscoveryGrid` now uses `onCellSelect`, and `MapContent` now uses `selectedCellId` + `onCellSelect`. The `CellAction` type itself is unchanged. The page handler (`handleCellAction`) is unchanged â€” just verify it still exists in `page.tsx`.
- [âœ“] 2026-02-12 02:46 - In `tests/discovery-grid-searching-buttons.test.mjs`: if this file asserts that Split/Merge buttons exist inside `CellTooltipContent` or `discovery-grid.tsx`, retarget those assertions to check `discovery-panel.tsx` instead. The `getAvailableActions` tests should remain unchanged.
- [âœ“] 2026-02-12 02:48 - In `tests/discovery-grid-split-button-max-depth.test.mjs`: retarget assertions from tooltip/`CellTooltipContent` in `discovery-grid.tsx` to the selected cell section in `discovery-panel.tsx`. The logic is the same (disabled when `depth >= MAX_DEPTH`), just lives in the panel now.
- [âœ“] 2026-02-12 02:49 - In `tests/discovery-grid-merge-button-root-cells.test.mjs`: retarget assertions from tooltip in `discovery-grid.tsx` to the selected cell section in `discovery-panel.tsx`. The logic is the same (hidden when no `parentCellId` / `depth === 0`), just lives in the panel now.
- [âœ“] 2026-02-12 02:51 - In `tests/discovery-grid-web-scraping-disabled.test.mjs`: retarget any assertions about disabled button styling from `discovery-grid.tsx` to `discovery-panel.tsx`. The `DISCOVERY_MECHANISMS` constant assertions should stay pointed at `discovery-grid.tsx` since it's still defined there.
- [âœ“] 2026-02-12 02:53 - In `tests/discovery-grid-web-scraping-coming-soon.test.mjs`: update any assertions that reference tooltip button dispatch to instead verify the panel dispatches `onCellAction`. The page handler "Coming soon" toast test should remain unchanged.
- [âœ“] 2026-02-12 02:53 - `pnpm test` passes â€” all discovery tests green
- [âœ“] 2026-02-12 02:55 - No test file references `CellTooltipContent`, `TOOLTIP_CLOSE_DELAY`, or `tooltip-hover`
- [âœ“] 2026-02-12 04:05 - Create `src/lib/virtual-grid.ts`. Export a `VirtualCell` type: `{ key: string, swLat: number, swLng: number, neLat: number, neLng: number }`. The `key` is a deterministic string from the snapped SW coordinates: `"${swLat.toFixed(6)}_${swLng.toFixed(6)}"`.
- [âœ“] 2026-02-12 04:08 - In `src/lib/virtual-grid.ts`: export a `computeVirtualGrid` function. Args: `bounds: { swLat: number, swLng: number, neLat: number, neLng: number }`, `cellSizeKm: number`, `maxCells?: number` (default 500). Returns `VirtualCell[]`. Algorithm: (1) compute `midLat = (bounds.swLat + bounds.neLat) / 2`, (2) `latStep = cellSizeKm / 111`, (3) `lngStep = cellSizeKm / (111 * Math.cos(midLat * Math.PI / 180))`, (4) snap start coordinates: `startLat = Math.floor(bounds.swLat / latStep) * latStep`, `startLng = Math.floor(bounds.swLng / lngStep) * lngStep`, (5) compute expected count before iterating: `rows = Math.ceil((bounds.neLat - startLat) / latStep)`, `cols = Math.ceil((bounds.neLng - startLng) / lngStep)` â€” if `rows * cols > maxCells`, return empty array, (6) iterate lat from `startLat` while `< bounds.neLat`, lng from `startLng` while `< bounds.neLng`, push a `VirtualCell` for each position with `neLat = lat + latStep`, `neLng = lng + lngStep`.
- [âœ“] 2026-02-12 04:09 - In `src/lib/virtual-grid.ts`: export a `computeBoundsKey` helper function. Args: `swLat: number, swLng: number, latStep: number, lngStep: number`. Returns `string`. Snaps the coordinates to the nearest grid-aligned position and returns the deterministic key: `const snappedLat = Math.floor(swLat / latStep) * latStep; const snappedLng = Math.floor(swLng / lngStep) * lngStep; return "${snappedLat.toFixed(6)}_${snappedLng.toFixed(6)}"`. This helper is used by the backend `activateCell` mutation and the frontend grid component to produce matching keys.
- [âœ“] 2026-02-12 04:09 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 04:10 - `computeVirtualGrid({ swLat: 43, swLng: -79.5, neLat: 43.5, neLng: -79 }, 20)` returns a non-empty array of cells that tile the bounds without gaps
- [âœ“] 2026-02-12 04:12 - `computeVirtualGrid` with same bounds called twice returns identical keys
- [âœ“] 2026-02-12 04:13 - `computeVirtualGrid` returns empty array when cell count exceeds `maxCells`
- [âœ“] 2026-02-12 04:23 - In `convex/schema.ts` `discoveryCells` table (line 179): add `boundsKey: v.string()` after the `gridId` field (before the closing of `defineTable`). This is required on all cells going forward â€” no optional needed since we're starting fresh.
- [âœ“] 2026-02-12 04:23 - In `convex/schema.ts` `discoveryCells` indexes (after line 202): add `.index("by_gridId_boundsKey", ["gridId", "boundsKey"])`.
- [âœ“] 2026-02-12 04:27 - In `convex/schema.ts` `discoveryGrids` table (lines 165-177): remove the four bounds fields entirely (`swLat`, `swLng`, `neLat`, `neLng`). Grids no longer have bounds â€” they're just query configurations.
- [âœ“] 2026-02-12 04:31 - `npx convex dev` runs without schema errors (or `pnpm convex:push` depending on the project's deploy command)
- [âœ“] 2026-02-12 04:31 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 04:38 - In `convex/discovery/gridCells.ts`: delete the `generateGrid` mutation entirely â€” it's replaced by `activateCell` + virtual grid. Also delete the `requestDeleteGrid` and `deleteGrid`/`deleteGridRecord`/`deleteCellBatch` functions â€” grid deletion is no longer needed with a single persistent global grid.
- [âœ“] 2026-02-12 04:40 - In `convex/discovery/gridCells.ts`: add an `activateCell` public mutation. Args: `{ gridId: v.id("discoveryGrids"), swLat: v.number(), swLng: v.number(), neLat: v.number(), neLng: v.number(), boundsKey: v.string() }`. Handler: (1) query `discoveryCells` using index `by_gridId_boundsKey` with `q.eq("gridId", args.gridId).eq("boundsKey", args.boundsKey)`, take `.first()`, (2) if found, return `{ cellId: existing._id, alreadyExisted: true }`, (3) if not found, insert a new `discoveryCells` document with `{ swLat: args.swLat, swLng: args.swLng, neLat: args.neLat, neLng: args.neLng, depth: 0, isLeaf: true, status: "unsearched", gridId: args.gridId, boundsKey: args.boundsKey }`, (4) return `{ cellId: newId, alreadyExisted: false }`.
- [âœ“] 2026-02-12 04:42 - In `convex/discovery/gridCells.ts`: add a `getOrCreateGlobalGrid` public mutation. Args: none. Handler: (1) query all `discoveryGrids` documents, take the first one, (2) if it exists, return `{ gridId: grid._id, created: false }`, (3) if no grids exist, insert a new `discoveryGrids` document with `{ name: "Discovery", region: "Ontario", province: "Ontario", queries: DEFAULT_QUERIES, cellSizeKm: DEFAULT_CELL_SIZE_KM, totalLeadsFound: 0, createdAt: Date.now() }` (no bounds fields â€” they're removed from the schema), (4) return `{ gridId: newId, created: true }`.
- [âœ“] 2026-02-12 04:47 - In `convex/discovery/gridCells.ts` `listCells` query (line 268-294): after the existing `cells` query that fetches leaf cells, add a second query to get all depth-0 boundsKeys for this grid: query `discoveryCells` with index `by_gridId` filtering for `depth === 0`, collect, then map to extract `boundsKey` values. Change the return value from the current `cells.map(...)` array to an object: `{ cells: cells.map(...existing mapping...), activatedBoundsKeys: depth0BoundsKeys }`. Include `boundsKey` in the per-cell mapping alongside the existing fields.
- [âœ“] 2026-02-12 04:47 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 04:49 - Calling `activateCell` twice with the same `boundsKey` returns the same `cellId` with `alreadyExisted: true` on the second call
- [âœ“] 2026-02-12 04:52 - `getOrCreateGlobalGrid` returns the existing grid if one exists, creates a new one otherwise
- [âœ“] 2026-02-12 04:56 - `listCells` returns an object with `cells` array and `activatedBoundsKeys` array
- [âœ“] 2026-02-12 04:57 - In `src/components/map/cell-colors.ts`: export a `VIRTUAL_CELL_STYLE` constant: `{ color: "#d1d5db", fillColor: "#d1d5db", fillOpacity: 0.05, weight: 0.5 }`. This is the path options object for unactivated virtual grid cells â€” faint gray gridlines.
- [âœ“] 2026-02-12 04:57 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 04:59 - In `src/components/map/discovery-grid.tsx`: add imports â€” `{ useState, useMemo, useCallback }` from `react`, `{ useMap, useMapEvents }` from `react-leaflet`, `{ computeVirtualGrid }` from `@/lib/virtual-grid`, `type { VirtualCell }` from `@/lib/virtual-grid`, `{ VIRTUAL_CELL_STYLE }` from `./cell-colors`.
- [âœ“] 2026-02-12 05:01 - In `src/components/map/discovery-grid.tsx`: extend the `DiscoveryGridProps` type with four new fields: `cellSizeKm: number`, `gridId: string`, `activatedBoundsKeys: string[]`, `onActivateCell: (cell: VirtualCell) => Promise<string>` (returns the new cell ID).
- [âœ“] 2026-02-12 05:03 - In `src/components/map/discovery-grid.tsx`: add a new `VirtualGridCell` component. Props: `{ cell: VirtualCell, onActivateCell: (cell: VirtualCell) => Promise<string>, onCellSelect: (cellId: string | null) => void }`. Renders a `<Rectangle>` with bounds from the virtual cell, `pathOptions={VIRTUAL_CELL_STYLE}`, and a click handler that: (1) calls `onActivateCell(cell)` to persist the cell, (2) on success calls `onCellSelect(cellId)` with the returned ID. Use an async click handler â€” set a local `activating` state to prevent double-clicks.
- [âœ“] 2026-02-12 05:07 - In `src/components/map/discovery-grid.tsx`: update the `DiscoveryGrid` default export component. Destructure the new props. Add `useMap()` to get the map instance. Add state: `const [mapBounds, setMapBounds] = useState<{swLat:number,swLng:number,neLat:number,neLng:number} | null>(null)`. Add `useMapEvents({ moveend: () => updateBounds(), zoomend: () => updateBounds() })` where `updateBounds` reads `map.getBounds()` and converts to `{ swLat, swLng, neLat, neLng }`. Also call `updateBounds` on initial mount via a `useEffect` that runs once. Compute virtual cells: `const virtualCells = useMemo(() => { if (!mapBounds || map.getZoom() < 8) return []; return computeVirtualGrid(mapBounds, cellSizeKm) }, [mapBounds, cellSizeKm])`. Build activated set: `const activatedSet = useMemo(() => new Set(activatedBoundsKeys), [activatedBoundsKeys])`. Also build a set from persisted cells' boundsKeys. Filter virtual cells to only those whose key is NOT in either set. Render: first render persisted `DiscoveryGridCell` components (existing), then render `VirtualGridCell` for each unactivated virtual cell.
- [âœ“] 2026-02-12 05:10 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 05:14 - In discovery mode at zoom >= 8, faint gray grid cells cover the entire visible map area
- [âœ“] 2026-02-12 05:19 - Persisted cells render with their status colors on top of / instead of virtual cells at the same position
- [âœ“] 2026-02-12 05:23 - Panning the map updates the virtual grid to cover newly visible area
- [âœ“] 2026-02-12 05:27 - Zooming below 8 hides the virtual grid but persisted cells remain visible
- [âœ“] 2026-02-12 05:31 - Clicking a virtual cell activates it â€” it becomes a gray "unsearched" persisted cell with a dashed blue selection border
- [âœ“] 2026-02-12 05:31 - In `src/components/map/map-content.tsx`: add new optional props to `MapContentProps`: `cellSizeKm?: number`, `gridId?: string`, `activatedBoundsKeys?: string[]`, `onActivateCell?: (cell: { key: string, swLat: number, swLng: number, neLat: number, neLng: number }) => Promise<string>`.
- [âœ“] 2026-02-12 05:33 - In `src/components/map/map-content.tsx`: update the `DiscoveryGrid` render block (line 104-108) to pass the new props through: `cellSizeKm={cellSizeKm ?? 20}`, `gridId={gridId ?? ""}`, `activatedBoundsKeys={activatedBoundsKeys ?? []}`, `onActivateCell={onActivateCell ?? (async () => "")}`. Only pass these when `gridCells && onCellSelect` (inside the existing conditional).
- [âœ“] 2026-02-12 05:33 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 05:35 - In `src/app/map/page.tsx`: add import for `activateCell` and `getOrCreateGlobalGrid` mutations: `const activateCellMutation = useMutation(api.discovery.gridCells.activateCell)` and `const getOrCreateGlobalGrid = useMutation(api.discovery.gridCells.getOrCreateGlobalGrid)`.
- [âœ“] 2026-02-12 05:38 - In `src/app/map/page.tsx`: replace the `selectedGridId` state with a `globalGridId` state: `const [globalGridId, setGlobalGridId] = useState<Id<"discoveryGrids"> | null>(null)`. Add a `useEffect` that calls `getOrCreateGlobalGrid` when `viewMode === "discovery"` and `globalGridId` is null â€” on success, set `globalGridId` to the returned grid ID. This auto-creates the grid on first discovery mode entry.
- [âœ“] 2026-02-12 05:41 - In `src/app/map/page.tsx`: update the `gridCells` query to use `globalGridId` instead of `selectedGridId`: `const gridCells = useQuery(api.discovery.gridCells.listCells, globalGridId && viewMode === "discovery" ? { gridId: globalGridId } : "skip")`. Since `listCells` now returns `{ cells, activatedBoundsKeys }`, destructure accordingly: `const gridCellsData = useQuery(...)`, then derive `const cells = gridCellsData?.cells` and `const activatedBoundsKeys = gridCellsData?.activatedBoundsKeys ?? []`.
- [âœ“] 2026-02-12 05:42 - In `src/app/map/page.tsx`: look up the selected grid to get `cellSizeKm`. Use the `listGrids` query (already used by DiscoveryPanel) or add a simple query. The simplest approach: `const grids = useQuery(api.discovery.gridCells.listGrids)`, then `const selectedGrid = grids?.find(g => g._id === globalGridId)`, then `const cellSizeKm = selectedGrid?.cellSizeKm ?? 20`.
- [âœ“] 2026-02-12 05:44 - In `src/app/map/page.tsx`: add a `handleActivateCell` callback: `const handleActivateCell = useCallback(async (cell: { key: string, swLat: number, swLng: number, neLat: number, neLng: number }) => { if (!globalGridId) return ""; const result = await activateCellMutation({ gridId: globalGridId, swLat: cell.swLat, swLng: cell.swLng, neLat: cell.neLat, neLng: cell.neLng, boundsKey: cell.key }); return result.cellId; }, [globalGridId, activateCellMutation])`.
- [âœ“] 2026-02-12 05:48 - In `src/app/map/page.tsx`: update the `<MapContent>` props â€” add `cellSizeKm={cellSizeKm}`, `gridId={globalGridId ?? undefined}`, `activatedBoundsKeys={activatedBoundsKeys}`, `onActivateCell={viewMode === "discovery" ? handleActivateCell : undefined}`. Update `gridCells` prop to pass `cells` instead of the raw query result: `gridCells={viewMode === "discovery" ? cells ?? undefined : undefined}`.
- [âœ“] 2026-02-12 05:49 - In `src/app/map/page.tsx`: update `handleCellAction` â€” it currently does `const cell = gridCells?.find(...)`. Change this to use `cells` (the destructured array): `const cell = cells?.find(...)`.
- [âœ“] 2026-02-12 05:54 - In `src/app/map/page.tsx`: remove `handleGridSelect` callback and `selectedGridId`-related code. Remove the `useEffect` that clears `selectedCellId` on `selectedGridId` change â€” replace with one that clears on `globalGridId` change (or remove if globalGridId is stable).
- [âœ“] 2026-02-12 06:00 - In `src/app/map/page.tsx`: update the `<DiscoveryPanel>` props â€” remove `selectedGridId` and `onGridSelect` props, pass `globalGridId` instead. Update `cells` prop to use `cells` variable. Remove `mapBounds` prop if no longer needed by the panel.
- [âœ“] 2026-02-12 06:00 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 06:06 - Entering discovery mode for the first time auto-creates a grid and shows the virtual overlay
- [âœ“] 2026-02-12 06:09 - Clicking a virtual cell activates it (persists to DB) and selects it in the panel
- [âœ“] 2026-02-12 06:15 - Running search on an activated cell works end-to-end (cell transitions through statuses)
- [âœ“] 2026-02-12 06:20 - Subdivide and merge work on activated cells
- [âœ“] 2026-02-12 06:24 - In `src/components/map/discovery-panel.tsx`: update `DiscoveryPanelProps` â€” remove `mapBounds` and `onGridSelect` props. Replace `selectedGridId: Id<"discoveryGrids"> | null` with `globalGridId: Id<"discoveryGrids"> | null`. Keep `cells`, `selectedCellId`, `onCellAction`.
- [âœ“] 2026-02-12 06:25 - In `src/components/map/discovery-panel.tsx`: remove the entire "Grid Selector" section (the dropdown with grid switching, lines ~195-238). Remove `showGridSelector` state.
- [âœ“] 2026-02-12 06:25 - In `src/components/map/discovery-panel.tsx`: remove the entire "New Grid Form" section (lines ~242-317). Remove `showNewGridForm`, `gridName`, `region`, `province` state variables. Remove the `handleCreateGrid` callback. Remove the `generateGrid` mutation import.
- [âœ“] 2026-02-12 06:27 - In `src/components/map/discovery-panel.tsx`: update `selectedGrid` derivation â€” change from `grids?.find((g) => g._id === selectedGridId) ?? grids?.[0] ?? null` to `grids?.find((g) => g._id === globalGridId) ?? null`.
- [âœ“] 2026-02-12 06:30 - In `src/components/map/discovery-panel.tsx`: remove the auto-select-first-grid `useEffect` (lines 71-75) â€” the page component now handles this via `getOrCreateGlobalGrid`.
- [âœ“] 2026-02-12 06:34 - In `src/components/map/discovery-panel.tsx`: add editable Region and Province fields. Below the panel header and above Progress, add a "Settings" section (only shown when `selectedGrid` exists). Show the grid's `region` and `province` as small inline-editable text fields (similar to how queries are edited â€” click to edit, Enter to save, Escape to cancel). Add a `updateGridMetadata` mutation (or reuse `updateGridQueries` extended to handle region/province). These fields are used for lead metadata when searching cells.
- [âœ“] 2026-02-12 06:34 - In `src/components/map/discovery-panel.tsx`: clean up unused imports â€” remove `MapBounds` type import, remove `Grid2x2Plus` if only used in the removed New Grid button, remove any other imports that are no longer referenced.
- [âœ“] 2026-02-12 06:35 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 06:35 - `pnpm lint` passes
- [âœ“] 2026-02-12 06:38 - Discovery panel no longer shows grid selector dropdown or "New Grid" form
- [âœ“] 2026-02-12 06:40 - Panel shows: Settings (region/province) â†’ Progress â†’ Selected Cell â†’ Search Queries â†’ Color Legend
- [âœ“] 2026-02-12 06:41 - Region and province are editable from the panel
- [âœ“] 2026-02-12 06:49 - All existing cell actions (search, split, merge) still work from the panel
- [âœ“] 2026-02-12 06:51 - In `convex/discovery/gridCells.ts`: add an `updateGridMetadata` public mutation. Args: `{ gridId: v.id("discoveryGrids"), region: v.optional(v.string()), province: v.optional(v.string()) }`. Handler: fetch the grid, throw if not found, patch with provided fields (only patch fields that are present in args).
- [âœ“] 2026-02-12 06:51 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 06:52 - Calling `updateGridMetadata` updates the grid's region/province in the database
- [âœ“] 2026-02-12 06:55 - Delete all existing `discoveryCells` documents from the Convex dashboard (or via a one-off script). These don't have the required `boundsKey` field and won't work with the new schema.
- [âœ“] 2026-02-12 06:57 - Delete all existing `discoveryGrids` documents from the Convex dashboard. The `getOrCreateGlobalGrid` mutation will create a fresh one on first use.
- [âœ“] 2026-02-12 07:01 - No old grid or cell documents remain in the database
- [âœ“] 2026-02-12 07:06 - Entering discovery mode auto-creates a fresh global grid
- [âœ“] 2026-02-12 07:10 - Toggle to Discovery mode at default zoom (8) â†’ faint gray virtual grid covers the entire visible map
- [âœ“] 2026-02-12 07:15 - Pan the map â†’ virtual grid updates to cover newly visible area, cells stay aligned
- [âœ“] 2026-02-12 07:20 - Zoom in to 10 â†’ fewer, larger-appearing cells, still aligned
- [âœ“] 2026-02-12 07:24 - Zoom out to 7 â†’ virtual grid disappears, only persisted cells visible
- [âœ“] 2026-02-12 07:29 - Click a virtual cell â†’ it activates (gray â†’ unsearched with blue dashed selection border), panel shows cell details
- [âœ“] 2026-02-12 07:33 - Click "Run" on Google Places â†’ cell searches normally (blue â†’ green/orange)
- [âœ“] 2026-02-12 07:37 - Click "Split" on a searched cell â†’ subdivides into 4, works as before
- [âœ“] 2026-02-12 07:43 - Click "Merge" on a child cell â†’ merges back to parent
- [âœ“] 2026-02-12 07:46 - Edit region/province in panel â†’ values persist
- [âœ“] 2026-02-12 07:50 - Edit search queries in panel â†’ values persist
- [âœ“] 2026-02-12 07:56 - Switch to Clusters mode and back â†’ discovery mode still works, virtual grid reappears
- [âœ“] 2026-02-12 07:56 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 07:57 - `pnpm lint` passes
- [âœ“] 2026-02-12 15:16 - In `src/components/map/cell-colors.ts`: export a `VIRTUAL_CELL_SELECTED_STYLE` constant: `{ color: "#2563eb", fillColor: "#9ca3af", fillOpacity: 0.12, weight: 3, dashArray: "6 4" }`. This mirrors the persisted-cell selection pattern (blue border, dashed line) while keeping the gray virtual-cell fill at a slightly elevated opacity to signal selection without looking like a persisted unsearched cell.
- [âœ“] 2026-02-12 15:21 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 15:22 - In `src/components/map/discovery-grid.tsx`: add `VIRTUAL_CELL_SELECTED_STYLE` to the import from `./cell-colors`.
- [âœ“] 2026-02-12 15:26 - In `src/components/map/discovery-grid.tsx`: replace the `VirtualGridCellProps` type. Remove `onActivateCell` and `onCellSelect`. Add `isSelected: boolean` and `onSelectVirtual: (cell: VirtualCell | null) => void`.
- [âœ“] 2026-02-12 15:29 - In `src/components/map/discovery-grid.tsx`: rewrite the `VirtualGridCell` function. Remove the `activating` state and the async click handler. The new click handler is a simple toggle: `() => onSelectVirtual(isSelected ? null : cell)`. Use `pathOptions={isSelected ? VIRTUAL_CELL_SELECTED_STYLE : VIRTUAL_CELL_STYLE}` to switch between selected and unselected appearance.
- [âœ“] 2026-02-12 15:32 - In `src/components/map/discovery-grid.tsx`: update `DiscoveryGridProps` â€” replace `onActivateCell: (cell: VirtualCell) => Promise<string>` with `onSelectVirtualCell: (cell: VirtualCell | null) => void`.
- [âœ“] 2026-02-12 15:37 - In `src/components/map/discovery-grid.tsx`: update the `DiscoveryGrid` default export â€” destructure `onSelectVirtualCell` instead of `onActivateCell`. In the render, pass `isSelected={vc.key === selectedCellId}` and `onSelectVirtual={onSelectVirtualCell}` to each `VirtualGridCell`.
- [âœ“] 2026-02-12 15:37 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 15:42 - Clicking a virtual cell shows blue dashed border without any network/DB activity
- [âœ“] 2026-02-12 15:44 - Clicking the same virtual cell again deselects it (border disappears)
- [âœ“] 2026-02-12 15:47 - In `src/components/map/map-content.tsx`: in `MapContentProps`, replace `onActivateCell?: (cell: VirtualCell) => Promise<string>` with `onSelectVirtualCell?: (cell: VirtualCell | null) => void`. Update the function parameter destructuring accordingly.
- [âœ“] 2026-02-12 15:47 - In `src/components/map/map-content.tsx`: in the primary `DiscoveryGrid` invocation (discovery mode pane, z-index 450), replace `onActivateCell={onActivateCell ?? (async () => "")}` with `onSelectVirtualCell={onSelectVirtualCell ?? (() => {})}`.
- [âœ“] 2026-02-12 15:49 - In `src/components/map/map-content.tsx`: in the fallback `DiscoveryGrid` invocation (virtual-grid-overlay pane, z-index 350), replace `onActivateCell={async () => ""}` with `onSelectVirtualCell={() => {}}`.
- [âœ“] 2026-02-12 15:49 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 15:50 - In `src/app/map/page.tsx`: add `import type { VirtualCell } from "@/lib/virtual-grid"`.
- [âœ“] 2026-02-12 15:52 - In `src/app/map/page.tsx`: add state: `const [selectedVirtualCell, setSelectedVirtualCell] = useState<VirtualCell | null>(null)`.
- [âœ“] 2026-02-12 15:55 - In `src/app/map/page.tsx`: add a `handleSelectVirtualCell` callback: `const handleSelectVirtualCell = useCallback((cell: VirtualCell | null) => { setSelectedVirtualCell(cell); setSelectedCellId(cell ? cell.key : null) }, [])`.
- [âœ“] 2026-02-12 15:56 - In `src/app/map/page.tsx`: modify `handleCellSelect` to also clear virtual cell state: add `setSelectedVirtualCell(null)` alongside the existing `setSelectedCellId(cellId)`.
- [âœ“] 2026-02-12 15:57 - In `src/app/map/page.tsx`: in the `useEffect` that resets on `globalGridId` change, also call `setSelectedVirtualCell(null)`.
- [âœ“] 2026-02-12 15:59 - In `src/app/map/page.tsx`: in the view-mode toggle `onClick`, also call `setSelectedVirtualCell(null)`.
- [âœ“] 2026-02-12 16:03 - In `src/app/map/page.tsx`: add lazy activation logic to `handleCellAction`. At the top, after `let cell = cells?.find((c) => c._id === cellId)`: if `!cell && selectedVirtualCell && selectedVirtualCell.key === cellId`, call `const newCellId = await handleActivateCell(selectedVirtualCell)`, then set `setSelectedVirtualCell(null)`, `setSelectedCellId(newCellId)`, reassign `cellId = newCellId`, and construct a synthetic `cell` object with `{ _id: newCellId, swLat/swLng/neLat/neLng from virtual cell, depth: 0, status: "unsearched", boundsKey: selectedVirtualCell.key }`. Wrap in try/catch with `toast.error` on failure. Add `selectedVirtualCell` and `handleActivateCell` to the dependency array.
- [âœ“] 2026-02-12 16:04 - In `src/app/map/page.tsx`: update `<MapContent>` props â€” replace `onActivateCell={viewMode === "discovery" ? handleActivateCell : undefined}` with `onSelectVirtualCell={viewMode === "discovery" ? handleSelectVirtualCell : undefined}`.
- [âœ“] 2026-02-12 16:06 - In `src/app/map/page.tsx`: update `<DiscoveryPanel>` props â€” add `selectedVirtualCell={selectedVirtualCell}`.
- [âœ“] 2026-02-12 16:07 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 16:12 - Clicking a virtual cell selects it visually without writing to the database
- [âœ“] 2026-02-12 16:18 - Clicking "Run" (Search) on a selected virtual cell activates it in the DB, then starts discovery
- [âœ“] 2026-02-12 16:23 - Clicking "Split" on a selected virtual cell activates it in the DB, then subdivides into 4
- [âœ“] 2026-02-12 16:23 - In `src/components/map/discovery-panel.tsx`: add `import type { VirtualCell } from "@/lib/virtual-grid"`.
- [âœ“] 2026-02-12 16:24 - In `src/components/map/discovery-panel.tsx`: add `selectedVirtualCell?: VirtualCell | null` to `DiscoveryPanelProps`. Update the function destructuring.
- [âœ“] 2026-02-12 16:27 - In `src/components/map/discovery-panel.tsx`: modify the `selectedCell` derivation. Rename the current `cells.find(...)` result to `persistedCell`. Then derive: `const selectedCell: CellData | null = persistedCell ?? (selectedVirtualCell ? { _id: selectedVirtualCell.key, swLat: selectedVirtualCell.swLat, swLng: selectedVirtualCell.swLng, neLat: selectedVirtualCell.neLat, neLng: selectedVirtualCell.neLng, depth: 0, status: "unsearched" as const } : null)`. The rest of the JSX uses `selectedCell` unchanged â€” it shows unsearched status badge, d0 depth, Search/Split buttons enabled, Merge hidden (depth 0).
- [âœ“] 2026-02-12 16:27 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 16:30 - Selecting a virtual cell shows "Selected Cell" section in panel with unsearched status, d0 depth
- [âœ“] 2026-02-12 16:36 - Search "Run" buttons and "Split" button are enabled for virtual cells
- [âœ“] 2026-02-12 16:42 - "Merge" button is hidden for virtual cells (depth 0)
- [âœ“] 2026-02-12 16:42 - Update `tests/virtual-grid-cell.test.mjs`: rewrite for new `VirtualGridCellProps` â€” test `isSelected` prop, `onSelectVirtual` callback (toggle behavior), no async activation, no `activating` state.
- [âœ“] 2026-02-12 16:43 - Update `tests/discovery-grid-component.test.mjs`: change `onActivateCell` references to `onSelectVirtualCell`.
- [âœ“] 2026-02-12 16:44 - Update `tests/map-content-discovery-grid-defaults.test.mjs`: change `onActivateCell` references to `onSelectVirtualCell`.
- [âœ“] 2026-02-12 16:44 - Update `tests/virtual-grid-props-wiring.test.mjs`: change `onActivateCell` references to `onSelectVirtualCell`.
- [âœ“] 2026-02-12 16:44 - Update `tests/map-page-mapcontent-props.test.mjs`: change `onActivateCell` references to `onSelectVirtualCell`.
- [âœ“] 2026-02-12 16:45 - Update `tests/map-page-activate-cell.test.mjs`: remove the "does not import VirtualCell" assertion â€” `page.tsx` now imports `VirtualCell`.
- [âœ“] 2026-02-12 16:45 - Update `tests/discovery-wiring.test.mjs`: update the `handleCellAction` dependency array assertion to include `selectedVirtualCell` and `handleActivateCell`.
- [âœ“] 2026-02-12 16:48 - Update any other tests that reference `onActivateCell` in component source scanning to use `onSelectVirtualCell`.
- [âœ“] 2026-02-12 17:17 - `pnpm test` passes with all tests green
- [âœ“] 2026-02-12 17:18 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 17:18 - `pnpm lint` passes
- [âœ“] 2026-02-12 21:54 - Add `leadsFound: v.optional(v.number())` to `discoveryCells` table in `convex/schema.ts`
- [âœ“] 2026-02-12 21:56 - In `convex/discovery/gridCells.ts` `updateCellSearchResult` mutation (~line 443), add `leadsFound: args.newLeadsCount` to the `ctx.db.patch(args.cellId, {...})` call so each cell tracks its own lead count
- [âœ“] 2026-02-12 21:57 - In `convex/discovery/gridCells.ts` `listCells` query (~line 240), add `leadsFound: cell.leadsFound` to the returned cell projection
- [âœ“] 2026-02-12 21:58 - Add `leadsFound?: number` to the `CellData` type in `src/components/map/discovery-grid-shared.ts`
- [âœ“] 2026-02-12 22:01 - In `src/components/map/discovery-panel.tsx`, make the Progress section (lines 271-317) contextual: when `selectedCell` exists and has been searched (`status !== "unsearched"`), show cell-level stats (status, result count, leads found) instead of grid-level stats. When no cell is selected or cell is unsearched, show grid-level stats as today. Use label "Cell Progress" vs "Grid Progress" to indicate scope.
- [âœ“] 2026-02-12 22:03 - `pnpm typecheck` passes
- [âœ“] 2026-02-12 22:03 - `pnpm lint` passes
- [âœ“] 2026-02-12 22:07 - `node --test tests/` passes (update pattern-matching tests if needed)
- [âœ“] 2026-02-12 22:09 - Selecting a searched cell shows per-cell stats in the Progress section
- [âœ“] 2026-02-12 22:15 - Deselecting the cell reverts to grid-level aggregate stats
- [âœ“] 2026-02-19 01:19 - In `convex/lib/leadsList.ts`, add `export` keyword to the `matchesFilters` function (line 83)
- [âœ“] 2026-02-19 01:19 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 01:21 - In `convex/leads.ts`, add a `listForExport` query. Args: same filter fields as `list` (all optional). Handler: fetch all leads via `ctx.db.query("leads").collect()`, filter with `matchesFilters` (imported from `./lib/leadsList`), then `.map()` to project only CSV fields: `name`, `type`, `farmDescription`, `contactPhone`, `address`, `city`, `latitude`, `longitude`, `placeId`, `website`, `socialLinks` (object with optional `instagram`/`facebook`), `products` (string array)
- [âœ“] 2026-02-19 01:22 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 01:25 - Create `src/lib/csv-export.ts` with two exported functions:
- [âœ“] 2026-02-19 01:25 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 01:26 - In `src/app/leads/page.tsx`, add imports: `Download` and `Loader2` from `lucide-react`, `toast` from `sonner`, `leadsToCSV` and `downloadCSV` from `@/lib/csv-export`
- [âœ“] 2026-02-19 01:26 - In `src/app/leads/page.tsx`, add state: `const [isExporting, setIsExporting] = useState(false)`
- [âœ“] 2026-02-19 01:28 - In `src/app/leads/page.tsx`, add an `handleExportCSV` async function: set `isExporting(true)`, call `convex.query(api.leads.listForExport, { ...listArgs without sortBy/sortOrder/cursor })` to fetch leads, call `leadsToCSV(results)` to generate CSV, call `downloadCSV(csv, `fm-leads-export-${new Date().toISOString().slice(0, 10)}.csv`)`, show `toast.success(`Exported ${results.length} leads`)`, catch errors with `toast.error("Export failed")`, finally set `isExporting(false)`
- [âœ“] 2026-02-19 01:29 - In `src/app/leads/page.tsx`, add a `<Button>` between `<LeadFilters>` and `<BulkActions>` in the JSX. Props: `variant="outline"`, `size="sm"`, `onClick={handleExportCSV}`, `disabled={isExporting}`. Content: when `isExporting` show `<Loader2 className="size-4 animate-spin" />` and "Exporting...", otherwise show `<Download className="size-4" />` and "Export CSV"
- [âœ“] 2026-02-19 01:29 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 01:30 - `pnpm lint` passes
- [âœ“] 2026-02-19 01:31 - `node --test tests/` passes (update pattern-matching tests if any reference the toolbar area)
- [âœ“] 2026-02-19 01:33 - On the leads page, the "Export CSV" button is visible between filters and the table
- [âœ“] 2026-02-19 01:35 - Clicking "Export CSV" downloads a `.csv` file with 13 columns and correct headers
- [âœ“] 2026-02-19 01:40 - CSV contains empty strings for missing fields, not "undefined" or "null"
- [âœ“] 2026-02-19 01:42 - Products arrays are comma-joined, socialLinks are flattened to top-level columns
- [âœ“] 2026-02-19 15:05 - In `convex/schema.ts`, add `discoveryCellId: v.optional(v.id("discoveryCells"))` to the `leads` table (after `clusterId` ~line 88)
- [âœ“] 2026-02-19 15:06 - In `convex/schema.ts`, add a new index `.index("by_discoveryCellId", ["discoveryCellId"])` to the `leads` table
- [âœ“] 2026-02-19 15:07 - In `convex/discovery/placeHelpers.ts`, add `discoveryCellId?: string` to the `DiscoveredLead` type (~line 23-41)
- [âœ“] 2026-02-19 15:09 - In `convex/discovery/placeHelpers.ts`, add `discoveryCellId: v.optional(v.id("discoveryCells"))` to `discoveredLeadValidator` (~line 246-270)
- [âœ“] 2026-02-19 15:11 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 15:12 - `node --test tests/` passes (update pattern-matching tests if validator shape assertions break)
- [âœ“] 2026-02-19 15:14 - In `convex/discovery/discoverCell.ts`, in the `discoverCell` action (~line 135), add `discoveryCellId: args.cellId` to each lead object in the `inBounds.map(...)` call that builds the `leads` array
- [âœ“] 2026-02-19 15:16 - In `convex/discovery/discoverLeads.ts`, in `insertDiscoveredLeads` handler (~line 72), the `ctx.db.insert("leads", lead)` call already inserts the full lead object â€” verify `discoveryCellId` passes through (it should, since it's in the validator now). No code change expected here, just verify.
- [âœ“] 2026-02-19 15:16 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 15:20 - Run discovery on a test cell, then verify the newly created lead has `discoveryCellId` set (check via Convex dashboard or a quick query)
- [âœ“] 2026-02-19 15:23 - In `convex/discovery/gridCells.ts`, add a new exported mutation `backfillDiscoveryCellIds` that: (a) queries all leads with `source === "google_places"`, (b) skips any that already have `discoveryCellId`, (c) uses regex `/cell\s+([a-z0-9]+)\s+\[depth=/` to extract the cell ID from `sourceDetail`, (d) patches each matching lead with `{ discoveryCellId: extractedId }`, (e) returns `{ updated: number, skipped: number }`. Use `internalMutation` so it can be called from the dashboard or a one-off script. Handle leads with no `sourceDetail` or non-matching format gracefully (skip them).
- [âœ“] 2026-02-19 15:23 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 15:26 - After running the backfill via Convex dashboard, spot-check that leads with `source: "google_places"` and a cell reference in `sourceDetail` now have `discoveryCellId` set
- [âœ“] 2026-02-19 15:28 - In `convex/discovery/gridCells.ts`, add a new exported `query` called `getCellLeadStats` with args `{ cellId: v.id("discoveryCells") }`. The handler should: (a) query all leads with `withIndex("by_discoveryCellId", q => q.eq("discoveryCellId", args.cellId))` and `.collect()`, (b) compute and return an object: `{ total: number, locationComplete: number, hasWebPresence: number, directoryReady: number }`. A lead has **locationComplete** when all of these are truthy: `address`, `city`, `province` (OR `region`), `postalCode`, `countryCode`, `latitude`, `longitude`. A lead has **hasWebPresence** when at least one of: `website`, `socialLinks?.instagram`, `socialLinks?.facebook` is truthy. A lead is **directoryReady** when both `locationComplete` AND `hasWebPresence` are true.
- [âœ“] 2026-02-19 15:28 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 15:31 - Query returns correct counts when called with a cell ID that has linked leads
- [âœ“] 2026-02-19 15:33 - In `src/components/map/discovery-panel.tsx`, add a `useQuery` call for `api.discovery.gridCells.getCellLeadStats`, passing `{ cellId: persistedCell._id as Id<"discoveryCells"> }` when `persistedCell` exists, otherwise `"skip"`
- [âœ“] 2026-02-19 15:35 - In the "Cell Progress" section (~lines 276-298), replace the "Leads Found" row (lines 292-296) with: (a) "Total Leads" showing `cellLeadStats?.total ?? "â€”"`, (b) "Directory Ready" showing `cellLeadStats?.directoryReady ?? "â€”"` out of total, (c) "Location Complete" showing `cellLeadStats?.locationComplete` out of total, (d) "Has Web/Social" showing `cellLeadStats?.hasWebPresence` out of total. Only show enrichment detail rows when `cellLeadStats?.total > 0`.
- [âœ“] 2026-02-19 15:37 - Add a small progress bar below the stats (same style as the grid progress bar but using `bg-indigo-500`) showing `directoryReady / total` percentage. Only render when `total > 0`.
- [âœ“] 2026-02-19 15:37 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 15:38 - `pnpm lint` passes
- [âœ“] 2026-02-19 15:40 - `node --test tests/` passes (update pattern-matching tests if they reference "Leads Found" or the cell progress section)
- [âœ“] 2026-02-19 15:49 - Selecting a previously-discovered cell shows "Total Leads: N" with the actual count (not 0)
- [âœ“] 2026-02-19 15:54 - Directory-readiness breakdown appears with correct counts
- [âœ“] 2026-02-19 15:56 - Progress bar reflects the directory-ready percentage
- [âœ“] 2026-02-19 15:57 - In `src/components/map/cell-colors.ts`, import `getStaleness` from `@/lib/enrichment`. Add two new color maps: `SEARCHED_FRESHNESS` and `SATURATED_FRESHNESS`, each keyed by `StalenessLevel` ("fresh" | "aging" | "stale"). Colors: searched fresh = `#22c55e` (current green), searched aging = `#a3e635` (lime/yellow-green), searched stale = `#ca8a04` (amber). Saturated fresh = `#f97316` (current orange), saturated aging = `#d97706` (dark amber), saturated stale = `#92400e` (brown). Keep fillOpacity similar to current values (0.15-0.3).
- [âœ“] 2026-02-19 16:00 - In `src/components/map/cell-colors.ts`, change the `getCellColor` signature from `getCellColor(status: string)` to `getCellColor(status: string, lastSearchedAt?: number)`. When `status` is "searched" or "saturated" and `lastSearchedAt` is provided, call `getStaleness(lastSearchedAt)` to pick the right color from the freshness map. Fall through to current behavior otherwise.
- [âœ“] 2026-02-19 16:00 - In `src/components/map/discovery-grid.tsx`, find where `getCellColor(cell.status)` is called for persisted cells and change to `getCellColor(cell.status, cell.lastSearchedAt)`. The `CellData` type already includes `lastSearchedAt?: number`.
- [âœ“] 2026-02-19 16:04 - In `src/components/map/discovery-grid-shared.ts`, replace `formatShortDate` (~line 47-52) with a `formatRelativeTime` function that returns relative strings: "today", "yesterday", "N days ago", "N weeks ago", "N months ago". Use this in the discovery panel where `lastSearchedAt` is displayed.
- [âœ“] 2026-02-19 16:05 - In `src/components/map/discovery-panel.tsx`, update the `lastRun` display (~line 367-369) to use the new `formatRelativeTime` instead of `formatShortDate`.
- [âœ“] 2026-02-19 16:08 - In `src/components/map/discovery-panel.tsx`, update `CELL_STATUS_LEGEND` (~lines 42-47) to show freshness variants: replace the single "Searched" entry with "Searched (fresh)" (green `#22c55e`) and "Searched (stale)" (amber `#ca8a04`). Keep "Unsearched", "Searching", and "Saturated" as-is. The legend grid may need to be `grid-cols-2` with 5 items (last row wraps).
- [âœ“] 2026-02-19 16:08 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 16:09 - `pnpm lint` passes
- [âœ“] 2026-02-19 16:12 - `node --test tests/` passes (update tests if they regex-match `getCellColor` signature or `formatShortDate`)
- [âœ“] 2026-02-19 16:15 - On the map, cells discovered within the last 30 days appear bright green
- [âœ“] 2026-02-19 16:18 - Cells discovered 30-90 days ago appear yellow-green/lime
- [âœ“] 2026-02-19 16:20 - Cells discovered >90 days ago appear amber
- [âœ“] 2026-02-19 16:25 - Hovering/clicking a cell shows relative time ("3 days ago", "2 months ago") instead of absolute date
- [âœ“] 2026-02-19 16:28 - Legend reflects fresh vs stale distinction
- [âœ“] 2026-02-19 16:29 - In `convex/discovery/gridCells.ts`, add a new exported `query` called `getGridEnrichmentStats` with args `{ gridId: v.id("discoveryGrids") }`. Handler: (a) fetch all leaf cells for the grid using `by_gridId_isLeaf` index, (b) for each cell, query leads using `by_discoveryCellId` index, (c) aggregate across all cells: `totalLeads`, `locationComplete`, `hasWebPresence`, `directoryReady` (using same logic as `getCellLeadStats`), (d) return the aggregated object.
- [âœ“] 2026-02-19 16:31 - In `src/components/map/discovery-panel.tsx`, add a `useQuery` call for `api.discovery.gridCells.getGridEnrichmentStats`, passing `{ gridId: globalGridId }` when `globalGridId` exists, otherwise `"skip"`
- [âœ“] 2026-02-19 16:33 - In the "Grid Progress" section (~lines 302-342), after the existing "Leads Found" row and progress bar, add a new section: (a) replace "Leads Found" label with "Total Leads" showing `gridEnrichmentStats?.totalLeads ?? selectedGrid.totalLeadsFound`, (b) add "Directory Ready" row showing `gridEnrichmentStats?.directoryReady` / `gridEnrichmentStats?.totalLeads` with percentage, (c) add "Needs Attention" row showing `totalLeads - directoryReady` count. Only show these rows when `gridEnrichmentStats` is loaded and `totalLeads > 0`.
- [âœ“] 2026-02-19 16:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 16:34 - `pnpm lint` passes
- [âœ“] 2026-02-19 16:42 - `node --test tests/` passes
- [âœ“] 2026-02-19 16:46 - With no cell selected, grid progress shows total leads and directory-readiness percentage
- [âœ“] 2026-02-19 16:54 - Numbers are consistent â€” grid-level totals match sum of individual cell stats
- [âœ“] 2026-02-19 16:55 - In `convex/schema.ts`, add `exportedAt: v.optional(v.number())` to the `leads` table
- [âœ“] 2026-02-19 16:56 - In `convex/leads.ts`, add a new exported `mutation` called `bulkStampExported` with args `{ leadIds: v.array(v.id("leads")) }`. Handler: patch each lead with `{ exportedAt: Date.now() }`.
- [âœ“] 2026-02-19 16:58 - In `src/app/leads/page.tsx`, after a successful CSV download (where `toast.success` is called), call the `bulkStampExported` mutation with the IDs of all exported leads. Extract IDs from the export query result before generating CSV.
- [âœ“] 2026-02-19 17:00 - In `convex/discovery/gridCells.ts`, update `getCellLeadStats` to also return `exported: number` (count of leads where `exportedAt` is truthy)
- [âœ“] 2026-02-19 17:02 - In `convex/discovery/gridCells.ts`, update `getGridEnrichmentStats` to also return `exported: number`
- [âœ“] 2026-02-19 17:04 - In `src/components/map/discovery-panel.tsx`, add an "Exported" row to both the cell progress and grid progress sections, showing `exported / total`
- [âœ“] 2026-02-19 17:04 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 17:05 - `pnpm lint` passes
- [âœ“] 2026-02-19 17:08 - `node --test tests/` passes
- [âœ“] 2026-02-19 17:11 - Export CSV from leads page, then check that exported leads have `exportedAt` set
- [âœ“] 2026-02-19 17:12 - Cell and grid stats show export counts after an export has been performed
- [âœ“] 2026-02-19 19:34 - In `convex/discovery/gridCells.ts`, add a new `internalQuery` called `getCellLeadIdsForEnrichment` with args `{ cellId: v.id("discoveryCells") }`. The handler should: (a) query leads using `withIndex("by_discoveryCellId", q => q.eq("discoveryCellId", args.cellId))` and `.collect()`, (b) filter to leads where `enrichedAt` is undefined OR `enrichedAt` is older than 30 days (`Date.now() - lead.enrichedAt > 30 * 24 * 60 * 60 * 1000`), (c) return an array of just the `_id` values. Import `internalQuery` from `../_generated/server` if not already imported.
- [âœ“] 2026-02-19 19:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 19:36 - In `convex/enrichment/batchEnrichPublic.ts`, add a new exported `action` called `enrichCellLeads` with args `{ cellId: v.id("discoveryCells") }`. The handler should: (a) call `ctx.runQuery(internal.discovery.gridCells.getCellLeadIdsForEnrichment, { cellId: args.cellId })` to get unenriched lead IDs, (b) if the array is empty, return `{ leadIds: [], total: 0, succeeded: 0, failed: 0, skipped: 0 }`, (c) chunk the IDs into batches of 25, (d) for each chunk call `ctx.runAction(internal.enrichment.batchEnrich.batchEnrichLeads, { leadIds: chunk })`, (e) aggregate the results across all chunks (sum `succeeded`, `failed`, `skipped`), (f) return `{ leadIds: allLeadIds, total, succeeded, failed, skipped }`. Make sure to import `internal` from `../_generated/api` and the `v` validator for `cellId`.
- [âœ“] 2026-02-19 19:45 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 19:46 - In `src/components/map/discovery-panel.tsx`, add imports: `useAction` from `convex/react`, `Sparkles` from `lucide-react`, `EnrichmentProgress` from `@/components/leads/enrichment-progress`
- [âœ“] 2026-02-19 19:48 - In the `DiscoveryPanel` component, add local state: `const [isEnriching, setIsEnriching] = useState(false)`, `const [enrichingLeadIds, setEnrichingLeadIds] = useState<Id<"leads">[]>([])`, `const enrichmentSinceRef = useRef(0)`. Also add: `const enrichCellLeads = useAction(api.enrichment.batchEnrichPublic.enrichCellLeads)`
- [âœ“] 2026-02-19 19:50 - Add a `handleEnrichCell` async function that: (a) sets `isEnriching(true)` and `enrichmentSinceRef.current = Date.now()`, (b) shows `toast.info(\`Enriching leads in cell...\`)`, (c) calls `enrichCellLeads({ cellId: persistedCell._id as Id<"discoveryCells"> })`, (d) on the result, sets `enrichingLeadIds` from the returned `leadIds`, (e) shows a success or warning toast with succeeded/failed/skipped counts (same format as `bulk-actions.tsx` lines 97-101), (f) in the `finally` block sets `isEnriching(false)` and clears `enrichingLeadIds` after a short delay (e.g. 2 seconds, so the progress bar can show 100% briefly before disappearing)
- [âœ“] 2026-02-19 19:53 - In the "Selected Cell" section (~line 467, after the Split/Merge buttons div), add a new row with an "Enrich" button. Use the same inline button styling as the Split/Merge buttons: `inline-flex items-center gap-1 rounded-md border px-1.5 py-0.5 text-xs transition-colors hover:bg-accent`. Add the `Sparkles` icon (`size-3`). Disable the button when: `isEnriching`, or `!persistedCell` (virtual cells can't be enriched), or `(cellLeadStats?.total ?? 0) === 0` (no leads to enrich). Show "Enriching..." text when `isEnriching`, otherwise "Enrich".
- [âœ“] 2026-02-19 19:55 - Below the enrich button, conditionally render `<EnrichmentProgress leadIds={enrichingLeadIds} since={enrichmentSinceRef.current} />` when `isEnriching && enrichingLeadIds.length > 0`. The component will auto-hide when all leads are done (it returns null when `completed >= total`).
- [âœ“] 2026-02-19 19:56 - `pnpm typecheck` passes
- [âœ“] 2026-02-19 19:56 - `pnpm lint` passes
- [âœ“] 2026-02-19 19:59 - `node --test tests/` passes (update pattern-matching tests if they reference the Selected Cell section structure)
- [âœ“] 2026-02-19 20:03 - Select a discovered cell with leads â†’ "Enrich" button is visible and enabled
- [âœ“] 2026-02-19 20:06 - Select an unsearched/virtual cell â†’ "Enrich" button is not shown (no persistedCell)
- [âœ“] 2026-02-19 20:09 - Select a cell with 0 leads â†’ "Enrich" button is disabled
- [âœ“] 2026-02-19 20:15 - Click "Enrich" â†’ toast shows "Enriching leads in cell...", button shows "Enriching...", progress bar appears
- [âœ“] 2026-02-19 20:20 - On completion â†’ toast shows succeeded/failed/skipped counts, cell stats update reactively
- [âœ“] 2026-02-19 20:22 - While enrichment is running â†’ button is disabled, cannot double-trigger
- [âœ“] 2026-02-20 16:30 - In `convex/schema.ts`, add two new optional fields to the `leads` table definition, after `farmDescription`: `locationDescription: v.optional(v.string())` and `imagePrompt: v.optional(v.string())`
- [âœ“] 2026-02-20 16:31 - In `convex/leads.ts`, add `locationDescription: v.optional(v.string())` and `imagePrompt: v.optional(v.string())` to the `update` mutation's args validator (after `farmDescription`)
- [âœ“] 2026-02-20 16:33 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 16:37 - `node --test tests/` passes
- [âœ“] 2026-02-20 16:39 - Create `convex/enrichment/sonarEnrich.ts` with a `SonarEnrichResult` type containing: `contactEmail: string | null`, `contactName: string | null`, `contactPhone: string | null`, `website: string | null`, `socialLinks: { facebook: string | null, instagram: string | null }`, `products: string[]`, `structuredProducts: Array<{ name: string, category: string }>`, `salesChannels: string[]`, `sellsOnline: boolean`, `businessDescription: string`, `structuredDescription: { summary: string, specialties: string[], certifications: string[] }`, `locationDescription: string`, `imagePrompt: string`, `citations: string[]`
- [âœ“] 2026-02-20 16:41 - Export a Convex `action` called `enrichWithSonar` with args: `{ name: v.string(), address: v.string(), city: v.string(), province: v.string(), type: v.string(), website: v.optional(v.string()), useSonarPro: v.optional(v.boolean()) }`. The handler should: (a) read `process.env.AI_GATEWAY_API_KEY`, return `null` if missing, (b) select model â€” use `perplexity/sonar-pro` if `useSonarPro` is true, otherwise `perplexity/sonar`, (c) call `fetch("https://ai-gateway.vercel.sh/v1/chat/completions")` with `Authorization: Bearer ${apiKey}`, `Content-Type: application/json`, (d) send the enrichment prompt as a user message with `response_format: { type: "json_object" }`, (e) handle 429 (throw rate limit error), non-ok responses (throw with status), (f) parse the OpenAI-compatible response (`data.choices[0].message.content`), (g) JSON-parse the content into `SonarEnrichResult`, validating types (same defensive parsing pattern as `claudeAnalysis.ts` `parseAnalysisResponse`), (h) extract `citations` from the response metadata if available (`data.citations` â€” Perplexity models return this alongside the standard OpenAI format), (i) return the parsed result or `null` on parse failure
- [âœ“] 2026-02-20 16:43 - The enrichment prompt should be a `const SONAR_ENRICHMENT_PROMPT` that instructs the model to: search the web for the given business, find verified contact information (email, phone, contact name), find social media profiles (Facebook, Instagram), identify products sold with categories (produce, dairy, meat, eggs, honey, baked goods, preserves, beverages, flowers, nursery, value-added, other), identify sales channels, determine if they sell online, write a business description, list specialties and certifications, write a `locationDescription` (2-3 sentences describing the place as if for a marketplace listing â€” what makes it special, what visitors can expect), write an `imagePrompt` (a detailed visual description suitable for AI image generation â€” describe the setting, products, atmosphere, style), and return ONLY valid JSON matching the `SonarEnrichResult` shape. The prompt must explicitly state: "Only include information you can verify from web sources. Return null for any field you cannot confirm. Never fabricate email addresses, phone numbers, or URLs."
- [âœ“] 2026-02-20 16:46 - The user message should interpolate the lead's details: "Search the web for information about this business:\n\nName: {name}\nType: {type}\nAddress: {address}\nCity: {city}\nProvince: {province}" and append "Website: {website}" if a website URL is known
- [âœ“] 2026-02-20 16:47 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 16:49 - File follows the same structure as `convex/enrichment/claudeAnalysis.ts` (raw fetch, error handling, defensive parsing)
- [âœ“] 2026-02-20 16:50 - In `convex/enrichment/orchestrator.ts`, add `useSonarPro: v.optional(v.boolean())` to the `enrichLead` action's args
- [âœ“] 2026-02-20 16:52 - Remove imports for: `discoverSocialLinks` from `./socialDiscovery`, `WebsiteScraperResult` from `./websiteScraper`, `HunterResult` from `./hunter`, `ClaudeAnalysisResult` from `./claudeAnalysis`. Add import for `SonarEnrichResult` type from `./sonarEnrich`
- [âœ“] 2026-02-20 16:53 - Change `ENRICHMENT_VERSION` from `"1.0"` to `"2.0"`
- [âœ“] 2026-02-20 17:00 - Replace Steps 4-7 (website scraper, Hunter.io, Claude analysis, social discovery â€” approximately lines 143-253 in the current file) with a single Sonar step: call `ctx.runAction(api.enrichment.sonarEnrich.enrichWithSonar, { name: lead.name, address: lead.address, city: lead.city, province: lead.province, type: lead.type, website: websiteUrl ?? undefined, useSonarPro: args.useSonarPro })`. Store the result as `sonarResult`. If `sonarResult` is not null, push `{ source: "sonar_enrichment", fetchedAt: Date.now() }` to the sources array. If sonarResult has citations, also store them in the source detail.
- [âœ“] 2026-02-20 17:03 - Update the merge logic (Step 8) to use `sonarResult` instead of the old individual results. For email: use `sonarResult.contactEmail` (replaces `scraperResult.emails[0]` and `hunterResult`). For contact name: use `sonarResult.contactName`. For phone: use `sonarResult.contactPhone` as secondary if Places didn't find one. For website: use `sonarResult.website` as secondary. For social links: use `sonarResult.socialLinks.facebook` and `sonarResult.socialLinks.instagram`. For products/salesChannels/sellsOnline/farmDescription/contactName: use the corresponding `sonarResult` fields (same overwrite logic as before â€” only fill empty fields unless `overwrite`). For structuredProducts/structuredDescription: store in `enrichmentData` (same pattern as before). NEW: merge `sonarResult.locationDescription` into `patch.locationDescription` and `sonarResult.imagePrompt` into `patch.imagePrompt` (only if non-empty and field is empty or overwrite).
- [âœ“] 2026-02-20 17:03 - Remove the `extractDomain` helper function (no longer needed â€” Hunter.io is removed)
- [âœ“] 2026-02-20 17:05 - Remove the `websiteHtml` variable and all references to it (no longer scraping HTML)
- [âœ“] 2026-02-20 17:07 - Keep the email source tracking: if email came from Sonar, set `emailSource` to `sonar - ${lead.name} - ${new Date().toISOString().slice(0, 10)}`
- [âœ“] 2026-02-20 17:08 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 17:09 - `pnpm lint` passes
- [âœ“] 2026-02-20 17:14 - The orchestrator still handles: cooldown check, unsubscribe block list, Google Places, merge logic, status transitions, consent source, activity logging
- [âœ“] 2026-02-20 17:15 - In `convex/enrichment/batchEnrich.ts`, add `useSonarPro: v.optional(v.boolean())` to `batchEnrichLeads` args. Pass it through to each `ctx.runAction(internal.enrichment.orchestrator.enrichLead, { leadId, force, overwrite, useSonarPro: args.useSonarPro })`
- [âœ“] 2026-02-20 17:16 - In `convex/enrichment/batchEnrichPublic.ts`, add `useSonarPro: v.optional(v.boolean())` to any public actions that call `batchEnrichLeads`, and thread it through
- [âœ“] 2026-02-20 17:24 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 17:25 - In `src/components/leads/data-freshness.tsx`, find the source label mapping (or wherever enrichment source names are displayed). Add `"sonar_enrichment"` with label `"Sonar Web Search"`. Keep existing labels (`google_places`, `website_scraper`, `hunter`, `claude_analysis`, `social_discovery`) for backward compatibility with previously-enriched leads.
- [âœ“] 2026-02-20 17:26 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 17:28 - In `src/app/leads/[id]/page.tsx`, in the Business Details card section, display `lead.locationDescription` if present. Use a paragraph with a "Location" or "About this Location" label, similar to how `farmDescription` is displayed.
- [âœ“] 2026-02-20 17:30 - In the same section, display `lead.imagePrompt` if present. Show it in a monospace/code-style block with a "Copy" button so the user can easily copy it to paste into DALL-E, Midjourney, etc. Label it "Image Generation Prompt". Use a collapsible or secondary visual treatment so it doesn't dominate the page.
- [âœ“] 2026-02-20 17:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 17:30 - `pnpm lint` passes
- [âœ“] 2026-02-20 17:33 - Lead detail page renders without errors when `locationDescription` and `imagePrompt` are present
- [âœ“] 2026-02-20 17:36 - Lead detail page renders without errors when those fields are absent (backward compat)
- [âœ“] 2026-02-20 17:37 - Rewrite `tests/enrichment-orchestrator.test.mjs` to match the new orchestrator structure. Update assertions to: (a) verify import of `SonarEnrichResult` from `./sonarEnrich` (not `WebsiteScraperResult`, `HunterResult`, `ClaudeAnalysisResult`), (b) verify `enrichWithSonar` is called via `api.enrichment.sonarEnrich.enrichWithSonar`, (c) verify `ENRICHMENT_VERSION` is `"2.0"`, (d) verify `useSonarPro` appears in the args, (e) verify Google Places step is still present, (f) verify `sonar_enrichment` source string exists, (g) verify `locationDescription` and `imagePrompt` appear in the merge logic. Remove assertions about `scrapeWebsite`, `searchDomain`, `analyzeWithClaude`, `discoverSocialLinks`.
- [âœ“] 2026-02-20 17:38 - Rewrite `tests/enrichment-fills-fields.test.mjs` to match the new merge logic. Update assertions to reference `sonarResult.contactEmail`, `sonarResult.products`, `sonarResult.socialLinks` instead of `scraperResult.emails`, `claudeResult.products`, `sorted[0].email`, etc. Add assertions for `locationDescription` and `imagePrompt` in the patch.
- [âœ“] 2026-02-20 17:39 - Create `tests/sonar-enrich.test.mjs` with pattern assertions against `convex/enrichment/sonarEnrich.ts`: (a) exports `enrichWithSonar` action, (b) exports `SonarEnrichResult` type, (c) reads `AI_GATEWAY_API_KEY` from `process.env`, (d) uses `https://ai-gateway.vercel.sh/v1/chat/completions` endpoint, (e) uses `perplexity/sonar` as default model, (f) uses `perplexity/sonar-pro` when `useSonarPro` is true, (g) uses `response_format` for structured output, (h) handles 429 rate limit, (i) prompt contains "Never fabricate" instruction
- [âœ“] 2026-02-20 17:39 - `node --test tests/` passes â€” all tests green
- [âœ“] 2026-02-20 17:40 - Old test files for scraper/hunter/claude/social still pass (those source files weren't deleted)
- [âœ“] 2026-02-20 17:41 - `AI_GATEWAY_API_KEY` is set in Convex environment variables
- [âœ“] 2026-02-20 17:42 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 17:42 - `pnpm lint` passes
- [âœ“] 2026-02-20 17:43 - `node --test tests/` passes
- [âœ“] 2026-02-20 17:48 - Re-enrich a known lead (e.g., Grimsby Farmer's Market) with `--force` â€” email is found, `locationDescription` and `imagePrompt` are populated
- [âœ“] 2026-02-20 17:50 - Lead detail page displays `locationDescription` and `imagePrompt` correctly
- [âœ“] 2026-02-20 17:54 - Previously-enriched leads still display their old enrichment sources correctly (backward compat)
- [âœ“] 2026-02-20 17:59 - Batch enrichment from discovery panel still works with the new pipeline
- [âœ“] 2026-02-20 19:53 - Create `convex/enrichment/apifyWebsite.ts` with an `ApifyWebsiteResult` type containing: `emails: string[]`, `phones: string[]`, `socialLinks: { facebook: string | null, instagram: string | null }`
- [âœ“] 2026-02-20 19:56 - Export a Convex `action` called `scrapeContacts` (NOT `scrapeWebsiteContacts` â€” avoids triggering existing `doesNotMatch(source, /scrapeWebsite/)` test assertion in `tests/enrichment-orchestrator.test.mjs:340`) with args: `{ url: v.string() }`. The handler should: (a) read `process.env.APIFY_API_TOKEN`, return `null` if missing, (b) POST to `https://api.apify.com/v2/acts/betterdevsscrape~contact-details-extractor/run-sync-get-dataset-items` with `Authorization: Bearer ${apiToken}` header and `Content-Type: application/json`, (c) send body `{ startUrls: [{ url: args.url }], maxDepth: 0 }` (homepage only, $0.001/page), (d) handle 429 (throw rate limit error), non-ok responses (throw with status and response body), (e) parse response as JSON array, take the first item, (f) extract emails array â€” filter with `isBoilerplateEmail` function (copy logic from `convex/enrichment/websiteScraper.ts:39-55`: reject emails ending in `.png`/`.jpg`/`.gif`/`.svg`/`.webp`, containing `example.com`/`sentry`/`wixpress.com`/`wordpress.com`/`squarespace.com`, or starting with `noreply@`/`no-reply@`), (g) extract phones array from response, (h) extract social links by finding URLs matching `facebook.com` and `instagram.com` patterns in the response data, (i) return `ApifyWebsiteResult | null` (null on parse failure)
- [âœ“] 2026-02-20 19:57 - Use a 30-second timeout via `AbortController` on the fetch call â€” Apify sync endpoint can take up to 300s, but we should not wait that long
- [âœ“] 2026-02-20 19:58 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:01 - File follows the same structure as `convex/enrichment/sonarEnrich.ts` (raw fetch, error handling, defensive parsing)
- [âœ“] 2026-02-20 20:02 - Create `convex/enrichment/apifySocial.ts` with an `ApifySocialResult` type containing: `email: string | null`, `phone: string | null`, `website: string | null`
- [âœ“] 2026-02-20 20:04 - Export a Convex `action` called `scrapeSocialPages` with args: `{ facebookUrl: v.optional(v.string()), instagramUsername: v.optional(v.string()) }`. The handler should: (a) read `process.env.APIFY_API_TOKEN`, return `null` if missing, (b) return `null` if neither `facebookUrl` nor `instagramUsername` is provided, (c) initialize result as `{ email: null, phone: null, website: null }`, (d) if `facebookUrl` is provided: POST to `https://api.apify.com/v2/acts/apify~facebook-page-contact-information/run-sync-get-dataset-items` with `{ pageUrls: [facebookUrl] }` â€” extract email, phone, website from first result item, (e) if `instagramUsername` is provided and still missing email: POST to `https://api.apify.com/v2/acts/apify~instagram-profile-scraper/run-sync-get-dataset-items` with `{ usernames: [instagramUsername] }` â€” extract website URL from bio/external links, (f) each platform call should be wrapped in its own try/catch so one failure doesn't prevent the other, (g) use 30-second `AbortController` timeout per call, (h) return `ApifySocialResult | null`
- [âœ“] 2026-02-20 20:07 - Use defensive parsing for both platform responses â€” the response shapes may vary, so check types before accessing fields (same pattern as `parseSonarResponse` in `sonarEnrich.ts`)
- [âœ“] 2026-02-20 20:09 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:12 - File follows the same structure as `convex/enrichment/sonarEnrich.ts`
- [âœ“] 2026-02-20 20:13 - In `convex/enrichment/orchestrator.ts`, add imports: `import type { ApifyWebsiteResult } from "./apifyWebsite"` and `import type { ApifySocialResult } from "./apifySocial"`
- [âœ“] 2026-02-20 20:14 - Add `useApify: v.optional(v.boolean())` to the `enrichLead` action's args
- [âœ“] 2026-02-20 20:15 - Change `ENRICHMENT_VERSION` from `"2.0"` to `"3.0"`
- [âœ“] 2026-02-20 20:17 - After the Google Places block (after line 129 `}`), add **Step 3b â€” Apify Social Scraper (EARLY)**. This step only runs when: `useApify !== false` AND `!websiteUrl` AND lead already has social links (`lead.socialLinks?.facebook || lead.socialLinks?.instagram`). Extract Instagram username from URL with regex `/instagram\.com\/([^/?#]+)/`. Call `ctx.runAction(api.enrichment.apifySocial.scrapeSocialPages, { facebookUrl, instagramUsername })`. Track scraped URLs in a `Set<string>` called `scrapedSocialUrls` to avoid re-scraping in Step 4b. If result has a `website` field, update `websiteUrl` so the website scraper and Sonar can use it. Push `{ source: "apify_social", fetchedAt: Date.now() }` to sources if successful.
- [âœ“] 2026-02-20 20:21 - After Step 3b, add **Step 3c â€” Apify Website Scraper**. This step runs when: `useApify !== false` AND `websiteUrl` exists (from lead record, Google Places, OR social scraper in 3b). Call `ctx.runAction(api.enrichment.apifyWebsite.scrapeContacts, { url: websiteUrl })`. Push `{ source: "apify_website", detail: websiteUrl, fetchedAt: Date.now() }` to sources if successful.
- [âœ“] 2026-02-20 20:29 - After the Sonar block, add **Step 4b â€” Apify Social Scraper (LATE)**. This step only runs when: `useApify !== false` AND still missing email (check `!lead.contactEmail && !(apifyWebsiteResult?.emails?.length) && !sonarResult?.contactEmail && !apifySocialResult?.email`) AND have social URLs not already scraped in Step 3b (check against `scrapedSocialUrls` set). Collect known FB/IG URLs from `apifyWebsiteResult?.socialLinks`, `sonarResult?.socialLinks`, and `lead.socialLinks`. Call `scrapeSocialPages` with only the unscraped URLs. Merge late results into `apifySocialResult` (fill gaps only â€” don't overwrite early results). Add `apify_social` to sources if not already present.
- [âœ“] 2026-02-20 20:33 - Update the **merge logic** to incorporate Apify results with correct priority order. For email: check `apifyWebsiteResult.emails[0]` first, then `apifySocialResult.email`, then `sonarResult.contactEmail`. For social links: merge `apifyWebsiteResult.socialLinks` first (highest priority â€” literal HTML extraction), then `sonarResult.socialLinks`. For phone: `apifySocialResult.phone` as fallback after Google Places and Sonar. For website: `apifySocialResult.website` already feeds into `websiteUrl` in Step 3b. Update `emailSource` strings to include `"apify_website - {url}"` and `"apify_social - {date}"` patterns.
- [âœ“] 2026-02-20 20:34 - Wrap each new Apify step in try/catch (same pattern as existing Google Places and Sonar steps â€” `catch { /* continue */ }`)
- [âœ“] 2026-02-20 20:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:35 - `pnpm lint` passes
- [âœ“] 2026-02-20 20:39 - The orchestrator still handles: cooldown check, unsubscribe block list, Google Places, Sonar, merge logic, status transitions, consent source, activity logging
- [âœ“] 2026-02-20 20:41 - In `convex/enrichment/batchEnrich.ts`, add `useApify: v.optional(v.boolean())` to `batchEnrichLeads` args. Pass it through to each `ctx.runAction(internal.enrichment.orchestrator.enrichLead, { leadId, force, overwrite, useSonarPro: args.useSonarPro, useApify: args.useApify })`
- [âœ“] 2026-02-20 20:42 - In `convex/enrichment/batchEnrichPublic.ts`, add `useApify: v.optional(v.boolean())` to both `batchEnrich` and `enrichCellLeads` actions, and thread it through to `batchEnrichLeads`
- [âœ“] 2026-02-20 20:43 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:44 - In `src/components/leads/data-freshness.tsx`, add two new entries to the `SOURCE_LABELS` object: `"apify_website"` with label `"Website Scraper"` and `"apify_social"` with label `"Social Pages"`. Keep all existing labels for backward compatibility.
- [âœ“] 2026-02-20 20:44 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:45 - Create `tests/apify-website.test.mjs` with pattern assertions against `convex/enrichment/apifyWebsite.ts`: (a) exports `scrapeContacts` action, (b) exports `ApifyWebsiteResult` type, (c) reads `APIFY_API_TOKEN` from `process.env`, (d) uses `betterdevsscrape` actor (contact-details-extractor), (e) uses Apify sync endpoint (`api.apify.com/v2/acts`), (f) uses `maxDepth: 0`, (g) sends `Authorization: Bearer` header, (h) handles 429 rate limit, (i) filters boilerplate emails (match on `isBoilerplateEmail` or boilerplate-related patterns like `noreply`, `example.com`), (j) result type includes `emails`, `phones`, `socialLinks`
- [âœ“] 2026-02-20 20:46 - Create `tests/apify-social.test.mjs` with pattern assertions against `convex/enrichment/apifySocial.ts`: (a) exports `scrapeSocialPages` action, (b) exports `ApifySocialResult` type, (c) reads `APIFY_API_TOKEN` from `process.env`, (d) uses Facebook page contact info actor (`facebook-page-contact-information`), (e) uses Instagram profile scraper actor (`instagram-profile-scraper`), (f) accepts `facebookUrl` and `instagramUsername` optional args, (g) returns null when no token or no args
- [âœ“] 2026-02-20 20:47 - Update `tests/enrichment-orchestrator.test.mjs`: (a) add `useApify` to the args assertion alongside `useSonarPro`, (b) add import assertion for `ApifyWebsiteResult` from `./apifyWebsite` and `ApifySocialResult` from `./apifySocial`, (c) add assertion that `api.enrichment.apifyWebsite.scrapeContacts` is called, (d) add assertion that `api.enrichment.apifySocial.scrapeSocialPages` is called, (e) add assertion for `source: "apify_website"` in sources, (f) add assertion for `source: "apify_social"` in sources, (g) update `ENRICHMENT_VERSION` assertion from `"2.0"` to `"3.0"`, (h) update the `doesNotMatch(source, /scrapeWebsite/)` test on line 340 â€” change the regex to `/from\s+["']\.\/websiteScraper["']/` so it blocks old module imports without matching the new `scrapeContacts` function, (i) update step-position-dependent slicing tests (lines 297-303, 148-154) to account for new step comments `// Step 3b:` and `// Step 4b:`
- [âœ“] 2026-02-20 20:48 - Update `tests/enrichment-fills-fields.test.mjs`: (a) add assertions for `apifyWebsiteResult` email merge before `sonarResult`, (b) add assertions for `apifyWebsiteResult` social links merge, (c) add assertions for `apifySocialResult` fallback for email, phone, and website
- [âœ“] 2026-02-20 20:49 - `node --test tests/` passes â€” all tests green
- [âœ“] 2026-02-20 20:50 - Old test files for scraper/hunter/claude/social still pass (those source files weren't deleted)
- [âœ“] 2026-02-20 20:52 - `APIFY_API_TOKEN` is set in Convex environment variables
- [âœ“] 2026-02-20 20:52 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 20:53 - `pnpm lint` passes
- [âœ“] 2026-02-20 20:53 - `node --test tests/` passes
- [âœ“] 2026-02-20 20:59 - Re-enrich a lead with a known website (e.g., Big Red Markets) with `--force` â€” social links found via Apify website scraper
- [âœ“] 2026-02-20 21:04 - Re-enrich a lead with no website but with existing social links â€” Apify social scraper fires, discovers website URL, website scraper runs on discovered URL
- [âœ“] 2026-02-20 21:09 - Previously-enriched leads still display their old enrichment sources correctly (backward compat)
- [âœ“] 2026-02-20 21:12 - Batch enrichment from discovery panel still works with `useApify` defaulting to true
- [âœ“] 2026-02-20 22:22 - In `convex/leads.ts`, update the `listForExport` query's `.map()` projection (lines 114â€“132): remove `farmDescription` and `contactPhone`, add `locationDescription: lead.locationDescription`, `imagePrompt: lead.imagePrompt`, and `categories` derived from `enrichmentData.structuredProducts` â€” extract unique category strings: `[...new Set((Array.isArray((lead.enrichmentData as any)?.structuredProducts) ? (lead.enrichmentData as any).structuredProducts : []).map((p: any) => p.category).filter(Boolean))]`
- [âœ“] 2026-02-20 22:26 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 22:29 - In `src/lib/csv-export.ts`, update the `ExportLead` type: remove `farmDescription?: string` and `contactPhone?: string`, add `locationDescription?: string`, `imagePrompt?: string`, `categories?: string[]`
- [âœ“] 2026-02-20 22:32 - In `src/lib/csv-export.ts`, update `CSV_COLUMNS`: replace `"farmDescription"` with `"description"`, remove `"contactPhone"`, add `"imagePrompt"` and `"categories"` after `"products"`. Final order: `name, type, description, address, city, state, postalCode, countryCode, latitude, longitude, placeId, website, instagram, facebook, products, imagePrompt, categories`
- [âœ“] 2026-02-20 22:33 - In `src/lib/csv-export.ts`, update the `values` array in `leadsToCSV`: map `description` from `lead.locationDescription ?? ""`, remove the contactPhone line, add `lead.imagePrompt ?? ""` and `lead.categories ? lead.categories.join(", ") : ""` at the end (matching column order)
- [âœ“] 2026-02-20 22:37 - `pnpm typecheck` passes
- [âœ“] 2026-02-20 22:38 - In `tests/csv-export.test.mjs`, update the "produces correct header row" test (line 38): change expected header to `name,type,description,address,city,state,postalCode,countryCode,latitude,longitude,placeId,website,instagram,facebook,products,imagePrompt,categories`
- [âœ“] 2026-02-20 22:39 - In `tests/csv-export.test.mjs`, update the "outputs correct values for a complete lead" test (line 44): change input object â€” replace `farmDescription: "Organic produce"` with `locationDescription: "Organic produce"`, remove `contactPhone: "555-0100"`, add `imagePrompt: "A farm stand with fresh produce"` and `categories: ["produce"]`. Update expected CSV row to match new column order and 17 columns
- [âœ“] 2026-02-20 22:41 - In `tests/csv-export.test.mjs`, update the "uses empty strings for undefined" test (line 76): change expected trailing commas from 14 trailing empties to 15 (17 columns minus name and type)
- [âœ“] 2026-02-20 22:41 - In `tests/csv-export.test.mjs`, update the "uses empty strings for explicit null fields" test (line 88): replace `farmDescription: null` with `locationDescription: null`, remove `contactPhone: null`, add `imagePrompt: null` and `categories: null`. Update expected trailing commas
- [âœ“] 2026-02-20 22:42 - In `tests/csv-export.test.mjs`, update the "never outputs literal 'undefined' or 'null'" test (line 114): replace `farmDescription: null` with `locationDescription: null`, add `imagePrompt: null` and `categories: null`
- [âœ“] 2026-02-20 22:42 - In `tests/csv-export.test.mjs`, update the "escapes fields containing newlines" test (line 164): change `farmDescription: "Line one\nLine two"` to `locationDescription: "Line one\nLine two"`
- [âœ“] 2026-02-20 22:42 - In `tests/csv-export.test.mjs`, update all column count tests (lines 375, 383, 409): change `16` to `17`
- [âœ“] 2026-02-20 22:43 - In `tests/csv-export.test.mjs`, update column index assertions â€” instagram is now index 12 (was 13), facebook is index 13 (was 14). Update the "socialLinks with only instagram" test (line 227): `cols[12]` for instagram, `cols[13]` for facebook, and total columns `17`. Update the "socialLinks with only facebook" test (line 245): `cols[12]` for instagram, `cols[13]` for facebook
- [âœ“] 2026-02-20 22:43 - In `tests/csv-export.test.mjs`, update the "maps province to state column" test (line 425): state is now index 5 (was 6)
- [âœ“] 2026-02-20 22:44 - In `tests/csv-export.test.mjs`, update the "falls back to region" test (line 439): state column index from 6 to 5
- [âœ“] 2026-02-20 22:44 - In `tests/csv-export.test.mjs`, update the "prefers province over region" test (line 453): state column index from 6 to 5
- [âœ“] 2026-02-20 22:44 - In `tests/csv-export.test.mjs`, update the "postalCode and countryCode" test (line 468): postalCode is now index 6 (was 7), countryCode is now index 7 (was 8)
- [âœ“] 2026-02-20 22:45 - In `tests/csv-export.test.mjs`, update the "complete lead 16 columns" test (line 383): change input to use `locationDescription` instead of `farmDescription`, remove `contactPhone`, add `imagePrompt` and `categories`. Change assertion to 17 columns
- [âœ“] 2026-02-20 22:45 - In `tests/csv-export.test.mjs`, update the "minimal lead 16 columns" test (line 409): change assertion to 17 columns
- [âœ“] 2026-02-20 22:45 - `node --test tests/csv-export.test.mjs` â€” all tests pass
- [âœ“] 2026-02-20 22:46 - `node --test tests/` â€” no regressions beyond pre-existing failures
- [âœ“] 2026-02-20 22:47 - In `convex/schema.ts`, update the CSV Export Column Mapping comment (lines 5â€“32): remove `farmDescription` and `contactPhone` rows, add `description â”‚ locationDescription â”‚ bio`, `imagePrompt â”‚ imagePrompt â”‚ imagePrompt`, `categories â”‚ enrichmentData.structuredProducts â”‚ categories`
- [âœ“] 2026-02-20 22:50 - Comment accurately reflects the new export format
- [âœ“] 2026-02-20 22:51 - In `/Users/christopherhayes/Projects/fruitland-market/packages/backend/convex/schema.ts`, add `imagePrompt: v.optional(v.string())` to the `sellerProfiles` table definition, after the `bio` field (line 29)
- [âœ“] 2026-02-20 22:53 - In `/Users/christopherhayes/Projects/fruitland-market/packages/backend/convex/schema.ts`, add `categories: v.optional(v.array(v.string()))` to the `sellerProfiles` table definition, after `imagePrompt`
- [âœ“] 2026-02-20 22:55 - `cd /Users/christopherhayes/Projects/fruitland-market && npx convex dev --typecheck=enable --once` passes (or `pnpm typecheck` if available)
- [âœ“] 2026-02-20 22:57 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add `imagePrompt?: string` and `categories?: string[]` to the `ParsedCsvRow` type
- [âœ“] 2026-02-20 22:58 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add entries to `headerMap`: `description: "bio"`, `imageprompt: "imagePrompt"`, `categories: "categories"`. Note: `description` maps to `bio` because the FM profile uses `bio` for the business description
- [âœ“] 2026-02-20 22:59 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add a parsing branch in `parseRows` for `categories` â€” split on comma, trim, filter empty (same logic as the existing `products` branch)
- [âœ“] 2026-02-20 22:59 - TypeScript compiles without errors
- [âœ“] 2026-02-20 23:01 - In `/Users/christopherhayes/Projects/fruitland-market/packages/backend/convex/adminDirectory.ts`, add `imagePrompt: v.optional(v.string())` and `categories: v.optional(v.array(v.string()))` to `csvRowValidator` (line 14)
- [âœ“] 2026-02-20 23:03 - In the `importCsvRows` mutation, new profile creation block (line 195): add `imagePrompt: row.imagePrompt` and `categories: row.categories` to the `ctx.db.insert("sellerProfiles", ...)` call. Also add `(row.categories ?? []).join(" ")` to the `searchText` builder (after products)
- [âœ“] 2026-02-20 23:05 - In the `importCsvRows` mutation, enrich block (line 239): add diff checks â€” if `row.imagePrompt && row.imagePrompt !== existing.imagePrompt` then `patch.imagePrompt = row.imagePrompt`. If `row.categories && JSON.stringify(row.categories) !== JSON.stringify(existing.categories)` then `patch.categories = row.categories`. Include categories in `searchText` rebuild
- [âœ“] 2026-02-20 23:07 - In the `previewCsvImport` query, enrich diff checks (line 80): add `if (row.imagePrompt && row.imagePrompt !== existing.imagePrompt) enrichFields.push("imagePrompt")` and `if (row.categories?.length) enrichFields.push("categories")`
- [âœ“] 2026-02-20 23:07 - TypeScript compiles without errors in the fruitland-market backend package
- [âœ“] 2026-02-20 23:08 - `node --test tests/` in fm-outreach â€” no regressions
- [âœ“] 2026-02-24 14:27 - In `convex/schema.ts`, add a new optional field to the `leads` table definition, after `countryCode` (line 51): `hours: v.optional(v.array(v.object({ day: v.number(), open: v.string(), close: v.string(), isClosed: v.boolean() })))`
- [âœ“] 2026-02-24 14:31 - In `convex/schema.ts`, update the CSV Export Column Mapping comment (lines 5â€“33): add a new row `hours â”‚ hours (JSON) â”‚ hours` between `categories` and the type mapping note
- [âœ“] 2026-02-24 14:31 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 14:35 - `node --test tests/` â€” no regressions beyond pre-existing failures
- [âœ“] 2026-02-24 14:36 - In `convex/enrichment/googlePlaces.ts`, export a `StructuredHour` type: `{ day: number; open: string; close: string; isClosed: boolean }`
- [âœ“] 2026-02-24 14:38 - In `convex/enrichment/googlePlaces.ts`, export a `parseWeekdayText(weekdayText: string[]): StructuredHour[]` function that: (a) maps day names to numbers â€” Sunday=0, Monday=1, Tuesday=2, Wednesday=3, Thursday=4, Friday=5, Saturday=6, (b) for each string like `"Monday: 9:00 AM â€“ 5:00 PM"`, splits on `: ` to get day name and time range, (c) if the time part is `"Closed"` (case-insensitive), returns `{ day, open: "", close: "", isClosed: true }`, (d) otherwise splits the time range on ` â€“ ` (en-dash with spaces) or ` - ` (hyphen with spaces) to get open/close times, (e) converts 12h times to 24h format (`"9:00 AM"` â†’ `"09:00"`, `"5:00 PM"` â†’ `"17:00"`, `"12:00 PM"` â†’ `"12:00"`, `"12:00 AM"` â†’ `"00:00"`), (f) returns `{ day, open, close, isClosed: false }`, (g) silently skips any line that can't be parsed (no throw)
- [âœ“] 2026-02-24 14:40 - Place the function and type BEFORE the `textSearch` function (around line 27), after the `nameSimilarity` helpers
- [âœ“] 2026-02-24 14:40 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 14:40 - `node --test tests/` â€” no regressions
- [âœ“] 2026-02-24 14:42 - In `convex/enrichment/orchestrator.ts`, add `import { parseWeekdayText } from "./googlePlaces"` alongside the existing `import type { GooglePlacesResult } from "./googlePlaces"` (line 5)
- [âœ“] 2026-02-24 14:44 - In `convex/enrichment/orchestrator.ts`, in the Google Places merge block (after the `countryCode` patch around line 329), add hours merging:
- [âœ“] 2026-02-24 14:44 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 14:44 - `node --test tests/` â€” no regressions
- [âœ“] 2026-02-24 14:46 - In `convex/leads.ts`, in the `listForExport` query's `.map()` projection (around line 140), add `hours: lead.hours` to the returned object
- [âœ“] 2026-02-24 14:46 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 14:46 - In `src/lib/csv-export.ts`, add `hours?: { day: number; open: string; close: string; isClosed: boolean }[]` to the `ExportLead` type
- [âœ“] 2026-02-24 14:47 - In `src/lib/csv-export.ts`, add `"hours"` to the end of `CSV_COLUMNS` (after `"categories"`)
- [âœ“] 2026-02-24 14:47 - In `src/lib/csv-export.ts`, add `lead.hours ? JSON.stringify(lead.hours) : ""` as the last entry in the `values` array inside `leadsToCSV`
- [âœ“] 2026-02-24 14:47 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 14:48 - In `tests/csv-export.test.mjs`, update the "produces correct header row" test: append `,hours` to the expected header string
- [âœ“] 2026-02-24 14:48 - In `tests/csv-export.test.mjs`, update the "outputs correct values for a complete lead" test: add `hours: [{ day: 1, open: "09:00", close: "17:00", isClosed: false }]` to the input lead, append the JSON-serialized hours to the expected CSV row (it will be quoted since it contains commas)
- [âœ“] 2026-02-24 14:50 - In `tests/csv-export.test.mjs`, update the "uses empty strings for undefined" test: change expected trailing commas â€” add one more trailing comma for the new empty `hours` column (18 columns total)
- [âœ“] 2026-02-24 14:51 - In `tests/csv-export.test.mjs`, update the "uses empty strings for explicit null fields" test: add `hours: null` to the input, update expected trailing commas for 18 columns
- [âœ“] 2026-02-24 14:51 - In `tests/csv-export.test.mjs`, update the "never outputs literal 'undefined' or 'null'" test: add `hours: null` to the null-fields input object
- [âœ“] 2026-02-24 14:52 - In `tests/csv-export.test.mjs`, update all "exactly N columns" assertions: change `17` to `18` in the header column count test, the complete lead test, and the minimal lead test
- [âœ“] 2026-02-24 14:52 - In `tests/csv-export.test.mjs`, update the "schema.ts CSV column mapping comment" test: add `hours` to the expected columns if this test checks column names against `CSV_COLUMNS`
- [âœ“] 2026-02-24 14:53 - `node --test tests/csv-export.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 14:53 - In `tests/leads-list-for-export-query.test.mjs`, in the "listForExport maps output to CSV fields only" test, add `"hours"` to the list of projected fields that are checked (the `csvFields` array, around line 65). Add the assertion: `assert.match(block, /hours:\s*lead\.hours/)` to verify hours is in the projection
- [âœ“] 2026-02-24 14:53 - `node --test tests/leads-list-for-export-query.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 14:54 - Create `tests/parse-weekday-text.test.mjs` that reads `convex/enrichment/googlePlaces.ts` source and verifies: (a) `parseWeekdayText` function is exported, (b) `StructuredHour` type is exported
- [âœ“] 2026-02-24 14:56 - Add behavioral tests by transpiling and importing the module (same pattern as `tests/csv-export.test.mjs` â€” use `ts.transpileModule` to convert TS to CJS, write to temp file, `require()` it): test standard hours `"Monday: 9:00 AM â€“ 5:00 PM"` produces `{ day: 1, open: "09:00", close: "17:00", isClosed: false }`, test `"Sunday: Closed"` produces `{ day: 0, open: "", close: "", isClosed: true }`, test PM conversion `"Saturday: 10:00 AM â€“ 8:00 PM"` produces `close: "20:00"`, test noon edge case `"Monday: 12:00 PM â€“ 5:00 PM"` produces `open: "12:00"`, test midnight edge case `"Monday: 12:00 AM â€“ 5:00 AM"` produces `open: "00:00"`, test empty array returns empty array, test malformed string is silently skipped (returns empty array for `["garbage"]`)
- [âœ“] 2026-02-24 14:57 - `node --test tests/parse-weekday-text.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 14:57 - In `tests/google-places-fills-fields.test.mjs`, add a test: "orchestrator imports parseWeekdayText from googlePlaces" â€” assert orchestrator source matches `/import\s*\{[^}]*parseWeekdayText[^}]*\}\s*from\s*["']\.\/googlePlaces["']/`
- [âœ“] 2026-02-24 14:58 - In `tests/google-places-fills-fields.test.mjs`, add a test: "orchestrator patches hours from Google Places result" â€” assert orchestrator source matches `patch.hours` and `fieldsUpdated.push("hours")`
- [âœ“] 2026-02-24 14:59 - In `tests/google-places-fills-fields.test.mjs`, add a test: "orchestrator only fills hours when empty or forced" â€” assert orchestrator source matches `/!lead\.hours\s*\|\|.*overwrite.*placesResult\.hours/s`
- [âœ“] 2026-02-24 14:59 - `node --test tests/google-places-fills-fields.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 15:01 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add `hours?: { day: number; open: string; close: string; isClosed: boolean }[]` to the `ParsedCsvRow` type
- [âœ“] 2026-02-24 15:03 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add `hours: "hours"` to the `headerMap` object
- [âœ“] 2026-02-24 15:04 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, in the `parseRows` function, add a parsing branch for the `hours` field: `else if (field === "hours") { try { const parsed = JSON.parse(value); if (Array.isArray(parsed)) row[field] = parsed; } catch { /* skip malformed */ } }`
- [âœ“] 2026-02-24 15:05 - TypeScript compiles without errors in fruitland-market
- [âœ“] 2026-02-24 15:06 - In `/Users/christopherhayes/Projects/fruitland-market/packages/backend/convex/adminDirectory.ts`, add `hours: v.optional(v.array(v.object({ day: v.number(), open: v.string(), close: v.string(), isClosed: v.boolean() })))` to the `csvRowValidator` (after `categories`, around line 59)
- [âœ“] 2026-02-24 15:08 - In the `importCsvRows` mutation, new profile creation block (around line 235): add `hours: row.hours` to the `ctx.db.insert("profiles", ...)` call
- [âœ“] 2026-02-24 15:10 - In the `importCsvRows` mutation, enrich block (around line 284): add a diff check â€” `if (row.hours && row.hours.length > 0 && JSON.stringify(row.hours) !== JSON.stringify(existing.hours)) { patch.hours = row.hours; }`
- [âœ“] 2026-02-24 15:13 - In the `previewCsvImport` query, enrich diff section: add `if (row.hours?.length && JSON.stringify(row.hours) !== JSON.stringify(existing.hours)) enrichFields.push("hours")`
- [âœ“] 2026-02-24 15:14 - TypeScript compiles without errors in fruitland-market
- [âœ“] 2026-02-24 15:14 - `node --test tests/` in fm-outreach â€” all tests pass (final check)
- [âœ“] 2026-02-24 17:22 - In `convex/schema.ts`, add two optional fields to the `leads` table after `hours` (line 62): `isSeasonal: v.optional(v.boolean())` and `seasonalNote: v.optional(v.string())`
- [âœ“] 2026-02-24 17:25 - In `convex/schema.ts`, update the CSV Export Column Mapping comment (lines 5â€“31): add two new rows between `hours` and the type mapping note: `isSeasonal â”‚ isSeasonal â”‚ isSeasonal` and `seasonalNote â”‚ seasonalNote â”‚ seasonalNote`
- [âœ“] 2026-02-24 17:25 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:25 - `node --test tests/` â€” no regressions beyond pre-existing failures
- [âœ“] 2026-02-24 17:27 - In `convex/enrichment/sonarEnrich.ts`, add two fields to the `SonarEnrichResult` type (after `imagePrompt`, line 28): `isSeasonal: boolean | null;` and `seasonalNote: string | null;`
- [âœ“] 2026-02-24 17:28 - In `convex/enrichment/sonarEnrich.ts`, add a new section 9 to `SONAR_ENRICHMENT_PROMPT` (after section 8, before the "Only include information" line at ~line 77): `9. **Seasonality:**\n   - "isSeasonal": boolean â€” true if the business operates only part of the year (e.g., seasonal farm stand, summer-only farmers market), false if open year-round\n   - "seasonalNote": a short note describing their operating season if seasonal (e.g., "Open May through October", "Saturdays, June to September"). Return null if year-round or unknown.`
- [âœ“] 2026-02-24 17:28 - In `convex/enrichment/sonarEnrich.ts`, in the `parseSonarResponse` function (after `imagePrompt` parsing, ~line 182), add: `isSeasonal: typeof parsed.isSeasonal === "boolean" ? parsed.isSeasonal : null,` and `seasonalNote: typeof parsed.seasonalNote === "string" ? parsed.seasonalNote : null,`
- [âœ“] 2026-02-24 17:29 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:29 - `node --test tests/sonar-enrich-action.test.mjs` â€” no regressions
- [âœ“] 2026-02-24 17:30 - In `convex/enrichment/orchestrator.ts`, after the image prompt merge block (~line 472, after `fieldsUpdated.push("imagePrompt")`), add seasonality merging: `if (sonarResult?.isSeasonal != null && (lead.isSeasonal === undefined || overwrite)) { patch.isSeasonal = sonarResult.isSeasonal; fieldsUpdated.push("isSeasonal"); }` and `if (sonarResult?.seasonalNote && (!lead.seasonalNote || overwrite)) { patch.seasonalNote = sonarResult.seasonalNote; fieldsUpdated.push("seasonalNote"); }`
- [âœ“] 2026-02-24 17:30 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:31 - `node --test tests/` â€” no regressions
- [âœ“] 2026-02-24 17:32 - In `convex/leads.ts`, in the `listForExport` query's `.map()` projection (after `hours: lead.hours` at ~line 141), add: `isSeasonal: lead.isSeasonal,` and `seasonalNote: lead.seasonalNote,`
- [âœ“] 2026-02-24 17:32 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:33 - In `src/lib/csv-export.ts`, add `isSeasonal?: boolean;` and `seasonalNote?: string;` to the `ExportLead` type (after `hours`)
- [âœ“] 2026-02-24 17:33 - In `src/lib/csv-export.ts`, add `"isSeasonal"` and `"seasonalNote"` to the end of `CSV_COLUMNS` (after `"hours"`) â€” total becomes 20 columns
- [âœ“] 2026-02-24 17:34 - In `src/lib/csv-export.ts`, add two entries to the `values` array in `leadsToCSV` (after the hours line): `lead.isSeasonal != null ? String(lead.isSeasonal) : "",` and `lead.seasonalNote ?? "",`
- [âœ“] 2026-02-24 17:34 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:34 - In `tests/csv-export.test.mjs`, update the "produces correct header row" test (line 40): append `,isSeasonal,seasonalNote` to the expected header string
- [âœ“] 2026-02-24 17:35 - In `tests/csv-export.test.mjs`, update the "outputs correct values for a complete lead" test: add `isSeasonal: true` and `seasonalNote: "Open May-Oct"` to the input lead, and append `,true,Open May-Oct` to the expected CSV row
- [âœ“] 2026-02-24 17:35 - In `tests/csv-export.test.mjs`, update the "uses empty strings for undefined" test (line 87): add two more trailing commas for the new empty columns (20 columns total)
- [âœ“] 2026-02-24 17:36 - In `tests/csv-export.test.mjs`, update the "uses empty strings for explicit null fields" test (line 115): add `isSeasonal: null` and `seasonalNote: null` to the input, update expected trailing commas for 20 columns
- [âœ“] 2026-02-24 17:37 - In `tests/csv-export.test.mjs`, update the "never outputs literal 'undefined' or 'null'" test: add `isSeasonal: null` and `seasonalNote: null` to the null-fields input object
- [âœ“] 2026-02-24 17:37 - In `tests/csv-export.test.mjs`, update all "exactly N columns" assertions (lines 433, 460, 468): change `18` to `20`
- [âœ“] 2026-02-24 17:37 - In `tests/csv-export.test.mjs`, update the "schema.ts CSV column mapping comment lists all CSV_COLUMNS" test: no code change needed (it dynamically reads CSV_COLUMNS), but verify it still passes after schema comment update
- [âœ“] 2026-02-24 17:38 - In `tests/csv-export.test.mjs`, update the "schema.ts CSV column mapping comment documents correct field mappings" test: add `["isSeasonal", "isSeasonal"]` and `["seasonalNote", "seasonalNote"]` to `requiredMappings`
- [âœ“] 2026-02-24 17:38 - Add test: "leadsToCSV outputs isSeasonal as string boolean" â€” verify `isSeasonal: true` produces `"true"` and `isSeasonal: false` produces `"false"` in the correct column (index 18)
- [âœ“] 2026-02-24 17:39 - Add test: "leadsToCSV outputs empty string when isSeasonal is undefined" â€” verify column 18 is empty
- [âœ“] 2026-02-24 17:39 - Add test: "leadsToCSV outputs seasonalNote in correct column" â€” verify column 19 has the note value
- [âœ“] 2026-02-24 17:39 - `node --test tests/csv-export.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 17:40 - In `tests/sonar-enrich-action.test.mjs`, add test: "prompt requests isSeasonal and seasonalNote fields" â€” assert source matches `/isSeasonal/` and `/seasonalNote/`
- [âœ“] 2026-02-24 17:41 - In `tests/sonar-enrich-action.test.mjs`, add test: "parseSonarResponse handles isSeasonal with defensive type checking" â€” assert source matches `/typeof\s+parsed\.isSeasonal\s*===\s*"boolean"/` and `/typeof\s+parsed\.seasonalNote\s*===\s*"string"/`
- [âœ“] 2026-02-24 17:41 - In `tests/sonar-enrich-action.test.mjs`, add test: "SonarEnrichResult type includes seasonality fields" â€” assert source matches `/isSeasonal:\s*boolean\s*\|\s*null/` and `/seasonalNote:\s*string\s*\|\s*null/`
- [âœ“] 2026-02-24 17:41 - `node --test tests/sonar-enrich-action.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 17:42 - In `tests/leads-list-for-export-query.test.mjs`, add assertions for the new fields: `assert.match(block, /isSeasonal:\s*lead\.isSeasonal/)` and `assert.match(block, /seasonalNote:\s*lead\.seasonalNote/)`
- [âœ“] 2026-02-24 17:42 - `node --test tests/leads-list-for-export-query.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 17:44 - In `src/app/leads/[id]/page.tsx`, after the `HoursDisplay` block (~line 542-546), add a seasonality display: if `lead.isSeasonal === true`, show "Seasonal" with the `seasonalNote` value; if `lead.isSeasonal === false`, show "Year-round"; if undefined, show nothing. Follow the same `<p><span className="font-medium">` pattern used for other fields in the Business Details card.
- [âœ“] 2026-02-24 17:44 - `pnpm typecheck` passes
- [âœ“] 2026-02-24 17:49 - Visual check: lead detail page shows seasonality info when present
- [âœ“] 2026-02-24 17:52 - In `/Users/christopherhayes/Projects/fruitland-market/apps/web/lib/csv-row-parser.ts`, add `isSeasonal?: boolean;` and `seasonalNote?: string;` to the `ParsedCsvRow` type (after `hours`)
- [âœ“] 2026-02-24 17:53 - In the `headerMap` object, add: `isseasonal: "isSeasonal",` and `seasonalnote: "seasonalNote",`
- [âœ“] 2026-02-24 17:55 - In the `parseRows` function, add a parsing branch for `isSeasonal`: `else if (field === "isSeasonal") { const lower = value.trim().toLowerCase(); if (lower === "true") row[field] = true; else if (lower === "false") row[field] = false; }` â€” and let `seasonalNote` fall through to the default string assignment
- [âœ“] 2026-02-24 17:56 - TypeScript compiles without errors in fruitland-market
- [âœ“] 2026-02-24 17:57 - In `/Users/christopherhayes/Projects/fruitland-market/packages/backend/convex/adminDirectory.ts`, add `isSeasonal: v.optional(v.boolean()),` and `seasonalNote: v.optional(v.string()),` to the `csvRowValidator` (after `hours`, ~line 69)
- [âœ“] 2026-02-24 17:58 - In the `previewCsvImport` query, enrich diff section (after hours check, ~line 141), add: `if (row.isSeasonal != null && row.isSeasonal !== existing.isSeasonal) { enrichFields.push("isSeasonal"); }` and `if (row.seasonalNote && row.seasonalNote !== existing.seasonalNote) { enrichFields.push("seasonalNote"); }`
- [âœ“] 2026-02-24 18:00 - In the `importCsvRows` mutation, new profile creation block (~line 258), add to the `ctx.db.insert("profiles", ...)` call: `isSeasonal: row.isSeasonal,` and `seasonalNote: row.seasonalNote,`
- [âœ“] 2026-02-24 18:02 - In the `importCsvRows` mutation, enrich patch block (after hours diff, ~line 331), add: `if (row.isSeasonal != null && row.isSeasonal !== existing.isSeasonal) { patch.isSeasonal = row.isSeasonal; }` and `if (row.seasonalNote && row.seasonalNote !== existing.seasonalNote) { patch.seasonalNote = row.seasonalNote; }`
- [âœ“] 2026-02-24 18:03 - TypeScript compiles without errors in fruitland-market
- [âœ“] 2026-02-24 18:03 - In `tests/fm-import-new-profile-fields.test.mjs`, add test: "importCsvRows new profile insert includes isSeasonal field" â€” assert source matches `/ctx\.db\.insert\("profiles",\s*\{[\s\S]*?isSeasonal:\s*row\.isSeasonal/`
- [âœ“] 2026-02-24 18:03 - In `tests/fm-import-new-profile-fields.test.mjs`, add test: "importCsvRows new profile insert includes seasonalNote field" â€” assert source matches `/ctx\.db\.insert\("profiles",\s*\{[\s\S]*?seasonalNote:\s*row\.seasonalNote/`
- [âœ“] 2026-02-24 18:04 - In `tests/fm-import-new-profile-fields.test.mjs`, add test: "importCsvRows enrich block includes isSeasonal diff check" â€” assert source matches `row.isSeasonal != null && row.isSeasonal !== existing.isSeasonal`
- [âœ“] 2026-02-24 18:04 - In `tests/fm-import-new-profile-fields.test.mjs`, add test: "importCsvRows enrich block includes seasonalNote diff check" â€” assert source matches `row.seasonalNote && row.seasonalNote !== existing.seasonalNote`
- [âœ“] 2026-02-24 18:04 - In `tests/fm-preview-csv-enrichFields.test.mjs`, add test: "previewCsvImport has isSeasonal diff check" â€” assert previewBlock matches the isSeasonal null check and enrichFields push
- [âœ“] 2026-02-24 18:05 - In `tests/fm-preview-csv-enrichFields.test.mjs`, add test: "previewCsvImport has seasonalNote diff check" â€” assert previewBlock matches the seasonalNote diff check and enrichFields push
- [âœ“] 2026-02-24 18:05 - `node --test tests/fm-import-new-profile-fields.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 18:05 - `node --test tests/fm-preview-csv-enrichFields.test.mjs` â€” all tests pass
- [âœ“] 2026-02-24 18:05 - `node --test tests/` â€” full suite passes (no regressions beyond pre-existing)
